<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hotbot - Plataforma de Gest√£o Avan√ßada</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">

  <style>
    :root {
        --bg-dark: #111111;
        --bg-light: #1d1d1d;
        --border-color: #2f2f2f;
        --text-light: #e5e5e5;
        --text-dark: #888888;
        --primary: #00f5a0;
        --primary-dark: #00a86b;
        --danger: #ef4444;
        --warning: #facc15;
        --info: #3b82f6;
        --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    html,body,#root {
        height: 100%;
        font-family: var(--font-sans);
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) var(--bg-dark);
    }
    *::-webkit-scrollbar { width: 8px; }
    *::-webkit-scrollbar-track { background: var(--bg-dark); }
    *::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; border: 2px solid var(--bg-dark); }
    body { background: var(--bg-dark); color: var(--text-light); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .app-container { display: flex; height: 100vh; }
    .sidebar { width: 240px; background: var(--bg-dark); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; }
    .sidebar h1 { font-size: 1.5rem; margin-bottom: 2.5rem; color: var(--text-light); font-weight: 700; text-align: center; letter-spacing: 1px; }
    .sidebar h1 span { color: var(--primary); }
    .nav-menu { display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-item { padding: 0.85rem 1rem; border-radius: 0.375rem; cursor: pointer; font-weight: 500; transition: all 0.2s ease-in-out; border-left: 3px solid transparent; color: var(--text-dark); }
    .nav-item:hover { background: var(--bg-light); color: var(--text-light); }
    .nav-item.active { background: var(--bg-light); color: var(--primary); font-weight: 600; border-left: 3px solid var(--primary); }
    .sidebar .logout-btn { margin-top: auto; }
    .main-content { flex: 1; padding: 2.5rem; overflow-y: auto; }
    .page-header { font-size: 1.75rem; font-weight: bold; margin-bottom: 2rem; }
    .card { background: var(--bg-light); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark); }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; border-radius: 0.375rem; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-light); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 245, 160, 0.2); }
    .btn { padding: 0.75rem 1.5rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: bold; transition: all 0.2s ease-in-out; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn:hover { transform: translateY(-2px); }
    .btn-primary { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(0, 245, 160, 0.3); }
    .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 0 25px rgba(0, 245, 160, 0.5); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--border-color); color: white; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
    
    .chat-layout { display: flex; height: calc(100vh - 12rem); border-radius: 0.5rem; overflow: hidden; }
    .user-list-wrapper { display: flex; flex-direction: column; width: 300px; border-right: 1px solid var(--border-color); background: var(--bg-dark); }
    .user-list-search { padding: 1rem; border-bottom: 1px solid var(--border-color); }
    .user-list { flex: 1; overflow-y: auto; }
    .user-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; transition: background-color 0.2s; border-left: 3px solid transparent; }
    .user-item.active { background: var(--bg-light); border-left-color: var(--primary); }
    .user-item-info { display: flex; flex-direction: column; overflow: hidden; }
    .user-item-name { font-weight: bold; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-item-id { font-size: 0.8rem; color: var(--text-dark); }
    .chat-window { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
    .chat-header { padding: 1rem; background: var(--bg-light); border-bottom: 1px solid var(--border-color); font-weight: bold; text-align: center; }
    .message-list { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
    .message { background: var(--border-color); padding: 0.75rem 1rem; border-radius: 1rem; max-width: 75%; line-height: 1.4; word-wrap: break-word; }
    .message.operator { background: var(--primary); color: #000; }
    .chat-actions-bar { display: flex; padding: 0.5rem 1rem; border-top: 1px solid var(--border-color); gap: 1rem; }
    .action-icon { cursor: pointer; color: var(--text-dark); transition: color 0.2s; }
    .action-icon:hover { color: var(--primary); }
    .message-form { display: flex; padding: 1rem; border-top: 1px solid var(--border-color); }
    .contact-info-panel { width: 320px; background: var(--bg-dark); padding: 1.5rem; overflow-y: auto; }
    .contact-info-panel h3 { margin-bottom: 1.5rem; }
    .contact-detail { margin-bottom: 1rem; }
    .contact-detail label { color: var(--text-dark); font-size: 0.875rem; }
    .contact-detail p { font-size: 1rem; }
    .tags-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .tag { background: var(--border-color); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; }
    .tag.paid { background: var(--primary-dark); color: var(--text-light); }
    .tag.bump { background: var(--info); color: var(--text-light); }
    .add-tag-form { display: flex; margin-top: 1rem; }
    
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); }
    .login-box { background: var(--bg-light); padding: 2.5rem; border-radius: 0.5rem; width: 380px; border: 1px solid var(--border-color); }
    .disparos-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .bot-selection-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .bot-selection-item { display: flex; align-items: center; padding: 0.75rem; background-color: var(--bg-dark); border-radius: 0.375rem; }
    .message-preview { padding: 1rem; background: #fff; border-radius: 0.5rem; color: #333; }
    .flow-editor-container { display: flex; height: 100%; width: 100%; }
    .flow-editor-page { display: flex; flex-direction: column; flex-grow: 1; height: 100%; }
    .flow-header { padding: 0.75rem 1rem; background: var(--bg-light); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
    .reactflow-wrapper { flex-grow: 1; position: relative; background: var(--bg-dark); }
    .flow-sidebar { width: 250px; background: var(--bg-light); border-right: 1px solid var(--border-color); padding: 1rem; }
    .flow-sidebar h3 { margin-bottom: 1rem; }
    .node-button { padding: 0.75rem; border-radius: 0.375rem; border: 1px dashed var(--border-color); text-align: center; cursor: grab; margin-bottom: 0.5rem; transition: all 0.2s; }
    .node-button:hover { border-color: var(--primary); color: var(--primary); background: rgba(0, 245, 160, 0.1); }
    .editor-panel { position: absolute; top: 0; right: 0; width: 300px; height: 100%; background: var(--bg-light); z-index: 10; padding: 1rem; border-left: 1px solid var(--border-color); overflow-y: auto; }
    .react-flow__node { border-radius: 8px; font-size: 14px; border-width: 2px; border-style: solid; color: #111827; padding: 10px; text-align: center; min-width: 180px; }
    .react-flow__node-trigger { background: #dbeafe; border-color: #60a5fa; cursor: default !important; }
    .react-flow__node-message { background: #dcfce7; border-color: #4ade80; }
    .react-flow__node-delay { background: #e5e7eb; border-color: #9ca3af; }
    .react-flow__node-action_pix { background: #fef9c3; border-color: #facc15; }
    .react-flow__node-action_check_pix { background: #fef08a; border-color: #eab308; }
    .react-flow__node-action_city { background: #cffafe; border-color: #22d3ee; }
    .react-flow__node-forward_flow { background: #ede9fe; border-color: #a78bfa; }
    .react-flow__handle { width: 10px; height: 10px; }
    .react-flow__handle-right { right: -16px; }
    .handle-label { position: absolute; top: -20px; font-size: 10px; color: var(--text-dark); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef, memo } = React;
    const { ReactFlowProvider, ReactFlow, useNodesState, useEdgesState, addEdge, Background, Controls, Handle, Position } = window.ReactFlow;
    const API_BASE_URL = 'https://novaapi-one.vercel.app/api';

    const api = axios.create({ baseURL: API_BASE_URL });
    api.interceptors.request.use(config => {
      const token = localStorage.getItem('authToken');
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }
      return config;
    });

    function App() {
      const [isAuthenticated, setIsAuthenticated] = useState(!!localStorage.getItem('authToken'));
      const [currentPage, setCurrentPage] = useState('bots');
      const [editingFlow, setEditingFlow] = useState(null);

      const handleLogin = (token) => {
        localStorage.setItem('authToken', token);
        setIsAuthenticated(true);
      };

      const handleLogout = () => {
        localStorage.removeItem('authToken');
        setIsAuthenticated(false);
      };

      const navigateToFlowEditor = (flow) => {
        setEditingFlow(flow);
        setCurrentPage('flow-editor');
      };

      if (!isAuthenticated) {
        return <LoginScreen onLogin={handleLogin} />;
      }

      return (
        <div className="app-container">
          {currentPage !== 'flow-editor' && <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} onLogout={handleLogout} />}
          <main
            className={currentPage !== 'flow-editor' ? "main-content" : ''}
            style={{padding: currentPage === 'flow-editor' ? 0 : '2.5rem', height: '100vh', width: '100%'}}
          >
            {currentPage === 'bots' && <BotsPage />}
            {currentPage === 'flows' && <FlowsListPage onEditFlow={navigateToFlowEditor} />}
            {currentPage === 'chat' && <LiveChatPage />}
            {currentPage === 'disparos' && <DisparosPage />}
            {currentPage === 'flow-editor' && <FlowEditorPage flow={editingFlow} onBack={() => setCurrentPage('flows')} />}
          </main>
        </div>
      );
    }
    
    function Sidebar({ currentPage, setCurrentPage, onLogout }) {
        const pages = {
            bots: 'ü§ñ Bots',
            flows: 'üåä Fluxos',
            chat: 'üí¨ Chat ao Vivo',
            disparos: 'üöÄ Disparos'
        };
        return (
            <aside className="sidebar">
                <h1>Hot<span>bot</span></h1>
                <nav className="nav-menu">
                    {Object.entries(pages).map(([key, value]) => (
                        <div
                            key={key}
                            className={`nav-item ${currentPage === key ? 'active' : ''}`}
                            onClick={() => setCurrentPage(key)}
                        >
                            {value}
                        </div>
                    ))}
                </nav>
                <button className="btn btn-danger logout-btn" onClick={onLogout}>Sair</button>
            </aside>
        );
    }
    
    // --- P√°ginas ---
    function BotsPage() {
      const [bots, setBots] = useState([]);
      const [newBotName, setNewBotName] = useState('');

      const fetchBots = async () => {
          try {
              const response = await api.get('/dashboard/data');
              setBots(response.data.bots || []);
            } catch (error) {
                console.error("Erro ao buscar bots:", error);
            }
        };

      useEffect(() => {
          fetchBots();
        }, []);

      const handleCreateBot = async (event) => {
          event.preventDefault();
          if (!newBotName) return;
          try {
              await api.post('/bots', { bot_name: newBotName });
              setNewBotName('');
              fetchBots();
            } catch (error) {
                alert('Erro ao criar bot: ' + (error.response?.data?.message || 'Erro desconhecido'));
            }
        };

      const handleDeleteBot = async (botId) => {
          if (confirm('Tem certeza que deseja excluir este bot e todos os seus dados?')) {
              try {
                  await api.delete(`/bots/${botId}`);
                  fetchBots();
                } catch (error) {
                    alert('Erro ao excluir bot.');
                }
            }
        };

      const handleUpdateToken = async (botId) => {
          const token = prompt("Digite o novo token do Telegram:");
          if (token) {
              try {
                  await api.put(`/bots/${botId}`, { bot_token: token });
                  alert("Token atualizado com sucesso!");
                  fetchBots();
                } catch (error) {
                    alert('Erro ao atualizar token: ' + (error.response?.data?.message || 'Erro desconhecido'));
                }
            }
        };

      const handleSetWebhook = async (botId) => {
          try {
              const response = await api.post(`/bots/${botId}/set-webhook`);
              alert(response.data.message);
            } catch (error) {
                console.error("Erro ao configurar webhook:", error);
                alert('Falha ao configurar Webhook.');
            }
        };

      return (
          <>
            <h2 className="page-header">Gerenciar Bots</h2>
            <div className="card" style={{ marginBottom: '1.5rem' }}>
                <h3>Adicionar Novo Bot</h3>
                <form onSubmit={handleCreateBot}>
                    <div className="form-group">
                        <label htmlFor="botName">Nome do Bot</label>
                        <input
                            id="botName"
                            className="form-input"
                            value={newBotName}
                            onChange={(event) => setNewBotName(event.target.value)}
                            placeholder="@meu_bot"
                        />
                    </div>
                    <button className="btn btn-primary" type="submit">Criar Bot</button>
                </form>
            </div>
            <div className="card">
                <h3>Bots Existentes</h3>
                {bots.map(bot => (
                    <div key={bot.id} className="bot-item">
                        <span>{bot.bot_name}</span>
                        <div>
                            <button className="btn btn-secondary btn-sm" style={{marginRight: '0.5rem'}} onClick={() => handleSetWebhook(bot.id)}>Webhook</button>
                            <button className="btn btn-secondary btn-sm" style={{marginRight: '0.5rem'}} onClick={() => handleUpdateToken(bot.id)}>Editar Token</button>
                            <button className="btn btn-danger btn-sm" onClick={() => handleDeleteBot(bot.id)}>Excluir</button>
                        </div>
                    </div>
                ))}
            </div>
          </>
        );
    }
    function FlowsListPage({ onEditFlow }) {
        const [bots, setBots] = useState([]);
        const [selectedBotId, setSelectedBotId] = useState('');
        const [flows, setFlows] = useState([]);

        useEffect(() => {
            const fetchBots = async () => {
                try {
                    const response = await api.get('/dashboard/data');
                    const botsData = response.data.bots || [];
                    setBots(botsData);
                    if(botsData.length > 0) {
                        setSelectedBotId(botsData[0].id);
                    }
                } catch(error){
                    console.error("Erro ao buscar bots:", error);
                }
            };
            fetchBots();
        }, []);

        const fetchFlows = useCallback(async () => {
            if (!selectedBotId) {
                setFlows([]);
                return;
            }
            try {
                const response = await api.get('/flows');
                setFlows(response.data.filter(flow => flow.bot_id == selectedBotId));
            } catch (error) {
                console.error("Erro ao buscar fluxos:", error);
            }
        }, [selectedBotId]);

        useEffect(() => {
            fetchFlows();
        }, [fetchFlows]);

        const handleCreateFlow = async () => {
            const name = prompt("Nome do novo fluxo:");
            if(name && selectedBotId) {
                try {
                    await api.post('/flows', { name, botId: selectedBotId });
                    fetchFlows();
                } catch (error) {
                    alert("Erro ao criar fluxo.");
                }
            }
        };

        const handleDeleteFlow = async (flowId) => {
            if (confirm("Tem certeza que deseja excluir este fluxo?")) {
                try {
                    await api.delete(`/flows/${flowId}`);
                    fetchFlows();
                } catch (error) {
                    alert("Erro ao excluir fluxo.");
                    fetchFlows();
                }
            }
        };
        
        return (
            <>
                <h2 className="page-header">Fluxos de Conversa</h2>
                <div className="form-group" style={{maxWidth: '400px'}}>
                    <label htmlFor="botSelect">Selecione um Bot</label>
                    <select id="botSelect" className="form-select" value={selectedBotId} onChange={event => setSelectedBotId(event.target.value)}>
                        <option value="">-- Selecione --</option>
                        {bots.map(bot => <option key={bot.id} value={bot.id}>{bot.bot_name}</option>)}
                    </select>
                </div>
                <button className="btn btn-primary" style={{marginBottom: '1.5rem'}} onClick={handleCreateFlow} disabled={!selectedBotId}>+ Novo Fluxo</button>
                <div className="grid">
                    {flows.map(flow => (
                        <div key={flow.id} className="card flow-card">
                            <h3>{flow.name}</h3>
                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                <button className="btn btn-primary btn-sm" onClick={() => onEditFlow(flow)}>Abrir Editor</button>
                                <button className="btn btn-danger btn-sm" onClick={() => handleDeleteFlow(flow.id)}>Excluir</button>
                            </div>
                        </div>
                    ))}
                </div>
            </>
        );
    }
    function DisparosPage() {
        const [bots, setBots] = useState([]);
        const [selectedBotIds, setSelectedBotIds] = useState([]);
        const [message, setMessage] = useState('');
        const [schedule, setSchedule] = useState('');

        useEffect(() => {
            const fetchBots = async () => {
                try {
                    const { data } = await api.get('/dashboard/data');
                    setBots(data.bots || []);
                } catch(error) {
                    console.error("Erro ao buscar bots:", error);
                }
            };
            fetchBots();
        }, []);

        const handleSend = async () => {
            if (selectedBotIds.length === 0 || !message) {
                alert("Selecione pelo menos um bot e digite uma mensagem.");
                return;
            }
            if (!confirm(`Confirmar o envio da mensagem para ${selectedBotIds.length} bot(s)?`)) {
                return;
            }
            try {
                await api.post('/bots/mass-send', {
                    botIds: selectedBotIds,
                    initialText: message,
                    ctaButtonText: "Saber mais",
                    externalLink: "https://google.com"
                });
                alert("Disparo agendado com sucesso!");
                setMessage('');
                setSelectedBotIds([]);
            } catch (error) {
                alert("Ocorreu um erro ao enviar o disparo.");
            }
        };

        const handleBotSelection = (botId) => {
            setSelectedBotIds(previousSelectedIds =>
                previousSelectedIds.includes(botId)
                ? previousSelectedIds.filter(id => id !== botId)
                : [...previousSelectedIds, botId]
            );
        };

        return (
            <>
                <h2 className="page-header">Disparos em Massa</h2>
                <div className="disparos-layout">
                    <div className="card">
                        <h3>Configura√ß√£o do Disparo</h3>
                        <div className="form-group">
                            <label>Selecione os Bots de Destino</label>
                            <div className="bot-selection-list">
                                {bots.map(bot => (
                                    <label key={bot.id} className="bot-selection-item">
                                        <input
                                            type="checkbox"
                                            checked={selectedBotIds.includes(bot.id)}
                                            onChange={() => handleBotSelection(bot.id)}
                                            style={{marginRight: '0.75rem'}}
                                        />
                                        {bot.bot_name}
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="form-group">
                            <label htmlFor="message">Mensagem</label>
                            <textarea
                                id="message"
                                className="form-textarea"
                                rows="8"
                                value={message}
                                onChange={event => setMessage(event.target.value)}
                            ></textarea>
                        </div>
                        <div className="form-group">
                            <label htmlFor="schedule">Agendar para (Opcional)</label>
                            <input
                                type="datetime-local"
                                id="schedule"
                                className="form-input"
                                value={schedule}
                                onChange={event => setSchedule(event.target.value)}
                            />
                        </div>
                        <div style={{display: 'flex', gap: '1rem'}}>
                            <button
                                className="btn btn-primary"
                                onClick={handleSend}
                                disabled={!message || selectedBotIds.length === 0}
                            >
                                Enviar Agora
                            </button>
                            <button
                                className="btn btn-secondary"
                                onClick={() => alert('Funcionalidade de agendamento em desenvolvimento!')}
                                disabled={!schedule}
                            >
                                Agendar
                            </button>
                        </div>
                    </div>
                    <div className="card">
                        <h3>Preview da Mensagem</h3>
                        <div className="message-preview">
                            <p style={{whiteSpace: 'pre-wrap', marginBottom: '1rem'}}>
                                {message || 'Sua mensagem aparecer√° aqui.'}
                            </p>
                            <button className="btn btn-sm" style={{background: '#ddd', color: '#333'}}>
                                Saber mais
                            </button>
                        </div>
                    </div>
                </div>
            </>
        );
    }
    function LiveChatPage() {
        const [bots, setBots] = useState([]);
        const [selectedBotId, setSelectedBotId] = useState('');
        const [users, setUsers] = useState([]);
        const [filteredUsers, setFilteredUsers] = useState([]);
        const [selectedChat, setSelectedChat] = useState(null);
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [searchTerm, setSearchTerm] = useState('');
        const messagesEndRef = useRef(null);

        useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);
        
        useEffect(() => {
            const fetchBots = async () => {
                const { data } = await api.get('/dashboard/data');
                setBots(data.bots || []);
                if (data.bots.length > 0) {
                    setSelectedBotId(data.bots[0].id);
                }
            };
            fetchBots();
        }, []);

        const fetchUsers = useCallback(async () => {
            if (!selectedBotId) return;
            setUsers([]);
            setFilteredUsers([]);
            setMessages([]);
            setSelectedChat(null);
            try {
                const { data } = await api.get(`/chats/${selectedBotId}`);
                setUsers(data);
                setFilteredUsers(data);
            } catch (error) {
                console.error("Erro ao buscar usu√°rios", error);
            }
        }, [selectedBotId]);
        
        useEffect(() => {
            fetchUsers();
        }, [fetchUsers]);

        const fetchMessages = useCallback(async () => {
            if (!selectedBotId || !selectedChat?.chat_id) return;
            try {
                const { data } = await api.get(`/chats/${selectedBotId}/${selectedChat.chat_id}`);
                setMessages(data);
            } catch (error) {
                console.error("Erro ao buscar mensagens", error);
                setMessages([]);
            }
        }, [selectedBotId, selectedChat]);

        useEffect(() => {
            if (selectedChat) {
                fetchMessages();
            }
        }, [fetchMessages, selectedChat]);

        useEffect(() => {
            const results = users.filter(user =>
                ((user.first_name || '') + ' ' + (user.last_name || '')).toLowerCase().includes(searchTerm.toLowerCase()) ||
                (user.chat_id || '').toString().includes(searchTerm)
            );
            setFilteredUsers(results);
        }, [searchTerm, users]);
        
        const handleSendMessage = async (event) => {
            event.preventDefault();
            const textToSend = newMessage.trim();
            if (!textToSend || !selectedChat) return;

            const optimisticMessage = {
                message_id: Date.now(),
                first_name: "Voc√™",
                sender_type: 'operator',
                message_text: textToSend,
                created_at: new Date().toISOString()
            };
            setMessages(previousMessages => [...previousMessages, optimisticMessage]);
            setNewMessage('');

            try {
                await api.post(`/chats/${selectedBotId}/send-message`, { chatId: selectedChat.chat_id, text: textToSend });
                fetchMessages();
            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
                alert('Ocorreu um erro ao enviar a mensagem.');
                setMessages(previousMessages => previousMessages.filter(message => message.message_id !== optimisticMessage.message_id));
            }
        };

        const handleDeleteConversation = async (chatId) => {
            if (confirm(`Tem certeza que deseja excluir toda a conversa e dados deste contato?`)) {
                try {
                    await api.delete(`/chats/${selectedBotId}/${chatId}`);
                    alert('Contato e conversa exclu√≠dos com sucesso!');
                    fetchUsers();
                    if (selectedChat?.chat_id === chatId) {
                        setSelectedChat(null);
                    }
                } catch (error) {
                    alert('Erro ao excluir o contato.');
                }
            }
        };

        const ContactInfoPanel = ({ chat, onAddTag, onStartFlow, onStopFlow }) => {
            const [newTag, setNewTag] = useState('');

            const handleAddTag = (event) => {
                event.preventDefault();
                const trimmedTag = newTag.trim();
                if (trimmedTag) {
                    onAddTag(trimmedTag);
                    setNewTag('');
                }
            };

            if (!chat) {
                return (
                    <div className="contact-info-panel" style={{display: 'flex', alignItems:'center', justifyContent:'center', color:'var(--text-dark)'}}>
                        Selecione um contato para ver os detalhes
                    </div>
                );
            }

            const tags = chat.tags || ['PAGOU', 'ORDERBUMP_1', 'ORDERBUMP_2'];

            return (
                <div className="contact-info-panel">
                    <h3>Dados do Contato</h3>
                    <div className="contact-detail">
                        <label>Nome</label>
                        <p>{`${chat.first_name || ''} ${chat.last_name || ''}`.trim()}</p>
                    </div>
                    <div className="contact-detail">
                        <label>ID do Chat</label>
                        <p>{chat.chat_id}</p>
                    </div>
                    <div className="contact-detail">
                        <label>Email</label>
                        <p>{chat.email || 'N√£o informado'}</p>
                    </div>
                    <div className="contact-detail">
                        <label>Tags</label>
                        <div className="tags-list">
                            {tags.map(tag => <span key={tag} className={`tag ${tag.startsWith('PAGOU') ? 'paid' : ''} ${tag.startsWith('ORDERBUMP') ? 'bump' : ''}`}>{tag}</span>)}
                        </div>
                        <form onSubmit={handleAddTag} className="add-tag-form">
                            <input
                                type="text"
                                className="form-input btn-sm"
                                placeholder="Adicionar tag..."
                                value={newTag}
                                onChange={event => setNewTag(event.target.value)}
                            />
                            <button type="submit" className="btn btn-secondary btn-sm" style={{marginLeft:'0.5rem'}}>+</button>
                        </form>
                    </div>
                    <div className="contact-detail" style={{marginTop:'2rem'}}>
                        <label>A√ß√µes do Fluxo</label>
                        <div style={{display:'flex', flexDirection:'column', gap:'0.5rem', marginTop:'0.5rem'}}>
                           <button className="btn btn-primary btn-sm" onClick={onStartFlow}>Iniciar Fluxo</button>
                           <button className="btn btn-danger btn-sm" onClick={onStopFlow}>Parar Fluxo Ativo</button>
                        </div>
                    </div>
                </div>
            );
        };

        return (
            <>
                <h2 className="page-header">Chat ao Vivo</h2>
                <div className="form-group" style={{maxWidth: '400px'}}>
                    <label htmlFor="botSelectChat">Selecione um Bot</label>
                    <select id="botSelectChat" className="form-select" value={selectedBotId} onChange={event => setSelectedBotId(event.target.value)}>
                        <option value="">-- Selecione --</option>
                        {bots.map(bot => <option key={bot.id} value={bot.id}>{bot.bot_name}</option>)}
                    </select>
                </div>
                <div className="card chat-layout">
                    <div className="user-list-wrapper">
                        <div className="user-list-search">
                            <input
                                type="text"
                                className="form-input"
                                placeholder="Buscar por nome ou ID..."
                                value={searchTerm}
                                onChange={event => setSearchTerm(event.target.value)}
                            />
                        </div>
                        <div className="user-list">
                            {filteredUsers.map(user => (
                                <div
                                    key={user.chat_id}
                                    className={`user-item ${selectedChat?.chat_id === user.chat_id ? 'active' : ''}`}
                                    onClick={() => setSelectedChat(user)}
                                >
                                    <div className="user-item-info">
                                        <span className="user-item-name">{user.click_id || `${user.first_name || ''} ${user.last_name || ''}`.trim()}</span>
                                        <span className="user-item-id">ID: {user.chat_id}</span>
                                    </div>
                                    <button
                                        className="btn btn-danger btn-sm"
                                        onClick={(event) => {
                                            event.stopPropagation();
                                            handleDeleteConversation(user.chat_id);
                                        }}
                                    >X</button>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="chat-window">
                        {selectedChat ? (
                            <>
                                <div className="chat-header">Conversa</div>
                                <div className="message-list">
                                    {messages.map((msg, index) => (
                                        <div
                                            key={msg.message_id || index}
                                            className={`message ${msg.sender_type === 'operator' ? 'operator' : ''}`}
                                            style={{ alignSelf: msg.sender_type === 'operator' ? 'flex-end' : 'flex-start' }}
                                        >
                                            <strong>{msg.sender_type === 'operator' ? 'Voc√™' : msg.first_name}: </strong>
                                            {msg.message_text}
                                            <div style={{fontSize: '0.75rem', opacity: 0.7, marginTop: '0.25rem', textAlign: 'right'}}>
                                                {new Date(msg.created_at).toLocaleString()}
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="chat-actions-bar">
                                    <span className="action-icon" title="Anexar Arquivo" onClick={()=>alert('Anexar arquivo')}>üìé</span>
                                    <span className="action-icon" title="Enviar Imagem" onClick={()=>alert('Enviar imagem')}>üñºÔ∏è</span>
                                    <span className="action-icon" title="Gravar √Åudio" onClick={()=>alert('Gravar √°udio')}>üéôÔ∏è</span>
                                </div>
                                <form onSubmit={handleSendMessage} className="message-form">
                                    <input
                                        className="form-input"
                                        value={newMessage}
                                        onChange={event => setNewMessage(event.target.value)}
                                        placeholder="Digite sua resposta..."
                                    />
                                    <button className="btn btn-primary" type="submit" style={{marginLeft: '0.5rem'}}>
                                        Enviar
                                    </button>
                                </form>
                            </>
                        ) : (
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--text-dark)'}}>
                                Selecione uma conversa
                            </div>
                        )}
                    </div>
                    <ContactInfoPanel
                        chat={selectedChat}
                        onAddTag={(tag) => alert(`L√≥gica para adicionar a tag "${tag}" ao usu√°rio ${selectedChat?.chat_id}`)}
                        onStartFlow={() => alert(`L√≥gica para iniciar um fluxo para o usu√°rio ${selectedChat?.chat_id}`)}
                        onStopFlow={() => alert(`L√≥gica para parar o fluxo ativo do usu√°rio ${selectedChat?.chat_id}`)}
                    />
                </div>
            </>
        );
    }
    
    const initialNodes = [{ id: 'start', type: 'trigger', position: { x: 250, y: 50 }, data: {} }];
    
    const nodeTypes = {
        trigger: memo(() => (<> <div><strong>üöÄ Gatilho</strong></div> <p style={{fontSize: 12, color: '#555'}}>Inicia na 1¬™ msg.</p> <Handle type="source" position={Position.Bottom} /> </>)),
        message: memo(({ data }) => (<> <Handle type="target" position={Position.Top} /> <div><strong>üí¨ Mensagem</strong></div> {data.typingDelay && <small style={{color: '#555'}}>Delay: {data.typingDelay}s</small>} <p style={{'whiteSpace': 'pre-wrap', 'borderTop': '1px solid #ccc', 'marginTop': '5px', 'paddingTop': '5px'}}>{data.text || '...'}</p> <Handle type="source" position={Position.Bottom} id="a" /> {data.waitForReply && (<> <div className="handle-label" style={{right: '-25px', top: 'calc(50% - 7px)'}}>S/ Resp.</div> <Handle type="source" position={Position.Right} id="b" /> </>)} </>)),
        delay: memo(({ data }) => (<> <Handle type="target" position={Position.Top} /> <div><strong>‚è±Ô∏è Atraso</strong></div> <p>{data.delayInSeconds || 0}s</p> <Handle type="source" position={Position.Bottom} /> </>)),
        action_pix: memo(({ data }) => (<> <Handle type="target" position={Position.Top} /> <div><strong>üí≥ Gerar PIX</strong></div> <p>R$ {((data.valueInCents || 0) / 100).toFixed(2)}</p> <Handle type="source" position={Position.Bottom} /> </>)),
        action_check_pix: memo(() => (<> <Handle type="target" position={Position.Top} /> <div><strong>üîç Consultar PIX</strong></div><div className="handle-label" style={{left: '15px'}}>Pago</div><Handle type="source" position={Position.Bottom} id="a" style={{left: '25%'}} /><div className="handle-label" style={{right: '15px'}}>Pendente</div><Handle type="source" position={Position.Bottom} id="b" style={{left: '75%'}}/> </>)),
        action_city: memo(() => (<> <Handle type="target" position={Position.Top} /> <div><strong>üìç Consultar Cidade</strong></div> <Handle type="source" position={Position.Bottom} /> </>)),
        forward_flow: memo(({ data }) => (<> <Handle type="target" position={Position.Top} /> <div><strong>‚Ü™Ô∏è Encaminhar p/ Fluxo</strong></div> <p>{data.targetFlowName || 'Nenhum selecionado'}</p> </>)),
    };
    function FlowCanvas({ flow, onBack, availableFlows }) {
      const reactFlowWrapper = useRef(null);
      const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
      const [edges, setEdges, onEdgesChange] = useEdgesState([]);
      const [selectedNode, setSelectedNode] = useState(null);
      const [reactFlowInstance, setReactFlowInstance] = useState(null);
      
      useEffect(() => {
          if(flow?.nodes) {
              const content = typeof flow.nodes === 'string' ? JSON.parse(flow.nodes) : flow.nodes;
              setNodes(content.nodes || initialNodes);
              setEdges(content.edges || []);
            }
        }, [flow]);
        
      const onConnect = useCallback((params) => setEdges((eds) => addEdge({ ...params, type: 'smoothstep', animated: true }, eds)), []);
      const onNodeClick = useCallback((_, node) => { if (node.type !== 'trigger') setSelectedNode(node); }, []);
      const onNodesChangeFiltered = useCallback((changes) => {
          const filteredChanges = changes.filter(change => !(change.type === 'remove' && nodes.find(n => n.id === change.id)?.type === 'trigger'));
          onNodesChange(filteredChanges);
        }, [nodes, onNodesChange]);
      const onDragOver = useCallback((event) => { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; }, []);
      
      const onDrop = useCallback((event) => {
          event.preventDefault();
          const bounds = reactFlowWrapper.current.getBoundingClientRect();
          const type = event.dataTransfer.getData('application/reactflow');
          if (!type) return;
          const position = reactFlowInstance.project({ x: event.clientX - bounds.left, y: event.clientY - bounds.top });
          setNodes((nds) => nds.concat({ id: `${type}-${Date.now()}`, type, position, data: { showTyping: true } }));
        }, [reactFlowInstance]);
        
      const handleSave = async () => {
          try {
              await api.put(`/flows/${flow.id}`, { name: flow.name, nodes: JSON.stringify({ nodes, edges }) });
              alert("Fluxo salvo com sucesso!");
            } catch(error) {
                alert("Erro ao salvar o fluxo.");
            }
        };

      return (
          <div className="flow-editor-page">
            <div className="flow-header">
                <h3>Editando: {flow.name}</h3>
                <div>
                    <button className="btn btn-secondary" style={{marginRight: '0.5rem'}} onClick={onBack}>Voltar</button>
                    <button className="btn btn-primary" onClick={handleSave}>Salvar</button>
                </div>
            </div>
            <div className="reactflow-wrapper" ref={reactFlowWrapper} onDrop={onDrop} onDragOver={onDragOver}>
                <ReactFlow nodes={nodes} edges={edges} onNodesChange={onNodesChangeFiltered} onEdgesChange={onEdgesChange} onConnect={onConnect} onNodeClick={onNodeClick} onInit={setReactFlowInstance} nodeTypes={nodeTypes} fitView>
                    <Background color="#555" gap={24}/>
                    <Controls />
                </ReactFlow>
                {selectedNode && <EditorPanel selectedNode={selectedNode} setNodes={setNodes} setSelectedNode={setSelectedNode} availableFlows={availableFlows} />}
            </div>
          </div>
        );
    }
    function FlowEditorPage({ flow, onBack }) {
        if (!flow) return <div>Carregando...</div>;
        
        const [availableFlows, setAvailableFlows] = useState([]);

        useEffect(() => {
            const fetchFlows = async () => {
                if (flow?.bot_id) {
                    try {
                        const response = await api.get('/flows');
                        setAvailableFlows(response.data.filter(f => f.bot_id == flow.bot_id && f.id != flow.id));
                    } catch (error) {
                        console.error("Erro ao buscar fluxos:", error);
                    }
                }
            };
            fetchFlows();
        }, [flow]);
        
        const onDragStart = (event, nodeType) => {
            event.dataTransfer.setData('application/reactflow', nodeType);
            event.dataTransfer.effectAllowed = 'move';
        };
        
        return (
            <div className="flow-editor-container">
                <div className="flow-sidebar">
                    <h3>Componentes</h3>
                    <div className="node-button" onDragStart={(e) => onDragStart(e, 'message')} draggable>üí¨ Mensagem</div>
                    <div className="node-button" onDragStart={(e) => onDragStart(e, 'delay')} draggable>‚è±Ô∏è Atraso</div>
                    <h3>A√ß√µes</h3>
                    <div className="node-button" onDragStart={(e) => onDragStart(e, 'action_pix')} draggable>üí≥ Gerar PIX</div>
                    <div className="node-button" onDragStart={(e) => onDragStart(e, 'action_check_pix')} draggable>üîç Consultar PIX</div>
                    <div className="node-button" onDragStart={(e) => onDragStart(e, 'action_city')} draggable>üìç Consultar Cidade</div>
                    <div className="node-button" onDragStart={(e) => onDragStart(e, 'forward_flow')} draggable>‚Ü™Ô∏è Encaminhar p/ Fluxo</div>
                </div>
                <ReactFlowProvider>
                    <FlowCanvas flow={flow} onBack={onBack} availableFlows={availableFlows} />
                </ReactFlowProvider>
            </div>
        );
    }
    function EditorPanel({ selectedNode, setNodes, setSelectedNode, availableFlows }) {
        const [nodeData, setNodeData] = useState(selectedNode.data || {});
        
        useEffect(() => {
            setNodeData(selectedNode.data || {})
        }, [selectedNode]);
        
        const handleChange = (event) => {
            const { name, value, type, checked } = event.target;
            const finalValue = type === 'checkbox' ? checked : (type === 'number' ? parseInt(value, 10) || 0 : value);
            setNodeData(previousData => ({...previousData, [name]: finalValue }));
        };
        
        const handleFlowChange = (event) => {
            const flowId = event.target.value;
            const flow = availableFlows.find(f => f.id == flowId);
            setNodeData(previousData => ({ ...previousData, targetFlowId: flowId, targetFlowName: flow ? flow.name : '' }));
        };
        
        const onSave = () => {
            setNodes(nodes => nodes.map(n => n.id === selectedNode.id ? {...n, data: nodeData} : n));
            setSelectedNode(null);
        };
        
        const onDelete = () => {
            setNodes(nodes => nodes.filter(n => n.id !== selectedNode.id));
            setSelectedNode(null);
        };
        
        return (
            <div className="editor-panel">
                <h3 style={{marginBottom: '1rem'}}>Editar: {selectedNode.type}</h3>
                {selectedNode.type === 'message' && (
                    <>
                        <div className="form-group">
                            <label>Texto da Mensagem</label>
                            <textarea name="text" className="form-textarea" rows="5" value={nodeData.text || ''} onChange={handleChange} />
                        </div>
                        <div className="form-group">
                            <label>Delay 'Digitando' (s)</label>
                            <input name="typingDelay" type="number" className="form-input" value={nodeData.typingDelay || 0} onChange={handleChange} />
                        </div>
                        <div className="form-group">
                            <label style={{display: 'flex', alignItems: 'center'}}>
                                <input name="showTyping" type="checkbox" checked={!!nodeData.showTyping} onChange={handleChange} style={{marginRight: '0.5rem'}} />
                                Mostrar "Digitando..."
                            </label>
                        </div>
                        <div className="form-group">
                            <label style={{display: 'flex', alignItems: 'center'}}>
                                <input name="waitForReply" type="checkbox" checked={!!nodeData.waitForReply} onChange={handleChange} style={{marginRight: '0.5rem'}} />
                                Aguardar Resposta
                            </label>
                        </div>
                        {nodeData.waitForReply && (
                            <div className="form-group">
                                <label>Timeout (minutos)</label>
                                <input name="replyTimeout" type="number" className="form-input" value={nodeData.replyTimeout || 5} onChange={handleChange} />
                            </div>
                        )}
                    </>
                )}
                {selectedNode.type === 'delay' && (
                    <div className="form-group">
                        <label>Atraso (segundos)</label>
                        <input name="delayInSeconds" type="number" className="form-input" value={nodeData.delayInSeconds || 1} onChange={handleChange} />
                    </div>
                )}
                {selectedNode.type === 'action_pix' && (
                    <div className="form-group">
                        <label>Valor (em centavos)</label>
                        <input name="valueInCents" type="number" className="form-input" value={nodeData.valueInCents || 0} onChange={handleChange} />
                    </div>
                )}
                {selectedNode.type === 'forward_flow' && (
                    <div className="form-group">
                        <label>Encaminhar para o fluxo</label>
                        <select className="form-select" value={nodeData.targetFlowId || ''} onChange={handleFlowChange}>
                            <option value="">-- Selecione um fluxo --</option>
                            {availableFlows.map(f => (<option key={f.id} value={f.id}>{f.name}</option>))}
                        </select>
                    </div>
                )}
                <button className="btn btn-primary" onClick={onSave}>Salvar</button>
                <button className="btn btn-secondary" style={{marginLeft: '0.5rem'}} onClick={() => setSelectedNode(null)}>Fechar</button>
                <button className="btn btn-danger" style={{marginTop: '1rem', width: '100%'}} onClick={onDelete}>Excluir N√≥</button>
            </div>
        );
    }
    function LoginScreen({ onLogin }) {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        
        const handleSubmit = async (event) => {
            event.preventDefault();
            try {
                const response = await axios.post(`${API_BASE_URL}/sellers/login`, { email, password });
                onLogin(response.data.token);
            } catch (error) {
                alert('Falha no login: ' + (error.response?.data?.message || 'Erro de conex√£o'));
            }
        };
        
        return (
            <div className="login-overlay">
                <div className="login-box">
                    <h2 style={{textAlign: 'center', marginBottom: '1.5rem'}}>Login Hotbot</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <input className="form-input" type="email" value={email} onChange={event => setEmail(event.target.value)} placeholder="Email" required />
                        </div>
                        <div className="form-group">
                            <input className="form-input" type="password" value={password} onChange={event => setPassword(event.target.value)} placeholder="Senha" required />
                        </div>
                        <button className="btn btn-primary" type="submit" style={{width: '100%'}}>Entrar</button>
                    </form>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
