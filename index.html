<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Automação para Telegram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos para o fundo pontilhado do canvas */
        .bg-dots {
            background-size: 40px 40px;
            background-image: radial-gradient(circle, #e5e7eb 1px, rgba(0,0,0,0) 1px);
        }
        /* Animação para o painel de edição */
        .editor-panel {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // Aguarda o DOM estar completamente carregado antes de executar o React
        document.addEventListener('DOMContentLoaded', () => {
            const { useState, useCallback, useRef, useEffect, createContext, useContext } = React;
            const { MessageSquare, Save, Clock, Trash2, Bot, Image, FileAudio, Video, GitBranchPlus, MapPin, DollarSign, BadgeCheck, ExternalLink, ZoomIn, ZoomOut, Settings, BotMessageSquare, MessageCircle, Plus, Edit, ArrowLeft, Send, Copy, LogOut, Search, User, CheckCircle, XCircle } = lucide;

            // --- CONFIGURAÇÃO DA API ---
            const API_BASE_URL = ''; // Usa rotas relativas, ideal para Vercel

            // --- API Helper ---
            const api = {
                async request(method, endpoint, body = null, token) {
                    const options = {
                        method,
                        headers: { 'Authorization': `Bearer ${token}` }
                    };
                    if (body) {
                        options.headers['Content-Type'] = 'application/json';
                        options.body = JSON.stringify(body);
                    }
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    if (!response.ok) {
                        const err = await response.json().catch(() => ({ message: `Erro de Rede: ${response.statusText}` }));
                        throw new Error(err.message);
                    }
                    if (response.status === 204) return null;
                    return response.json();
                },
                get(endpoint, token) { return this.request('GET', endpoint, null, token); },
                post(endpoint, body, token) { return this.request('POST', endpoint, body, token); },
                put(endpoint, body, token) { return this.request('PUT', endpoint, body, token); },
                delete(endpoint, token) { return this.request('DELETE', endpoint, null, token); }
            };

            const createInitialFlow = (id, name, botId) => ({
                id, name, botId,
                nodes: [{ id: 1, type: 'start', content: 'Início do Fluxo', position: { x: 50, y: 150 }, outputs: [{ id: 'out', nextStepId: null }] }]
            });
            
            // --- (A PARTIR DAQUI COMEÇAM OS COMPONENTES DO REACT) ---

            // --- COMPONENTES HELPER ---
            const SidebarButton = ({ icon, label, onClick }) => (
                <button onClick={onClick} className="w-full flex items-center p-3 rounded-lg bg-gray-50 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 transition-all duration-200 mb-2">
                    {React.createElement(icon, { className: "w-5 h-5 mr-3" })}
                    <span>{label}</span>
                </button>
            );

            // ... (Todos os outros componentes como Controls, Connections, ActionEditor, etc. serão adicionados aqui)

            // --- COMPONENTE PRINCIPAL ---
            const App = () => {
                const [token, setToken] = useState(localStorage.getItem('authToken'));
                const [activeTab, setActiveTab] = useState('flows');
                const [bots, setBots] = useState([]);
                const [flows, setFlows] = useState([]);
                const [editingFlowId, setEditingFlowId] = useState(null);
                const [isLoading, setIsLoading] = useState(!!token);

                useEffect(() => {
                    if (token) {
                        setIsLoading(true);
                        const fetchData = async () => {
                            try {
                                const [botsData, flowsData] = await Promise.all([
                                    api.get('/api/bots', token),
                                    api.get('/api/flows', token)
                                ]);
                                setBots(botsData || []);
                                setFlows(flowsData || []);
                            } catch (error) {
                                console.error("Falha ao buscar dados iniciais", error);
                                handleLogout();
                            } finally {
                                setIsLoading(false);
                            }
                        };
                        fetchData();
                    } else {
                        setIsLoading(false);
                    }
                }, [token]);

                const handleLogin = (newToken) => {
                    localStorage.setItem('authToken', newToken);
                    setToken(newToken);
                };

                const handleLogout = () => {
                    localStorage.removeItem('authToken');
                    setToken(null);
                    setBots([]);
                    setFlows([]);
                };

                const handleCreateFlow = async (botId) => {
                    const targetBotId = botId || (bots.length > 0 ? bots[0].id : null);
                    if (!targetBotId) {
                        alert("Por favor, crie um bot primeiro na aba de Configurações.");
                        setActiveTab('settings');
                        return;
                    }
                    try {
                        const newFlow = await api.post('/api/flows', {
                            name: `Novo Fluxo ${flows.length + 1}`,
                            botId: targetBotId
                        }, token);
                        setFlows(prev => [...prev, newFlow]);
                        setEditingFlowId(newFlow.id);
                    } catch (error) {
                        console.error("Falha ao criar fluxo:", error);
                        alert(`Erro ao criar fluxo: ${error.message}`);
                    }
                };

                const handleSaveFlow = async (flowId, updatedFlowData) => {
                    try {
                        await api.put(`/api/flows/${flowId}`, updatedFlowData, token);
                        setFlows(prev => prev.map(f => f.id === flowId ? { ...f, ...updatedFlowData } : f));
                        alert("Fluxo salvo com sucesso!");
                    } catch (error) {
                        console.error("Falha ao salvar fluxo:", error);
                        alert(`Erro ao salvar: ${error.message}`);
                    }
                };

                const handleDeleteFlow = async (flowId) => {
                    if (window.confirm("Tem certeza que deseja excluir este fluxo?")) {
                        try {
                            await api.delete(`/api/flows/${flowId}`, token);
                            setFlows(prev => prev.filter(f => f.id !== flowId));
                        } catch (error) {
                            console.error("Falha ao excluir fluxo:", error);
                            alert(`Erro ao excluir: ${error.message}`);
                        }
                    }
                };
                
                if (!token) { return <LoginView onLogin={handleLogin} />; }
                if (isLoading) { return <div className="flex h-screen items-center justify-center text-lg font-semibold">Carregando Plataforma...</div>; }
                
                const renderContent = () => {
                    switch (activeTab) {
                        case 'settings': return <SettingsView bots={bots} setBots={setBots} token={token} />;
                        case 'flows':
                            const flowToEdit = flows.find(f => f.id === editingFlowId);
                            if (flowToEdit) {
                                const allFlowsForBot = flows.filter(f => f.bot_id === flowToEdit.bot_id);
                                return <FlowBuilder flow={flowToEdit} allFlows={allFlowsForBot} onSave={handleSaveFlow} onBack={() => setEditingFlowId(null)} />;
                            }
                            return <FlowsView flows={flows} bots={bots} onEdit={setEditingFlowId} onCreate={handleCreateFlow} onDelete={handleDeleteFlow} />;
                        case 'livechat': return <LiveChatView bots={bots} />;
                        case 'broadcasts': return <BroadcastsView bots={bots} token={token} />;
                        default: return <p>Selecione uma aba</p>;
                    }
                };

                return (
                    <div className="flex h-screen bg-gray-100 font-sans">
                        <nav className="w-20 bg-gray-800 text-white flex flex-col items-center p-4 space-y-6">
                            <BotMessageSquare size={32} className="text-indigo-400" />
                            <MainNavItem icon={GitBranchPlus} label="Fluxos" isActive={activeTab === 'flows'} onClick={() => { setActiveTab('flows'); setEditingFlowId(null); }} />
                            <MainNavItem icon={MessageCircle} label="Chat" isActive={activeTab === 'livechat'} onClick={() => { setActiveTab('livechat'); setEditingFlowId(null); }} />
                            <MainNavItem icon={Send} label="Disparos" isActive={activeTab === 'broadcasts'} onClick={() => { setActiveTab('broadcasts'); setEditingFlowId(null); }} />
                            <MainNavItem icon={Settings} label="Config" isActive={activeTab === 'settings'} onClick={() => { setActiveTab('settings'); setEditingFlowId(null); }} />
                            <div className="mt-auto">
                                <MainNavItem icon={LogOut} label="Sair" isActive={false} onClick={handleLogout} />
                            </div>
                        </nav>
                        <div className="flex-1 h-full overflow-hidden">
                            {renderContent()}
                        </div>
                    </div>
                );
            }
            
            // --- Todas as outras views e componentes auxiliares serão definidos aqui ---

            ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
        });
    </script>
</body>
</html>
