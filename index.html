<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTrack - Construtor de Fluxo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a00ff;
            --primary-dark: #5300cc;
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --card-color: #2a2a2a;
            --text-color: #e0e0e0;
            --text-secondary: #999;
            --border-color: #333;
            --success-color: #4CAF50;
            --error-color: #F44336;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Layout e Cores */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; }
        .h-screen { height: 100vh; }
        .w-64 { width: 16rem; }
        .w-72 { width: 18rem; }
        .w-96 { width: 24rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-dots {
            background-size: 20px 20px;
            background-image: radial-gradient(circle, #d1d5db 1px, rgba(0, 0, 0, 0) 1px);
        }

        /* Cores de status */
        .bg-green-100 { background-color: #d1fae5; }
        .border-green-300 { border-color: #6ee7b7; }
        .bg-teal-50 { background-color: #f0fdfa; }
        .border-teal-300 { border-color: #99f6e4; }
        .bg-orange-50 { background-color: #fff7ed; }
        .border-orange-300 { border-color: #fed7aa; }
        .bg-emerald-50 { background-color: #ecfdf5; }
        .border-emerald-300 { border-color: #a7f3d0; }
        .bg-indigo-50 { background-color: #eef2ff; }
        .border-indigo-300 { border-color: #a5b4fc; }

        /* Elementos e Componentes */
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .border-r { border-right-width: 1px; }
        .border-l { border-left-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border { border-width: 1px; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-red-400 { border-color: #f87171; }
        .border-red-600 { border-color: #dc2626; }
        .border-indigo-500 { border-color: #6366f1; }
        .border-2 { border-width: 2px; }
        .ring-2 { box-shadow: 0 0 0 2px #6366f1; }
        .ring-4 { box-shadow: 0 0 0 4px #818cf8; }
        .p-4 { padding: 1rem; }
        .p-2 { padding: 0.5rem; }
        .p-1 { padding: 0.25rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .rounded-md { border-radius: 0.375rem; }
        .space-y-1 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mr-2 { margin-right: 0.5rem; }
        .absolute { position: absolute; }
        .relative { position: relative; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; }
        .right-0 { right: 0; }
        .bottom-0 { bottom: 0; }
        .left-0 { left: 0; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .cursor-pointer { cursor: pointer; }
        .text-xl { font-size: 1.25rem; }
        .text-lg { font-size: 1.125rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .capitalize { text-transform: capitalize; }
        .uppercase { text-transform: uppercase; }
        .opacity-50 { opacity: 0.5; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-200 { transition-duration: 200ms; }
        .hidden { display: none !important; }
        .flex-shrink-0 { flex-shrink: 0; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Custom Nodes and Connections */
        .node-wrapper {
            transition: all 0.2s ease-in-out;
            box-sizing: border-box;
        }
        .node-output, .node-input {
            transition: all 0.2s ease-in-out;
        }
        .node-output {
            background-color: #6366f1;
        }
        .node-input {
            background-color: #9ca3af;
        }

        /* Login Page */
        #login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            background-color: var(--background-color);
        }

        #login-page .card {
            width: 400px;
            text-align: center;
            background-color: var(--card-color);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-color);
            box-sizing: border-box;
        }
        
        button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }
        
        .success {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
        }
        
        .error {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
        }

        .main-content {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 10;
        }

        .controls button {
            width: 40px;
            height: 40px;
            padding: 0;
            margin-left: 5px;
            background-color: white;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            font-size: 1.5rem;
            line-height: 1;
        }

        .editor-panel {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 20;
            background-color: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .icon.mr-2 { margin-right: 0.5rem; }

        .icon-sm { width: 14px; height: 14px; }
    </style>
</head>
<body>

<div id="login-page">
    <div class="card">
        <h2>Login</h2>
        <form id="login-form">
            <div class="form-group">
                <input type="email" id="email" placeholder="Email" required>
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Senha" required>
            </div>
            <button type="submit">Entrar</button>
        </form>
        <div id="login-status" class="status-message hidden"></div>
    </div>
</div>

<div id="app" class="flex h-screen font-sans text-gray-800 overflow-hidden hidden">
    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 p-4 flex flex-col shadow-lg z-10">
        <h1 class="text-xl font-bold mb-6 text-gray-700">Construtor de Fluxo</h1>
        <div id="sidebar-content" class="flex-1 overflow-y-auto">
            <h2 class="text-sm font-semibold text-gray-500 mb-2 uppercase">Conteúdo</h2>
            <button class="w-full flex items-center p-3 rounded-lg bg-gray-50 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 transition-all duration-200 mb-2" data-type="contentBlock">
                <svg class="icon mr-2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span>Bloco de Mensagens</span>
            </button>
            
            <h2 class="text-sm font-semibold text-gray-500 mt-4 mb-2 uppercase">Ações</h2>
            <button class="w-full flex items-center p-3 rounded-lg bg-gray-50 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 transition-all duration-200 mb-2" data-type="queryClickIdCity">
                <svg class="icon mr-2" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path><circle cx="12" cy="9" r="3"></circle></svg>
                <span>Consultar Cidade</span>
            </button>
            <button class="w-full flex items-center p-3 rounded-lg bg-gray-50 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 transition-all duration-200 mb-2" data-type="generatePix">
                <svg class="icon mr-2" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5S14.49 16.5 12 16.5z"></path></svg>
                <span>Gerar PIX</span>
            </button>
            <button class="w-full flex items-center p-3 rounded-lg bg-gray-50 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 transition-all duration-200 mb-2" data-type="queryPixStatus">
                <svg class="icon mr-2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <span>Consultar Status PIX</span>
            </button>
        </div>
        <div>
             <button id="save-flow-btn" class="w-full flex items-center justify-center p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-all duration-200">
                <svg class="icon mr-2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                <span>Salvar Fluxo</span>
            </button>
        </div>
    </aside>

    <main id="flow-canvas" class="flex-1 h-full relative bg-dots cursor-grab">
        <div id="nodes-container" class="absolute w-full h-full" style="transform-origin: top left;">
            <svg id="connections-svg" class="absolute w-full h-full pointer-events-none overflow-visible">
                <defs>
                    <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#9ca3af" /></marker>
                    <marker id="arrow-red" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#f87171" /></marker>
                    <marker id="arrow-green" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#4ade80" /></marker>
                </defs>
            </svg>
        </div>
        <div class="controls flex absolute bottom-4 right-4 bg-white rounded-lg shadow-md border border-gray-200">
            <button id="zoom-out">-</button>
            <button id="zoom-in">+</button>
        </div>
    </main>

    <div id="editor-panel" class="editor-panel w-96 h-full border-l border-gray-200 p-4 z-20 flex flex-col hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 id="editor-title" class="text-lg font-bold capitalize"></h2>
            <button id="close-editor-btn" class="p-1 rounded-full text-2xl leading-none hover:bg-gray-200">&times;</button>
        </div>
        <div id="editor-content" class="flex-1 overflow-y-auto pr-2"></div>
        <div class="mt-4 pt-4 border-t flex justify-between">
            <button id="delete-node-btn" class="p-2 text-red-600 hover:bg-red-100 rounded-md">
                <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
            <button id="save-editor-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar Alterações</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const API_URL = 'https://novaapi-one.vercel.app/api';
    let jwtToken = localStorage.getItem('jwtToken');

    const elements = {
        loginPage: document.getElementById('login-page'),
        appPage: document.getElementById('app'),
        loginForm: document.getElementById('login-form'),
        loginStatus: document.getElementById('login-status'),
        flowCanvas: document.getElementById('flow-canvas'),
        nodesContainer: document.getElementById('nodes-container'),
        connectionsSvg: document.getElementById('connections-svg'),
        sidebar: document.getElementById('sidebar'),
        editorPanel: document.getElementById('editor-panel'),
        editorTitle: document.getElementById('editor-title'),
        editorContent: document.getElementById('editor-content'),
        saveFlowBtn: document.getElementById('save-flow-btn'),
        closeEditorBtn: document.getElementById('close-editor-btn'),
        saveEditorBtn: document.getElementById('save-editor-btn'),
        deleteNodeBtn: document.getElementById('delete-node-btn'),
        zoomInBtn: document.getElementById('zoom-in'),
        zoomOutBtn: document.getElementById('zoom-out'),
    };

    let nodes = [];
    let selectedNode = null;
    let viewState = { x: 0, y: 0, zoom: 1 };
    let dragInfo = null;
    let nextId = 1;
    let connectionPreview = null;
    let hoveredInputNodeId = null;

    // --- FUNÇÕES DE LÓGICA DO FLUXO ---

    function renderFlow() {
        elements.nodesContainer.innerHTML = '';
        renderConnections();

        nodes.forEach(node => {
            const nodeElement = createNodeElement(node);
            elements.nodesContainer.appendChild(nodeElement);
        });
    }

    function createNodeElement(node) {
        const nodeWrapper = document.createElement('div');
        const style = getNodeStyles(node.type);
        const isSelected = selectedNode && selectedNode.id === node.id;
        
        nodeWrapper.className = `node-wrapper absolute p-3 w-72 rounded-lg shadow-md transition-all duration-150 ${style.bg} border ${isSelected ? 'ring-2 ring-indigo-500 shadow-xl' : ''} ${style.border} cursor-grab active:cursor-grabbing`;
        nodeWrapper.style.left = `${node.position.x}px`;
        nodeWrapper.style.top = `${node.position.y}px`;
        nodeWrapper.dataset.id = node.id;

        const title = node.type.replace(/([A-Z])/g, ' $1').trim();
        const iconSvg = getNodeIconSvg(node.type);
        const contentHtml = getNodeContentHtml(node);
        const outputsHtml = getNodeOutputsHtml(node);
        const inputsHtml = getNodeInputsHtml(node);

        nodeWrapper.innerHTML = `
            <div class="flex items-center mb-2 pb-2 border-b">
                ${iconSvg}
                <span class="font-bold text-sm text-gray-700 capitalize">${title}</span>
            </div>
            <div class="space-y-1 mb-2">
                ${contentHtml}
            </div>
            ${outputsHtml}
            ${inputsHtml}
        `;
        
        addNodeListeners(nodeWrapper, node);
        return nodeWrapper;
    }

    function addNodeListeners(nodeElement, node) {
        nodeElement.addEventListener('mousedown', e => {
            if (e.target.closest('.node-output')) return;
            e.stopPropagation();
            dragInfo = {
                type: 'node',
                id: node.id,
                startX: e.clientX,
                startY: e.clientY,
                initialNodePos: { ...node.position },
                hasDragged: false
            };
        });

        nodeElement.addEventListener('mouseup', e => {
            if (dragInfo?.type === 'node' && !dragInfo.hasDragged) {
                setSelectedNode(node);
            }
        });

        // Output listeners
        const outputs = nodeElement.querySelectorAll('.node-output');
        outputs.forEach(output => {
            output.addEventListener('mousedown', e => {
                e.stopPropagation();
                dragInfo = {
                    type: 'connection',
                    startNodeId: node.id,
                    startOutputId: output.dataset.id
                };
            });
        });

        // Input listeners
        const input = nodeElement.querySelector('.node-input');
        if (input) {
            input.addEventListener('mouseenter', () => {
                hoveredInputNodeId = node.id;
                renderFlow();
            });
            input.addEventListener('mouseleave', () => {
                hoveredInputNodeId = null;
                renderFlow();
            });
        }
    }

    function renderConnections() {
        elements.connectionsSvg.innerHTML = `
            <defs>
                <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#9ca3af" /></marker>
                <marker id="arrow-red" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#f87171" /></marker>
                <marker id="arrow-green" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#4ade80" /></marker>
            </defs>
        `;

        nodes.forEach(node => {
            let connections = [];
            if (node.type === 'contentBlock' && node.replySettings?.awaitsReply) {
                if (node.replySettings.onReplyNextStepId) connections.push({ id: 'onReply', nextStepId: node.replySettings.onReplyNextStepId });
                if (node.replySettings.onTimeoutNextStepId) connections.push({ id: 'onTimeout', nextStepId: node.replySettings.onTimeoutNextStepId });
            } else {
                connections = node.outputs || [];
            }

            connections.forEach(output => {
                if (!output.nextStepId) return;
                const targetNode = nodes.find(n => n.id === output.nextStepId);
                if (!targetNode) return;

                const yOffset = getOutputYOffset(node, output.id);
                const isTimeout = output.id === 'onTimeout';
                const isSuccess = output.id === 'onReply';

                let strokeColor = "#9ca3af";
                let marker = "url(#arrow)";
                let dasharray = "none";

                if (isTimeout) {
                    strokeColor = "#f87171";
                    marker = "url(#arrow-red)";
                    dasharray = "5 5";
                } else if (isSuccess) {
                    strokeColor = "#4ade80";
                    marker = "url(#arrow-green)";
                }

                const startPos = { x: node.position.x + 288, y: node.position.y + yOffset };
                const endPos = { x: targetNode.position.x, y: targetNode.position.y + 45 };
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${startPos.x} ${startPos.y} C ${startPos.x + 60} ${startPos.y}, ${endPos.x - 60} ${endPos.y}, ${endPos.x} ${endPos.y}`);
                path.setAttribute('stroke', strokeColor);
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', marker);
                path.setAttribute('stroke-dasharray', dasharray);

                elements.connectionsSvg.appendChild(path);
            });
        });

        // Preview de conexão
        if (connectionPreview) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M ${connectionPreview.startPos.x} ${connectionPreview.startPos.y} C ${connectionPreview.startPos.x + 60} ${connectionPreview.startPos.y}, ${connectionPreview.endPos.x - 60} ${connectionPreview.endPos.y}, ${connectionPreview.endPos.x} ${connectionPreview.endPos.y}`);
            path.setAttribute('stroke', '#6366f1');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('stroke-dasharray', '5 5');
            path.setAttribute('fill', 'none');
            elements.connectionsSvg.appendChild(path);
        }
    }

    function addNode(type) {
        const newId = nextId++;
        let newNode = { id: newId, type, position: { x: 50, y: 50 } };

        switch (type) {
            case 'contentBlock':
                newNode = {
                    ...newNode,
                    actions: [{ id: `act_${Date.now()}_1`, type: 'text', content: 'Nova mensagem' }],
                    replySettings: { awaitsReply: false, timeoutSeconds: 300 },
                    urlButtons: [],
                    outputs: [{ id: 'out', nextStepId: null }]
                };
                break;
            case 'queryClickIdCity':
                newNode = {
                    ...newNode,
                    content: 'Salva cidade em {{city}}',
                    outputs: [{ id: 'out', nextStepId: null }]
                };
                break;
            case 'generatePix':
                newNode = {
                    ...newNode,
                    content: 'Gerar PIX de R$ 0.00',
                    valueInCents: 0,
                    messageTemplate: 'Seu PIX: `{{pix_code}}`',
                    outputs: [{ id: 'success', label: 'Sucesso', nextStepId: null }, { id: 'failure', label: 'Falha', nextStepId: null }]
                };
                break;
            case 'queryPixStatus':
                newNode = {
                    ...newNode,
                    content: 'Consultar status do PIX',
                    outputs: [{ id: 'paid', label: 'Pago', nextStepId: null }, { id: 'pending', label: 'Pendente', nextStepId: null }]
                };
                break;
        }

        nodes.push(newNode);
        renderFlow();
    }

    function updateNode(nodeId, updatedData) {
        const nodeIndex = nodes.findIndex(n => n.id === nodeId);
        if (nodeIndex > -1) {
            nodes[nodeIndex] = { ...nodes[nodeIndex], ...updatedData };
            renderFlow();
            if (selectedNode && selectedNode.id === nodeId) {
                selectedNode = nodes[nodeIndex];
                renderEditor();
            }
        }
    }

    function deleteNode(nodeId) {
        if (nodes.find(n => n.id === nodeId)?.type === 'start') return;
        nodes = nodes.filter(n => n.id !== nodeId);
        nodes.forEach(n => {
            if (n.outputs) {
                n.outputs.forEach(o => { if (o.nextStepId === nodeId) o.nextStepId = null; });
            }
            if (n.replySettings?.onReplyNextStepId === nodeId) n.replySettings.onReplyNextStepId = null;
            if (n.replySettings?.onTimeoutNextStepId === nodeId) n.replySettings.onTimeoutNextStepId = null;
        });
        setSelectedNode(null);
        hideEditorPanel();
        renderFlow();
    }
    
    // --- FUNÇÕES DE RENDERIZAÇÃO DO EDITOR ---

    function renderEditor() {
        if (!selectedNode) {
            hideEditorPanel();
            return;
        }

        elements.editorPanel.classList.remove('hidden');
        elements.editorTitle.textContent = `Editar: ${selectedNode.type.replace(/([A-Z])/g, ' $1').trim()}`;
        elements.deleteNodeBtn.disabled = selectedNode.type === 'start';

        let html = '';
        switch (selectedNode.type) {
            case 'contentBlock':
                html = `
                    <h3 class="text-sm font-semibold mb-2">Ações no Bloco</h3>
                    <div class="space-y-2" id="action-editors-container"></div>
                    <div class="mt-4 p-2 border-t text-sm">
                        <h4 class="font-semibold mb-2">Adicionar Ação</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button data-type="text" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-md">+ Texto</button>
                            <button data-type="delay" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-md">+ Atraso</button>
                            <button data-type="image" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-md">+ Imagem</button>
                            <button data-type="audio" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-md">+ Áudio</button>
                            <button data-type="video" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-md">+ Vídeo</button>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t text-sm">
                        <label class="flex items-center space-x-2 mb-2">
                            <input type="checkbox" id="awaits-reply-checkbox" ${selectedNode.replySettings?.awaitsReply ? 'checked' : ''} />
                            <span class="font-semibold">Aguardar resposta do cliente?</span>
                        </label>
                        <div id="reply-settings-container" class="${selectedNode.replySettings?.awaitsReply ? '' : 'hidden'} pl-2 border-l-2">
                            <label class="block text-xs text-gray-500 mb-1">Se não responder em (minutos):</label>
                            <input type="number" id="timeout-input" min="1" class="w-full p-1 border rounded-md mb-2 text-sm" value="${(selectedNode.replySettings?.timeoutSeconds || 0) / 60}" />
                            <p class="text-xs text-gray-500">Conecte as saídas "SE RESPONDER" e "SE NÃO RESPONDER" no canvas.</p>
                        </div>
                        <div id="url-buttons-container" class="${selectedNode.replySettings?.awaitsReply ? 'hidden' : ''}">
                             <h3 class="text-sm font-semibold mt-2 mb-2">Botões (abrir site)</h3>
                             ${(selectedNode.urlButtons || []).map((btn, i) => `
                                 <div class="p-2 border rounded-md mb-2 bg-gray-50">
                                     <input type="text" class="w-full p-1 border rounded-md mb-2" placeholder="Texto do Botão" value="${btn.label}" data-prop="label" data-index="${i}" />
                                     <input type="text" class="w-full p-1 border rounded-md" placeholder="https://exemplo.com" value="${btn.url}" data-prop="url" data-index="${i}" />
                                     <button class="remove-btn text-xs text-red-500 hover:text-red-700 mt-1" data-index="${i}">Remover</button>
                                 </div>
                             `).join('')}
                             <button id="add-url-button-btn" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm">+ Adicionar Botão</button>
                        </div>
                    </div>
                `;
                break;
            case 'queryClickIdCity':
                html = `
                   <label class="block text-sm font-medium text-gray-700 mb-2">Salvar cidade na variável</label>
                   <input type="text" id="city-var-input" class="w-full p-2 border rounded-md" value="${selectedNode.cityVar || ''}" />
                `;
                break;
            case 'generatePix':
                html = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor do PIX (em centavos)</label>
                    <input type="number" id="value-cents-input" class="w-full p-2 border rounded-md" value="${selectedNode.valueInCents || 0}" />
                    <label class="block text-sm font-medium text-gray-700 mt-4 mb-2">Mensagem para o cliente</label>
                    <textarea id="message-template-textarea" class="w-full p-2 border rounded-md text-sm" rows="4">${selectedNode.messageTemplate || ''}</textarea>
                    <p class="text-xs text-gray-500 mt-1">Use <code>{"{{pix_code}}"}</code> onde o PIX deve aparecer. Um botão "Copiar" será adicionado automaticamente.</p>
                `;
                break;
            case 'queryPixStatus':
                html = `<p class="text-sm text-gray-600">Esta ação irá verificar o status do último PIX gerado para o cliente.</p>`;
                break;
            default:
                html = `<p>Este passo não pode ser editado.</p>`;
        }
        
        elements.editorContent.innerHTML = html;

        // Populate dynamic parts and add listeners
        if (selectedNode.type === 'contentBlock') {
            const actionsContainer = elements.editorContent.querySelector('#action-editors-container');
            (selectedNode.actions || []).forEach((action, i) => {
                const actionEditor = document.createElement('div');
                actionEditor.className = 'p-2 border rounded-md bg-gray-50';
                actionEditor.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold uppercase text-gray-500">${action.type}</span>
                        <button class="remove-action-btn text-red-400 hover:text-red-600" data-index="${i}">
                            <svg class="icon-sm" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                    ${renderActionFields(action, i)}
                `;
                actionsContainer.appendChild(actionEditor);
            });
            
            elements.editorContent.querySelectorAll('.remove-action-btn').forEach(btn => btn.addEventListener('click', e => {
                const index = parseInt(e.currentTarget.dataset.index, 10);
                selectedNode.actions.splice(index, 1);
                renderEditor();
            }));

            elements.editorContent.querySelectorAll('[data-type]').forEach(btn => btn.addEventListener('click', e => {
                const newAction = { id: `act_${Date.now()}`, type: e.currentTarget.dataset.type };
                selectedNode.actions.push(newAction);
                renderEditor();
            }));

            elements.editorContent.querySelector('#awaits-reply-checkbox').addEventListener('change', e => {
                selectedNode.replySettings.awaitsReply = e.target.checked;
                elements.editorContent.querySelector('#reply-settings-container').classList.toggle('hidden', !e.target.checked);
                elements.editorContent.querySelector('#url-buttons-container').classList.toggle('hidden', e.target.checked);
            });

            const urlButtonsContainer = elements.editorContent.querySelector('#url-buttons-container');
            if (urlButtonsContainer) {
                urlButtonsContainer.addEventListener('input', e => {
                    const index = parseInt(e.target.dataset.index, 10);
                    selectedNode.urlButtons[index][e.target.dataset.prop] = e.target.value;
                });
                urlButtonsContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-btn')) {
                        const index = parseInt(e.target.dataset.index, 10);
                        selectedNode.urlButtons.splice(index, 1);
                        renderEditor();
                    } else if (e.target.id === 'add-url-button-btn') {
                        selectedNode.urlButtons.push({ id: `btn_${Date.now()}`, label: 'Novo Botão', url: '' });
                        renderEditor();
                    }
                });
            }
        }

        if (selectedNode.type === 'queryClickIdCity') {
             elements.editorContent.querySelector('#city-var-input').addEventListener('input', e => {
                selectedNode.cityVar = e.target.value;
                selectedNode.content = `Salva cidade em {{${e.target.value}}}`;
            });
        }
        if (selectedNode.type === 'generatePix') {
            elements.editorContent.querySelector('#value-cents-input').addEventListener('input', e => {
                selectedNode.valueInCents = parseInt(e.target.value, 10) || 0;
                selectedNode.content = `Gerar PIX de R$ ${(selectedNode.valueInCents / 100).toFixed(2)}`;
            });
             elements.editorContent.querySelector('#message-template-textarea').addEventListener('input', e => {
                selectedNode.messageTemplate = e.target.value;
            });
        }
    }

    function renderActionFields(action, index) {
        switch (action.type) {
            case 'text':
                return `<textarea class="w-full p-2 border rounded-md text-sm" rows="3" data-index="${index}" data-prop="content">${action.content || ''}</textarea>`;
            case 'image': case 'audio': case 'video':
                return `<input type="text" class="w-full p-2 border rounded-md text-sm" placeholder="URL do ${action.type}" value="${action.url || ''}" data-index="${index}" data-prop="url" />`;
            case 'delay':
                return `<input type="number" class="w-full p-2 border rounded-md text-sm" placeholder="Segundos" value="${action.delaySeconds || 0}" data-index="${index}" data-prop="delaySeconds" />`;
            default: return '';
        }
    }

    function hideEditorPanel() {
        elements.editorPanel.classList.add('hidden');
        selectedNode = null;
        renderFlow();
    }
    
    // --- FUNÇÕES AUXILIARES ---
    function getNodeStyles(type) {
        const styles = {
            start: { bg: 'bg-green-100', border: 'border-green-300' },
            contentBlock: { bg: 'bg-white', border: 'border-gray-300' },
            redirectFlow: { bg: 'bg-teal-50', border: 'border-teal-300' },
            queryClickIdCity: { bg: 'bg-orange-50', border: 'border-orange-300' },
            generatePix: { bg: 'bg-emerald-50', border: 'border-emerald-300' },
            queryPixStatus: { bg: 'bg-indigo-50', border: 'border-indigo-300' },
        };
        return styles[type] || styles.contentBlock;
    }

    function getNodeIconSvg(type) {
        const icons = {
            start: '<svg class="icon mr-2" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path><path d="M12 16.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5S14.49 16.5 12 16.5z"></path></svg>',
            contentBlock: '<svg class="icon mr-2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
            queryClickIdCity: '<svg class="icon mr-2" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path><circle cx="12" cy="9" r="3"></circle></svg>',
            generatePix: '<svg class="icon mr-2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
            queryPixStatus: '<svg class="icon mr-2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
        };
        return icons[type] || '<svg class="icon mr-2" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path></svg>';
    }

    function getNodeContentHtml(node) {
        let html = '';
        if (node.type === 'contentBlock') {
            const actionIcons = {
                text: `<svg class="icon-sm mr-2 flex-shrink-0" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
                delay: `<svg class="icon-sm mr-2 flex-shrink-0" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
                image: `<svg class="icon-sm mr-2 flex-shrink-0" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`,
                audio: `<svg class="icon-sm mr-2 flex-shrink-0" viewBox="0 0 24 24"><path d="M22.5 12h-20a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h20a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"></path></svg>`,
                video: `<svg class="icon-sm mr-2 flex-shrink-0" viewBox="0 0 24 24"><path d="M23 7l-7 5 7 5V7z"></path><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>`,
            };
            html = (node.actions || []).map(action => `
                <div class="text-xs text-gray-600 flex items-center bg-gray-50 p-1 rounded-sm">
                    ${actionIcons[action.type]}
                    <span class="truncate">${action.type === 'delay' ? `Digitando por ${action.delaySeconds || 0} segundos...` : action.content || action.url || 'Conteúdo vazio'}</span>
                </div>
            `).join('');

            html += (node.urlButtons || []).map(button => `
                <div class="relative text-center text-sm bg-gray-100 border border-gray-200 rounded-md py-1 px-3 mt-2 flex items-center justify-center">
                    <svg class="icon-sm mr-2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    <span>${button.label || 'Botão'}</span>
                </div>
            `).join('');

        } else {
            html = `<p class="text-sm text-gray-600 break-words">${node.content}</p>`;
        }
        return html;
    }

    function getNodeOutputsHtml(node) {
        let outputs = node.outputs || [];
        if (node.type === 'contentBlock' && node.replySettings?.awaitsReply) {
            outputs = [
                { id: 'onTimeout', label: `SE NÃO RESPONDER` },
                { id: 'onReply', label: 'SE RESPONDER' }
            ];
        }

        let html = '';
        if (node.replySettings?.awaitsReply) {
            html = `
                <div class="mt-2 pt-2 border-t border-gray-200 space-y-2">
                    ${outputs.map(output => `
                        <div class="relative flex items-center justify-end h-6">
                            <span class="text-[10px] font-semibold pr-5 text-${output.id === 'onTimeout' ? 'red' : 'green'}-600">${output.label}</span>
                            <div class="node-output absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-${output.id === 'onTimeout' ? 'red' : 'green'}-400 border-2 border-white cursor-crosshair z-10" data-id="${output.id}"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (outputs.length > 0) {
            // Standard single output
            const yOffset = getOutputYOffset(node, outputs[0].id);
            html = `<div class="node-output absolute -right-2 w-4 h-4 rounded-full bg-indigo-400 border-2 border-white cursor-crosshair z-10" style="top: ${yOffset}px;" data-id="${outputs[0].id}"></div>`;
        }
        
        return html;
    }
    
    function getNodeInputsHtml(node) {
        if (node.type === 'start') return '';
        const isHovered = hoveredInputNodeId === node.id && dragInfo?.type === 'connection' && dragInfo?.startNodeId !== node.id;
        return `
            <div class="absolute -left-5 top-0 bottom-0 w-10 z-10">
                <div class="node-input absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-gray-400 border-2 border-white transition-all ${isHovered ? 'ring-4 ring-indigo-400 scale-125' : ''}" title="Ponto de entrada"></div>
            </div>
        `;
    }

    function getOutputYOffset(node, outputId) {
        if (node.type === 'contentBlock' && node.replySettings?.awaitsReply) {
            return outputId === 'onTimeout' ? 55 : 85;
        }
        return 45;
    }

    // --- MANIPULAÇÃO DO CANVAS E EVENTOS GLOBAIS ---

    function handleMouseDown(e) {
        if (e.target.closest('.node-wrapper, #sidebar, #editor-panel, .controls')) return;
        dragInfo = { type: 'pan', startX: e.clientX - viewState.x, startY: e.clientY - viewState.y };
        elements.flowCanvas.style.cursor = 'grabbing';
    }

    function handleMouseMove(e) {
        if (!dragInfo) {
            if (dragInfo?.type === 'connection') {
                 connectionPreview.endPos = {
                    x: (e.clientX - viewState.x) / viewState.zoom,
                    y: (e.clientY - viewState.y) / viewState.zoom
                };
                renderConnections();
            }
            return;
        }

        if (dragInfo.type === 'pan') {
            viewState.x = e.clientX - dragInfo.startX;
            viewState.y = e.clientY - dragInfo.startY;
            elements.nodesContainer.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.zoom})`;
        } else if (dragInfo.type === 'node') {
            const dx = e.clientX - dragInfo.startX;
            const dy = e.clientY - dragInfo.startY;
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                dragInfo.hasDragged = true;
            }
            const newX = dragInfo.initialNodePos.x + dx / viewState.zoom;
            const newY = dragInfo.initialNodePos.y + dy / viewState.zoom;
            updateNodePosition(dragInfo.id, newX, newY);
        } else if (dragInfo.type === 'connection') {
            const startNode = nodes.find(n => n.id === dragInfo.startNodeId);
            const yOffset = getOutputYOffset(startNode, dragInfo.startOutputId);
            
            connectionPreview = {
                startPos: { x: startNode.position.x + 288, y: startNode.position.y + yOffset },
                endPos: { x: (e.clientX - viewState.x) / viewState.zoom, y: (e.clientY - viewState.y) / viewState.zoom },
                type: dragInfo.startOutputId
            };
            renderConnections();
        }
    }

    function handleMouseUp(e) {
        elements.flowCanvas.style.cursor = 'grab';

        if (dragInfo?.type === 'connection' && hoveredInputNodeId) {
            const startNodeId = dragInfo.startNodeId;
            const startOutputId = dragInfo.startOutputId;
            const targetNodeId = hoveredInputNodeId;

            if (startNodeId !== targetNodeId) {
                const startNode = nodes.find(n => n.id === startNodeId);
                if (startNode.type === 'contentBlock' && startNode.replySettings?.awaitsReply) {
                    if (startOutputId === 'onReply') startNode.replySettings.onReplyNextStepId = targetNodeId;
                    if (startOutputId === 'onTimeout') startNode.replySettings.onTimeoutNextStepId = targetNodeId;
                } else if (startNode.outputs) {
                    const output = startNode.outputs.find(o => o.id === startOutputId);
                    if (output) output.nextStepId = targetNodeId;
                }
            }
        }
        
        dragInfo = null;
        connectionPreview = null;
        hoveredInputNodeId = null;
        renderFlow();
    }
    
    function updateNodePosition(id, x, y) {
        const nodeIndex = nodes.findIndex(n => n.id === id);
        if (nodeIndex > -1) {
            nodes[nodeIndex].position.x = x;
            nodes[nodeIndex].position.y = y;
            renderFlow();
        }
    }

    // --- FUNÇÕES DE LÓGICA DO DASHBOARD ---
    async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        elements.loginStatus.classList.add('hidden');

        try {
            const response = await fetch(`${API_URL}/sellers/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const result = await response.json();

            if (response.ok) {
                jwtToken = result.token;
                localStorage.setItem('jwtToken', jwtToken);
                elements.loginPage.classList.add('hidden');
                elements.appPage.classList.remove('hidden');
                loadInitialNodes();
            } else {
                elements.loginStatus.textContent = result.message || 'Erro no login.';
                elements.loginStatus.className = 'status-message error';
            }
        } catch (error) {
            elements.loginStatus.textContent = 'Erro ao conectar com a API.';
            elements.loginStatus.className = 'status-message error';
        }
    }

    // --- INICIALIZAÇÃO E EVENT LISTENERS ---
    
    elements.loginForm.addEventListener('submit', handleLogin);
    elements.flowCanvas.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    elements.zoomInBtn.addEventListener('click', () => {
        viewState.zoom = Math.min(2.5, viewState.zoom + 0.1);
        elements.nodesContainer.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.zoom})`;
    });

    elements.zoomOutBtn.addEventListener('click', () => {
        viewState.zoom = Math.max(0.5, viewState.zoom - 0.1);
        elements.nodesContainer.style.transform = `translate(${viewState.x}px, ${viewState.y}px) scale(${viewState.zoom})`;
    });

    elements.sidebar.addEventListener('click', e => {
        const type = e.target.closest('button')?.dataset.type;
        if (type) {
            addNode(type);
        }
    });

    elements.saveFlowBtn.addEventListener('click', () => {
        console.log("Fluxo salvo no console:", nodes);
        alert('Fluxo salvo! Verifique o console do navegador (F12)');
    });

    elements.closeEditorBtn.addEventListener('click', () => {
        hideEditorPanel();
    });

    elements.saveEditorBtn.addEventListener('click', () => {
        // Implementar a lógica de salvamento aqui
        if (selectedNode.type === 'contentBlock') {
            const actionsContainer = elements.editorContent.querySelector('#action-editors-container');
            const newActions = [];
            actionsContainer.querySelectorAll('div').forEach(actionDiv => {
                const type = actionDiv.querySelector('span').textContent.toLowerCase();
                const input = actionDiv.querySelector('textarea, input');
                if (input) {
                    if (type === 'text') newActions.push({ type, content: input.value });
                    else if (type === 'delay') newActions.push({ type, delaySeconds: parseInt(input.value, 10) });
                    else newActions.push({ type, url: input.value });
                }
            });
            updateNode(selectedNode.id, { actions: newActions });
        }
        hideEditorPanel();
    });

    elements.deleteNodeBtn.addEventListener('click', () => {
        if (confirm('Tem certeza que deseja excluir este nó?')) {
            deleteNode(selectedNode.id);
        }
    });

    // Initial load
    if (jwtToken) {
        elements.loginPage.classList.add('hidden');
        elements.appPage.classList.remove('hidden');
        loadInitialNodes();
    }
    
    function loadInitialNodes() {
        nodes = [
            { id: 1, type: 'start', content: 'Início do Fluxo', position: { x: 50, y: 200 }, outputs: [{ id: 'out', nextStepId: 2 }] },
            { id: 2, type: 'contentBlock', position: { x: 300, y: 150 }, actions: [{ id: `act_1`, type: 'text', content: 'Olá! Bem-vindo.' }], replySettings: { awaitsReply: true, onReplyNextStepId: 3, onTimeoutNextStepId: 5, timeoutSeconds: 300 }, urlButtons: [], outputs: [] },
            { id: 3, type: 'generatePix', content: 'Gerar PIX de R$ 19,90', valueInCents: 1990, messageTemplate: 'Seu PIX: `{{pix_code}}`', position: { x: 600, y: 350 }, outputs: [{ id: 'success', label: 'Sucesso', nextStepId: 4 }, { id: 'failure', label: 'Falha', nextStepId: null }] },
            { id: 4, type: 'queryPixStatus', content: 'Consultar status do PIX', position: { x: 900, y: 350 }, outputs: [{ id: 'paid', label: 'Pago', nextStepId: null }, { id: 'pending', label: 'Pendente', nextStepId: null }] },
            { id: 5, type: 'contentBlock', position: { x: 600, y: 50 }, actions: [{ id: `act_2`, type: 'text', content: '❌ Você demorou para responder.' }], outputs: [{ id: 'out', nextStepId: null }], urlButtons: [], replySettings: { awaitsReply: false, timeoutSeconds: 300 } },
        ];
        nextId = Math.max(...nodes.map(n => n.id)) + 1;
        renderFlow();
    }
});
</script>

</body>
</html>
