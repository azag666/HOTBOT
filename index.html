<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hotbot - Flow Builder Conectado</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">

  <style>
    /* Basic reset + layout */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body,#root { height: 100%; }
    body { font-family: Inter, Roboto, system-ui, -apple-system, 'Segoe UI', Arial; background:#0f172a; color:#0f172a; }

    .app { display: flex; height: 100vh; width: 100%; overflow: hidden; }
    .sidebar { width: 320px; min-width: 280px; background: linear-gradient(180deg,#0b1220,#0f172a); color: #fff; padding: 18px; display:flex; flex-direction: column; gap:12px; border-right: 1px solid rgba(255,255,255,0.04); }
    .sidebar h1 { font-size:16px; margin-bottom:6px; }
    .sb-section { font-size:12px; color:rgba(255,255,255,0.7); margin-top:6px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.6px; }

    .node-button { display:flex; align-items:center; gap:10px; background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.03); padding:10px; border-radius:10px; cursor:pointer; color:#fff; }
    .node-button:hover { transform: translateY(-2px); background: rgba(255,255,255,0.08); }

    .sidebar .bottom-controls { margin-top:auto; display:flex; gap:8px; flex-direction:column; }
    .main { flex:1; display:flex; flex-direction:column; min-width:0; }
    .header { padding:12px 16px; background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); color: #fff; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:space-between; }
    .header h2 { font-size:16px; }
    .controls-row { display:flex; gap:8px; align-items:center; }
    .flow-wrapper { flex:1; min-height:0; position:relative; padding:12px; }
    .reactflow-container { height:100%; width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#071022,#071A2B); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02); }

    /* Custom node styles */
    .custom-node { min-width: 200px; padding:10px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.4); background: linear-gradient(180deg,#ffffff,#f8fafc); border:1px solid #e6e9ee; font-size:13px; }
    .custom-node .title { font-weight:700; margin-bottom:6px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .custom-node .small { font-size:12px; color:#374151; opacity:0.9; }

    .node-msg { background: linear-gradient(180deg,#ecfccb,#ddf7d6); border-color:#86efac; }
    .node-q { background: linear-gradient(180deg,#ffedd5,#fff1e0); border-color:#fdba74; }
    .node-condition { background: linear-gradient(180deg,#fee2e2,#fff2f2); border-color:#fca5a5; }
    .node-action { background: linear-gradient(180deg,#dbeafe,#e6f0ff); border-color:#93c5fd; }
    .node-pix { background: linear-gradient(180deg,#ecfccb,#d9f7e0); border-color:#4ade80; }
    .node-status { background: linear-gradient(180deg,#eef2ff,#f0f7ff); border-color:#a78bfa; }
    .node-click { background: linear-gradient(180deg,#fff7ed,#fff8e6); border-color:#f59e0b; }
    .node-live { background: linear-gradient(180deg,#f0f9ff,#ecfeff); border-color:#60a5fa; }

    /* Editor panel */
    .editor-panel { position:absolute; right:12px; top:72px; width:360px; bottom:12px; background:#fff; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.4); padding:12px; overflow:auto; z-index:50; }

    /* General UI */
    .btn { padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid rgba(0,0,0,0.08); background:#fff; }
    .btn.primary { background:#4f46e5; color:#fff; border-color:transparent; }
    .btn.danger { background:#ef4444; color:#fff; border-color:transparent; }
    .badge { padding:6px 8px; border-radius:8px; background:rgba(15,23,42,0.6); color:#fff; font-size:12px; }
    .form-input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; margin-bottom: 8px; }
    select.form-input { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;}
    
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
    .login-box { background: #0f172a; padding: 24px; border-radius: 12px; width: 320px; color: white; border: 1px solid rgba(255,255,255,0.1); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useCallback, useEffect } = React;
    const RF = window.ReactFlow;
    const API_BASE_URL = 'https://novaapi-one.vercel.app/api';

    // --- Configura√ß√£o do Axios para incluir o Token ---
    const api = axios.create({
        baseURL: API_BASE_URL,
    });

    api.interceptors.request.use(config => {
        const token = localStorage.getItem('authToken');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    // --- N√≥s Iniciais de Exemplo ---
    const createInitialFlow = () => ({
        nodes: [{ id: 'start', type: 'message', position: { x: 50, y: 50 }, data: { label:'In√≠cio', text: 'Bem-vindo ao novo fluxo!' } }],
        edges: []
    });

    // --- Componentes de N√≥ Customizados ---
    const BaseNode = ({ data, children, variantClass }) => (
        <div className={`custom-node ${variantClass}`}>
            <div className="title"><span>{data.label || 'Node'}</span></div>
            <div>{children}</div>
            <RF.Handle type="target" position={RF.Position.Top} />
            <RF.Handle type="source" position={RF.Position.Bottom} />
        </div>
    );
    const MessageNode = ({ data }) => <BaseNode data={data} variantClass="node-msg">{data.text || 'Mensagem...'}</BaseNode>;
    const QuestionNode = ({ data }) => <BaseNode data={data} variantClass="node-q">{data.question || 'Pergunta...'}</BaseNode>;
    const ConditionNode = ({ data }) => <BaseNode data={data} variantClass="node-condition">{data.condition || 'Condi√ß√£o...'}</BaseNode>;
    const ActionNode = ({ data }) => <BaseNode data={data} variantClass="node-action">{data.action || 'A√ß√£o...'}</BaseNode>;
    const GeneratePixNode = ({ data }) => <BaseNode data={data} variantClass="node-pix">Valor: R$ {(data.valueInCents / 100).toFixed(2)}</BaseNode>;
    const QueryPixStatusNode = ({ data }) => <BaseNode data={data} variantClass="node-status">Consultar Status</BaseNode>;
    const SaveClickIdNode = ({ data }) => <BaseNode data={data} variantClass="node-click">Salvar: {data.variableName}</BaseNode>;
    const ChatLiveNode = ({ data }) => <BaseNode data={data} variantClass="node-live">Operador: {data.operator}</BaseNode>;

    const nodeTypes = { message: MessageNode, question: QuestionNode, condition: ConditionNode, action: ActionNode, generatePix: GeneratePixNode, queryPixStatus: QueryPixStatusNode, saveClickId: SaveClickIdNode, chatLive: ChatLiveNode };

    // --- Componente Principal da Aplica√ß√£o ---
    function App() {
        const [nodes, setNodes, onNodesChange] = RF.useNodesState([]);
        const [edges, setEdges, onEdgesChange] = RF.useEdgesState([]);
        const [isAuthenticated, setIsAuthenticated] = useState(!!localStorage.getItem('authToken'));
        const [bots, setBots] = useState([]);
        const [selectedBotId, setSelectedBotId] = useState('');
        const [flows, setFlows] = useState([]);
        const [currentFlow, setCurrentFlow] = useState(null);
        const [showEditor, setShowEditor] = useState(false);
        const [editorNode, setEditorNode] = useState(null);

        // --- Efeitos ---
        useEffect(() => {
            if (isAuthenticated) {
                fetchDashboardData();
            }
        }, [isAuthenticated]);

        useEffect(() => {
            if (selectedBotId) {
                fetchFlowsForBot(selectedBotId);
            } else {
                setFlows([]);
                setCurrentFlow(null);
            }
        }, [selectedBotId]);

        useEffect(() => {
            if (currentFlow) {
                const flowContent = currentFlow.nodes ? JSON.parse(currentFlow.nodes) : createInitialFlow();
                setNodes(flowContent.nodes || []);
                setEdges(flowContent.edges || []);
            } else {
                setNodes([]);
                setEdges([]);
            }
        }, [currentFlow]);

        // --- Fun√ß√µes da API ---
        const handleLogin = async (email, password) => {
            try {
                const response = await axios.post(`${API_BASE_URL}/sellers/login`, { email, password });
                localStorage.setItem('authToken', response.data.token);
                setIsAuthenticated(true);
            } catch (error) {
                alert('Falha no login: ' + (error.response?.data?.message || 'Erro de conex√£o'));
            }
        };

        const handleLogout = () => {
            localStorage.removeItem('authToken');
            setIsAuthenticated(false);
            setBots([]);
            setSelectedBotId('');
        };

        const fetchDashboardData = async () => {
            try {
                const response = await api.get('/dashboard/data');
                setBots(response.data.bots || []);
                if (response.data.bots.length > 0) {
                    setSelectedBotId(response.data.bots[0].id);
                }
            } catch (error) {
                console.error("Erro ao buscar dados do dashboard:", error);
                if(error.response?.status === 403) handleLogout();
            }
        };
        
        const fetchFlowsForBot = async (botId) => {
            try {
                // A API /api/flows retorna todos os fluxos do usu√°rio. Precisamos filtrar pelo botId no frontend.
                const response = await api.get('/flows');
                const botFlows = response.data.filter(flow => flow.bot_id == botId);
                setFlows(botFlows);
                if (botFlows.length > 0) {
                    setCurrentFlow(botFlows[0]);
                } else {
                    setCurrentFlow(null);
                }
            } catch (error) {
                console.error("Erro ao buscar fluxos:", error);
                if(error.response?.status === 403) handleLogout();
            }
        };

        const saveFlow = async () => {
            if (!currentFlow) {
                alert('Nenhum fluxo selecionado para salvar.');
                return;
            }
            try {
                const flowPayload = {
                    name: currentFlow.name,
                    nodes: JSON.stringify({ nodes, edges }), // Salvando n√≥s e arestas juntos
                };
                await api.put(`/flows/${currentFlow.id}`, flowPayload);
                alert('Fluxo salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar o fluxo:', error);
                alert('Erro ao salvar: ' + (error.response?.data?.message || 'Tente novamente'));
            }
        };

        const createNewFlow = async () => {
            const flowName = prompt("Digite o nome do novo fluxo:");
            if (flowName && selectedBotId) {
                try {
                    const response = await api.post('/flows', { name: flowName, botId: selectedBotId });
                    fetchFlowsForBot(selectedBotId); // Recarrega a lista
                    setCurrentFlow(response.data); // Define o novo fluxo como ativo
                } catch (error) {
                    alert('Erro ao criar fluxo: ' + (error.response?.data?.message || 'Tente novamente'));
                }
            }
        };
        
        const deleteFlow = async () => {
            if (currentFlow && confirm(`Tem certeza que deseja deletar o fluxo "${currentFlow.name}"?`)) {
                try {
                    await api.delete(`/flows/${currentFlow.id}`);
                    alert('Fluxo deletado com sucesso.');
                    fetchFlowsForBot(selectedBotId);
                } catch (error) {
                    alert('Erro ao deletar fluxo: ' + error.response?.data?.message);
                }
            }
        };

        // --- Fun√ß√µes do React Flow ---
        const onConnect = useCallback((params) => setEdges((eds) => RF.addEdge({ ...params, type:'smoothstep', animated:true }, eds)), []);
        const onNodeClick = useCallback((_, node) => { setEditorNode(node); setShowEditor(true); }, []);

        const addNode = (type) => {
            const newNode = {
                id: `${type}_${Date.now()}`,
                type,
                position: { x: 250, y: 150 },
                data: { label: type.charAt(0).toUpperCase() + type.slice(1), text: 'Nova mensagem' }
            };
            setNodes((nds) => [...nds, newNode]);
        };

        const saveNodeEdits = (nodeId, newData) => {
            setNodes((nds) => nds.map(n => n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n));
            setShowEditor(false);
        };

        if (!isAuthenticated) {
            return <LoginScreen onLogin={handleLogin} />;
        }

        return (
            <div className="app">
                <div className="sidebar">
                    <h1>Hotbot Flow Builder</h1>
                    
                    <div className="sb-section">Configura√ß√£o</div>
                    <label>Bot Ativo</label>
                    <select className="form-input" value={selectedBotId} onChange={(e) => setSelectedBotId(e.target.value)}>
                        <option value="">Selecione um Bot</option>
                        {bots.map(bot => <option key={bot.id} value={bot.id}>{bot.bot_name}</option>)}
                    </select>
                    
                    <label>Fluxo Ativo</label>
                    <select className="form-input" value={currentFlow?.id || ''} onChange={(e) => setCurrentFlow(flows.find(f => f.id == e.target.value) || null)}>
                        <option value="">Selecione um Fluxo</option>
                        {flows.map(flow => <option key={flow.id} value={flow.id}>{flow.name}</option>)}
                    </select>
                    <div style={{display: 'flex', gap: '8px'}}>
                        <button className="btn" onClick={createNewFlow} style={{width: '100%'}}>+ Novo Fluxo</button>
                        {currentFlow && <button className="btn danger" onClick={deleteFlow}>Excluir</button>}
                    </div>

                    <div className="sb-section">Conte√∫dos</div>
                    <div style={{display:'grid', gap:8}}>
                        <div className="node-button" onClick={() => addNode('message')}>üí¨ Mensagem</div>
                        <div className="node-button" onClick={() => addNode('question')}>‚ùì Pergunta</div>
                        <div className="node-button" onClick={() => addNode('condition')}>üîÄ Condi√ß√£o</div>
                        <div className="node-button" onClick={() => addNode('action')}>‚ö° A√ß√£o</div>
                        <div className="node-button" onClick={() => addNode('generatePix')}>üí≥ Gerar PIX</div>
                    </div>
                    
                    <div className="bottom-controls">
                        <button className="btn primary" onClick={saveFlow} disabled={!currentFlow}>üíæ Salvar Fluxo</button>
                        <button className="btn" onClick={handleLogout} style={{marginTop: '8px'}}>Sair</button>
                    </div>
                </div>

                <div className="main">
                    <div className="header">
                        <h2>{currentFlow ? currentFlow.name : 'Nenhum fluxo selecionado'}</h2>
                        <div className="controls-row">
                            <div className="badge">N√≥s: {nodes.length}</div>
                        </div>
                    </div>
                    <div className="flow-wrapper">
                        <div className="reactflow-container">
                            <RF.ReactFlow nodes={nodes} edges={edges} onNodesChange={onNodesChange} onEdgesChange={onEdgesChange} onConnect={onConnect} onNodeClick={onNodeClick} nodeTypes={nodeTypes} fitView>
                                <RF.Background />
                                <RF.Controls />
                            </RF.ReactFlow>
                        </div>
                    </div>
                </div>
                
                {showEditor && editorNode && (
                    <EditorPanel node={editorNode} onSave={saveNodeEdits} onClose={() => setShowEditor(false)} />
                )}
            </div>
        );
    }
    
    // --- Componente de Login ---
    function LoginScreen({ onLogin }) {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const handleSubmit = (e) => {
            e.preventDefault();
            onLogin(email, password);
        };
        return (
            <div className="login-overlay">
                <div className="login-box">
                    <h2>Login - Hotbot</h2>
                    <form onSubmit={handleSubmit}>
                        <input className="form-input" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" required />
                        <input className="form-input" type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Senha" required />
                        <button className="btn primary" type="submit" style={{width: '100%'}}>Entrar</button>
                    </form>
                </div>
            </div>
        );
    }

    // --- Painel de Edi√ß√£o de N√≥ ---
    function EditorPanel({ node, onSave, onClose }) {
        const [data, setData] = useState(node.data);
        const handleSave = () => onSave(node.id, data);
        const updateData = (key, value) => setData(prev => ({ ...prev, [key]: value }));

        return (
            <div className="editor-panel">
                <h4>Editar: {data.label}</h4>
                <div style={{margin: '12px 0'}}>
                    <label className="small">R√≥tulo</label>
                    <input className="form-input" style={{color:'black'}} value={data.label || ''} onChange={(e) => updateData('label', e.target.value)} />

                    {node.type === 'message' && (
                        <>
                            <label className="small">Texto da Mensagem</label>
                            <textarea className="form-input" style={{color:'black', height: '100px'}} value={data.text || ''} onChange={(e) => updateData('text', e.target.value)} />
                        </>
                    )}
                    {node.type === 'generatePix' && (
                        <>
                            <label className="small">Valor (em centavos)</label>
                            <input className="form-input" style={{color:'black'}} type="number" value={data.valueInCents || 0} onChange={(e) => updateData('valueInCents', parseInt(e.target.value, 10))} />
                        </>
                    )}
                </div>
                <button className="btn primary" onClick={handleSave}>Salvar</button>
                <button className="btn" onClick={onClose} style={{marginLeft: '8px'}}>Fechar</button>
            </div>
        );
    }

    // Renderiza a aplica√ß√£o
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
        <RF.ReactFlowProvider>
            <App />
        </RF.ReactFlowProvider>
    );
  </script>
</body>
</html>
