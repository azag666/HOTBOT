<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chatbot Flow Builder - Integrado API</title>

  <!-- Tailwind (CDN dev) - ok para desenvolvimento -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / ReactDOM / Babel in-browser -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ReactFlow UMD (components + CSS) -->
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet" />
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>

  <!-- Lucide UMD (ícones) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    html,body,#root { height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    body { background:#071022; color:#e6eef8; }
    .app { display:flex; height:100vh; width:100%; overflow:hidden; }
    .sidebar { width:280px; min-width:200px; background:linear-gradient(180deg,#071225,#07172a); color:#fff; padding:18px; display:flex; flex-direction:column; gap:12px; border-right:1px solid rgba(255,255,255,0.04); }
    .sb-title { font-weight:700; font-size:18px; }
    .sb-section { font-size:12px; color:rgba(255,255,255,0.7); text-transform:uppercase; margin-top:6px; }
    .node-button { display:flex; align-items:center; gap:10px; background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; cursor:pointer; color:#e6eef8; border:1px solid rgba(255,255,255,0.02); }
    .node-button:hover { transform:translateY(-2px); }
    .main { flex:1; display:flex; flex-direction:column; min-width:0; }
    .header { padding:12px 16px; background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent); color:#fff; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center; }
    .flow-wrapper { flex:1; min-height:0; padding:12px; }
    .reactflow-container { height: calc(100% - 24px); width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#071022,#071A2B); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02); position:relative; }
    .editor-panel { position:absolute; right:12px; top:72px; width:360px; bottom:12px; background:#fff; color:#0b1220; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.35); padding:12px; overflow:auto; z-index:60; }
    .btn { padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid rgba(0,0,0,0.08); background:#fff; }
    .btn.primary { background:#4f46e5; color:#fff; border-color:transparent; }
    .badge { padding:6px 8px; border-radius:8px; background:rgba(15,23,42,0.6); color:#fff; font-size:12px; }
    @media (max-width:900px) { .sidebar { display:none; } .editor-panel{ width:100%; top:64px; right:0; left:0; } }
    /* small adjustments */
    .node-label { font-weight:700; }
    .control-row { display:flex; gap:8px; align-items:center; }
    .flows-list { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; }
    .flow-card { background:#fff; color:#0b1220; padding:12px; border-radius:8px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  (function(){ 
    const { useState, useRef, useEffect, useCallback } = React;
    const RF = window.ReactFlow;
    const icons = window.lucide;

    /* ---------- Config / Storage keys ---------- */
    const DEFAULT_API_BASE = 'https://novaapi-one.vercel.app';
    const STORAGE = {
      token: 'cb_token',
      apiBase: 'cb_api_base',
      xApiKey: 'cb_x_api_key'
    };

    /* ---------- Simple API helper ---------- */
    const Api = {
      async request(method, url, body = null, token = null, xapi = null) {
        const headers = {};
        if (token) headers['Authorization'] = `Bearer ${token}`;
        if (xapi) headers['x-api-key'] = xapi;
        if (body) headers['Content-Type'] = 'application/json';
        const opt = { method, headers };
        if (body) opt.body = JSON.stringify(body);
        const res = await fetch(url, opt);
        if (res.status === 204) return null;
        const text = await res.text();
        try { return JSON.parse(text); } catch(e) { return text; }
      },
      get(url, token, xapi) { return Api.request('GET', url, null, token, xapi); },
      post(url, body, token, xapi) { return Api.request('POST', url, body, token, xapi); },
      put(url, body, token, xapi) { return Api.request('PUT', url, body, token, xapi); },
      del(url, token, xapi) { return Api.request('DELETE', url, null, token, xapi); }
    };

    /* ---------- Node components for ReactFlow ---------- */
    const BaseNode = ({ data, children }) => (
      <div style={{ minWidth: 160, padding:10, borderRadius:8, background:'#fff', color:'#0b1220', border:'1px solid #e6e9ee', boxShadow:'0 6px 18px rgba(0,0,0,0.15)', fontSize:13 }}>
        <div style={{ fontWeight:700, marginBottom:6 }}>{data.label}</div>
        <div>{children}</div>
      </div>
    );

    function MessageNode({ id, data }) {
      const onChange = (e) => data.onChange?.(id, { text: e.target.value });
      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <textarea className="w-full p-2 border rounded" rows="3" value={data.text||''} onChange={onChange} />
          </BaseNode>
          <RF.Handle type="source" position="bottom" />
        </div>
      );
    }

    function QuestionNode({ id, data }) {
      const onChange = (e) => data.onChange?.(id, { question: e.target.value });
      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <input className="w-full p-2 border rounded" value={data.question||''} onChange={onChange} />
            <div style={{display:'flex', justifyContent:'space-between', marginTop:8}}>
              <RF.Handle type="source" position="bottom" id="yes" style={{ left: '25%' }} />
              <div className="text-xs">Sim / Não</div>
              <RF.Handle type="source" position="bottom" id="no" style={{ left: '75%' }} />
            </div>
          </BaseNode>
        </div>
      );
    }

    function ConditionNode({ id, data }) {
      const onChange = (e) => data.onChange?.(id, { condition: e.target.value });
      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <input className="w-full p-2 border rounded" value={data.condition||''} onChange={onChange} />
            <div style={{display:'flex', justifyContent:'space-between', marginTop:8}}>
              <RF.Handle type="source" position="bottom" id="true" style={{ left:'25%' }} />
              <div className="text-xs">True / False</div>
              <RF.Handle type="source" position="bottom" id="false" style={{ left:'75%' }} />
            </div>
          </BaseNode>
        </div>
      );
    }

    function ActionNode({ id, data }) {
      const onChange = (e) => data.onChange?.(id, { action: e.target.value });
      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <input className="w-full p-2 border rounded" value={data.action||''} onChange={onChange} />
          </BaseNode>
          <RF.Handle type="source" position="bottom" />
        </div>
      );
    }

    /* --- PIX node: generate via API or fallback mock --- */
    function GeneratePixNode({ id, data }) {
      const [value, setValue] = useState(data.valueInCents || 0);
      const [pix, setPix] = useState(data.lastPix || null);
      const [busy, setBusy] = useState(false);

      useEffect(()=> { setPix(data.lastPix || null); }, [data.lastPix]);

      const generate = async () => {
        setBusy(true);
        try {
          const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
          const token = localStorage.getItem(STORAGE.token) || null;
          const xapi = localStorage.getItem(STORAGE.xApiKey) || null;
          // try calling server endpoint /api/pix/generate
          const url = apiBase.replace(/\/$/,'') + '/api/pix/generate';
          // server expects: { click_id, value_cents }
          const click_id = data.click_id || '/start test'; // allow editing on node
          const resp = await Api.post(url, { click_id, value_cents: parseInt(value||0,10) }, token, xapi).catch(e => { throw e; });
          // server returns pix structure, try common fields
          const code = resp?.qr_code_text || resp?.pix_code || resp?.pixCode || resp?.transaction_id || JSON.stringify(resp).slice(0,40);
          setPix(code);
          data.onChange?.(id, { lastPix: code, valueInCents: value });
          alert('PIX gerado: ' + code);
        } catch (err) {
          // fallback mock
          const mock = 'PIX-MOCK-' + Math.random().toString(36).slice(2,8).toUpperCase();
          setPix(mock);
          data.onChange?.(id, { lastPix: mock, valueInCents: value });
          alert('PIX mock gerado (API falhou): ' + (err.message || mock));
          console.error('Erro gerar PIX:', err);
        } finally { setBusy(false); }
      };

      const copy = async () => {
        if (!pix) return alert('Nenhum PIX gerado ainda');
        try { await navigator.clipboard.writeText(pix); alert('PIX copiado'); }
        catch(e){ alert('Falha ao copiar: ' + e.message); }
      };

      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <div style={{display:'flex',gap:8,alignItems:'center', marginBottom:8}}>
              <input className="w-full p-2 border rounded" type="number" value={value} onChange={(e)=>setValue(e.target.value)} placeholder="Valor (centavos)" />
              <button className="btn" onClick={generate} disabled={busy}>{busy ? 'Gerando...' : 'Gerar'}</button>
            </div>
            <div className="text-xs mb-2">{data.messageTemplate || 'Mensagem: {{pix_code}}'}</div>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <div style={{fontWeight:700}}>{pix || '—'}</div>
              <button className="btn" onClick={copy} disabled={!pix}>Copiar</button>
            </div>
            <div style={{marginTop:8}}>
              <label className="text-xs">Click ID</label>
              <input className="w-full p-1 border rounded mt-1" value={data.click_id||''} onChange={(e)=>data.onChange?.(id, { click_id: e.target.value })} placeholder="/start yourclick"/>
            </div>
          </BaseNode>
          <RF.Handle type="source" position="bottom" />
        </div>
      );
    }

    /* --- Query Pix Status node --- */
    function QueryPixStatusNode({ id, data }) {
      const [status, setStatus] = useState({ code: data.code || null, status: data.status || 'unknown' });

      const refresh = async () => {
        const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
        const token = localStorage.getItem(STORAGE.token) || null;
        const xapi = localStorage.getItem(STORAGE.xApiKey) || null;
        const txId = data.transaction_id || status.code || data.lastPix || null;
        if (!txId) return alert('Forneça transaction_id no editor do nó.');
        try {
          const url = apiBase.replace(/\/$/,'') + '/api/pix/status/' + encodeURIComponent(txId);
          const resp = await Api.get(url, token, xapi);
          setStatus({ code: txId, status: resp?.status || (resp?.message ? resp.message : 'unknown') });
          data.onChange?.(id, { code: txId, status: resp?.status });
          alert('Status: ' + (resp?.status || 'unknown'));
        } catch (err) {
          alert('Erro consultar status: ' + (err.message || err));
          console.error(err);
        }
      };

      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <div className="text-xs">Tx: <strong>{status.code || '—'}</strong></div>
            <div className="text-xs">Status: <strong>{status.status || '—'}</strong></div>
            <div style={{marginTop:8, display:'flex', gap:8}}>
              <button className="btn" onClick={refresh}>Atualizar</button>
            </div>
            <div style={{marginTop:8}}>
              <label className="text-xs">transaction_id (opcional)</label>
              <input className="w-full p-1 border rounded mt-1" value={data.transaction_id||''} onChange={(e)=>data.onChange?.(id, { transaction_id: e.target.value })} />
            </div>
          </BaseNode>
          <RF.Handle type="source" position="bottom" />
        </div>
      );
    }

    /* --- Save Click ID node (sends to API or stores local) --- */
    function SaveClickIdNode({ id, data }) {
      const [varName, setVarName] = useState(data.variableName || 'click_id');

      const save = async () => {
        const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
        const token = localStorage.getItem(STORAGE.token) || null;
        const xapi = localStorage.getItem(STORAGE.xApiKey) || null;
        const fakeClick = 'CLICK-' + Math.floor(Math.random()*900000+10000);
        try {
          // try calling /api/clicks (if exists)
          const url = apiBase.replace(/\/$/,'') + '/api/clicks';
          await Api.post(url, { click_id: fakeClick }, token, xapi).catch(()=>{ throw new Error('API click não disponível') });
          alert('Click salvo na API: ' + fakeClick);
          data.onChange?.(id, { variableName: varName, lastSaved: fakeClick });
        } catch (err) {
          // fallback local
          localStorage.setItem('mock_click_' + varName, fakeClick);
          alert('Click salvo local: ' + fakeClick);
          data.onChange?.(id, { variableName: varName, lastSaved: fakeClick });
        }
      };

      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <div style={{display:'flex', gap:8}}>
              <input className="w-full p-2 border rounded" value={varName} onChange={(e)=>setVarName(e.target.value)} />
              <button className="btn" onClick={save}>Salvar</button>
            </div>
            <div style={{marginTop:8}} className="text-xs">Último salvo: {data.lastSaved || '—'}</div>
          </BaseNode>
          <RF.Handle type="source" position="bottom" />
        </div>
      );
    }

    /* --- Chat Live node --- */
    function ChatLiveNode({ id, data }) {
      return (
        <div>
          <RF.Handle type="target" position="top" />
          <BaseNode data={data}>
            <div className="text-xs">Operador: {data.operator || 'Atendente'}</div>
            <div style={{marginTop:8, display:'flex', gap:8}}>
              <button className="btn" onClick={()=>window.__OPEN_CHAT?.(data.operator || 'Atendente')}>Abrir Chat</button>
            </div>
            <div style={{marginTop:8}}>
              <input className="w-full p-2 border rounded" value={data.operator||''} onChange={(e)=>data.onChange?.(id, { operator: e.target.value })} placeholder="Operador"/>
            </div>
          </BaseNode>
          <RF.Handle type="source" position="bottom" />
        </div>
      );
    }

    /* Node types registry */
    const nodeTypes = {
      message: MessageNode,
      question: QuestionNode,
      condition: ConditionNode,
      action: ActionNode,
      generatePix: GeneratePixNode,
      queryPixStatus: QueryPixStatusNode,
      saveClickId: SaveClickIdNode,
      chatLive: ChatLiveNode
    };

    /* ---------- Sidebar UI ---------- */
    function BuilderSidebar({ onAdd, onExport, onRestore, onOpenSettings }) {
      return (
        <aside className="sidebar" style={{minHeight:'100%'}}>
          <div className="sb-title">Chatbot Flow Builder</div>
          <div className="sb-section">Criar nós</div>
          <div style={{display:'grid', gap:8}}>
            <div className="node-button" onClick={()=>onAdd('message')}>💬 Mensagem</div>
            <div className="node-button" onClick={()=>onAdd('question')}>❓ Pergunta</div>
            <div className="node-button" onClick={()=>onAdd('condition')}>🔀 Condição</div>
            <div className="node-button" onClick={()=>onAdd('action')}>⚡ Ação</div>
            <div className="node-button" onClick={()=>onAdd('generatePix')}>💳 Gerar PIX</div>
            <div className="node-button" onClick={()=>onAdd('queryPixStatus')}>🔎 Consultar PIX</div>
            <div className="node-button" onClick={()=>onAdd('saveClickId')}>📌 Salvar Click ID</div>
            <div className="node-button" onClick={()=>onAdd('chatLive')}>🗨️ Chat ao Vivo</div>
          </div>

          <div className="sb-section" style={{marginTop:12}}>Ações</div>
          <div style={{display:'flex', flexDirection:'column', gap:8}}>
            <button className="btn" onClick={onExport}>💾 Exportar (console)</button>
            <button className="btn" onClick={onRestore}>↩️ Restaurar Exemplo</button>
            <button className="btn" onClick={onOpenSettings}>⚙️ Configurações</button>
          </div>

          <div style={{marginTop:'auto', fontSize:12, color:'rgba(255,255,255,0.6)'}}>
            API base e chave no painel de configurações.
          </div>
        </aside>
      );
    }

    /* ---------- Editor panel (node details) ---------- */
    function NodeEditor({ node, onClose, onSave, onDelete }) {
      const [local, setLocal] = useState(JSON.parse(JSON.stringify(node)));
      useEffect(()=> setLocal(JSON.parse(JSON.stringify(node))), [node?.id]);

      const update = (patch) => setLocal(prev => ({ ...prev, data: { ...prev.data, ...patch }}));
      if (!node) return null;

      return (
        <div className="editor-panel">
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8}}>
            <div><div style={{fontWeight:800}}>{local.data.label || local.type}</div><div className="text-xs text-gray-500">ID: {local.id}</div></div>
            <div style={{display:'flex', gap:8}}>
              <button className="btn" onClick={onClose}>Fechar</button>
              <button className="btn text-red-600" onClick={()=>{ if(confirm('Excluir node?')) { onDelete(local.id); onClose(); } }}>Excluir</button>
            </div>
          </div>

          <div style={{marginBottom:8}}>
            <label className="text-xs">Rótulo</label>
            <input className="w-full p-2 border rounded" value={local.data.label||''} onChange={e=>update({ label: e.target.value })} />
          </div>

          {/* type-specific */}
          {local.type === 'generatePix' && (
            <>
              <label className="text-xs">Valor (centavos)</label>
              <input className="w-full p-2 border rounded mb-2" type="number" value={local.data.valueInCents||0} onChange={e=>update({ valueInCents: parseInt(e.target.value||0,10) })} />
              <label className="text-xs">Template</label>
              <textarea className="w-full p-2 border rounded" rows="3" value={local.data.messageTemplate||''} onChange={e=>update({ messageTemplate: e.target.value })} />
              <label className="text-xs mt-2">Click ID (ex: /start lead0001)</label>
              <input className="w-full p-2 border rounded" value={local.data.click_id||''} onChange={e=>update({ click_id: e.target.value })} />
            </>
          )}

          {local.type === 'queryPixStatus' && (
            <>
              <label className="text-xs">transaction_id (opcional)</label>
              <input className="w-full p-2 border rounded" value={local.data.transaction_id||''} onChange={e=>update({ transaction_id: e.target.value })} />
            </>
          )}

          {local.type === 'saveClickId' && (
            <>
              <label className="text-xs">Nome da variável</label>
              <input className="w-full p-2 border rounded" value={local.data.variableName||''} onChange={e=>update({ variableName: e.target.value })} />
            </>
          )}

          {local.type === 'chatLive' && (
            <>
              <label className="text-xs">Operador</label>
              <input className="w-full p-2 border rounded" value={local.data.operator||''} onChange={e=>update({ operator: e.target.value })} />
            </>
          )}

          <div style={{display:'flex', gap:8, marginTop:12}}>
            <button className="btn primary" onClick={()=>{ onSave(local.id, local.data); onClose(); }}>Salvar</button>
            <button className="btn" onClick={()=>onClose()}>Cancelar</button>
          </div>
        </div>
      );
    }

    /* ---------- Settings modal ---------- */
    function SettingsModal({ onClose }) {
      const [apiBase, setApiBase] = useState(localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE);
      const [xApiKey, setXApiKey] = useState(localStorage.getItem(STORAGE.xApiKey) || '');
      const [token, setToken] = useState(localStorage.getItem(STORAGE.token) || '');

      const save = () => {
        localStorage.setItem(STORAGE.apiBase, apiBase || '');
        localStorage.setItem(STORAGE.xApiKey, xApiKey || '');
        localStorage.setItem(STORAGE.token, token || '');
        alert('Configurações salvas.');
        onClose();
      };

      return (
        <div className="editor-panel">
          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8}}>
            <div style={{fontWeight:800}}>Configurações de Integração</div>
            <button className="btn" onClick={onClose}>Fechar</button>
          </div>

          <div className="space-y-2">
            <label className="text-xs">API Base</label>
            <input className="w-full p-2 border rounded" value={apiBase} onChange={e=>setApiBase(e.target.value)} />
            <label className="text-xs">x-api-key (usado para PIX em algumas rotas)</label>
            <input className="w-full p-2 border rounded" value={xApiKey} onChange={e=>setXApiKey(e.target.value)} />
            <label className="text-xs">Token (Bearer) - para rotas autenticadas (flows, bots)</label>
            <input className="w-full p-2 border rounded" value={token} onChange={e=>setToken(e.target.value)} />
            <div style={{display:'flex', gap:8, marginTop:8}}>
              <button className="btn primary" onClick={save}>Salvar</button>
              <button className="btn" onClick={onClose}>Cancelar</button>
            </div>
            <div className="text-xs text-gray-500 mt-2">Se sua API usa caminhos/payloads diferentes, ajuste aqui.</div>
          </div>
        </div>
      );
    }

    /* ---------- Flow Builder main component ---------- */
    function FlowBuilder({ initialFlow, onBack }) {
      const reactFlowWrapper = useRef(null);
      const [nodes, setNodes] = useState(initialFlow?.nodes?.map(n => ({ ...n, id: String(n.id) })) || [
        { id:'start', type:'message', position:{ x:50,y:50 }, data:{ label:'Início', text:'Olá! Bem-vindo.' , onChange: onNodeChange } }
      ]);
      const [edges, setEdges] = useState([]);
      const [selectedNode, setSelectedNode] = useState(null);
      const [editorNode, setEditorNode] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      const rfInstance = useRef(null);

      // helper to update node data from children
      function onNodeChange(nodeId, patch) {
        setNodes(nds => nds.map(n => n.id == nodeId ? { ...n, data:{ ...n.data, ...patch } } : n));
      }

      useEffect(()=> {
        // ensure nodes have onChange handler
        setNodes(nds => nds.map(n => ({ ...n, data: { ...n.data, onChange: onNodeChange } })));
      }, []);

      const onInit = (rfi) => { rfInstance.current = rfi; };

      const addNode = (type) => {
        const id = 'n_' + Date.now();
        const wrapper = reactFlowWrapper.current;
        const rect = wrapper ? wrapper.getBoundingClientRect() : { width:800, height:600 };
        const position = { x: rect.width/2 + Math.random()*120-60, y: rect.height/2 + Math.random()*120-60 };
        const baseData = { label: (type==='generatePix' ? 'Gerar PIX' : type.charAt(0).toUpperCase()+type.slice(1)), onChange: onNodeChange };
        let extra = {};
        if (type === 'generatePix') extra = { valueInCents:1990, messageTemplate:'✅ Seu PIX: {{pix_code}}' };
        if (type === 'saveClickId') extra = { variableName:'click_id' };
        if (type === 'chatLive') extra = { operator:'Atendente' };
        const newNode = { id, type, position, data: { ...baseData, ...extra } };
        setNodes(nds => nds.concat(newNode));
      };

      const onConnect = useCallback((params) => {
        setEdges(eds => RF.addEdge({ ...params, type:'smoothstep', animated:true, style:{ stroke:'#60a5fa', strokeWidth:2 } }, eds));
      }, []);

      const onNodeDoubleClick = (evt, node) => {
        setEditorNode(node);
      };

      const saveFlowToApi = async () => {
        try {
          const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
          const token = localStorage.getItem(STORAGE.token) || null;
          const payload = { name: initialFlow?.name || 'Fluxo salvo ' + new Date().toISOString(), nodes: nodes.map(n => ({ id: n.id, type: n.type, position: n.position, data: n.data })), edges };
          // if initialFlow has id -> PUT, else POST
          if (initialFlow && initialFlow.id) {
            const url = apiBase.replace(/\/$/,'') + '/api/flows/' + initialFlow.id;
            await Api.put(url, payload, token);
            alert('Fluxo atualizado com sucesso.');
          } else {
            const url = apiBase.replace(/\/$/,'') + '/api/flows';
            const resp = await Api.post(url, payload, token);
            alert('Fluxo criado: id ' + (resp?.id || '—'));
          }
        } catch (err) {
          console.error(err);
          alert('Erro ao salvar fluxo: ' + (err.message || err));
        }
      };

      const exportFlow = () => {
        console.log({ nodes, edges });
        alert('Fluxo exportado no console (F12).');
      };

      const restoreDemo = () => {
        setNodes([
          { id:'start', type:'message', position:{x:50,y:80}, data:{ label:'Início', text:'Olá' , onChange: onNodeChange } },
          { id:'m1', type:'message', position:{x:300,y:80}, data:{ label:'Mensagem', text:'Bem-vindo', onChange:onNodeChange } },
          { id:'pix1', type:'generatePix', position:{x:300,y:230}, data:{ label:'Gerar PIX', valueInCents:1990, messageTemplate:'Seu PIX {{pix_code}}', onChange:onNodeChange } }
        ]);
        setEdges([{ id:'e1', source:'start', target:'m1', type:'smoothstep' }, { id:'e2', source:'m1', target:'pix1', type:'smoothstep' }]);
      };

      const deleteNode = (nodeId) => {
        setNodes(nds => nds.filter(n => n.id !== nodeId));
        setEdges(eds => eds.filter(e => e.source !== nodeId && e.target !== nodeId));
        setEditorNode(null);
      };

      return (
        <div style={{display:'flex', height:'100%'}}>
          <BuilderSidebar 
            onAdd={addNode}
            onExport={exportFlow}
            onRestore={restoreDemo}
            onOpenSettings={()=>setShowSettings(true)}
          />

          <div className="main" style={{flex:1}}>
            <div className="header">
              <div style={{fontWeight:700}}>Construtor de Fluxo — Chatbot</div>
              <div style={{display:'flex', gap:8, alignItems:'center'}}>
                <div className="badge">Nós: {nodes.length}</div>
                <button className="btn" onClick={exportFlow}>Exportar</button>
                <button className="btn" onClick={saveFlowToApi}>Salvar na API</button>
                <button className="btn" onClick={()=>alert('Dica: clique duas vezes num nó para abrir o editor.')}>Ajuda</button>
              </div>
            </div>

            <div className="flow-wrapper" ref={reactFlowWrapper}>
              <div className="reactflow-container">
                <RF.ReactFlow
                  nodes={nodes}
                  edges={edges}
                  onNodesChange={(changes)=>{}}
                  onEdgesChange={(changes)=>{}}
                  onConnect={onConnect}
                  onInit={onInit}
                  nodeTypes={nodeTypes}
                  onNodeDoubleClick={onNodeDoubleClick}
                  fitView
                  style={{ width:'100%', height:'100%' }}
                >
                  <RF.Background gap={16} color="#0f172a" />
                  <RF.Controls />
                  <RF.MiniMap nodeColor={(n)=> {
                    switch(n.type){ case 'message': return '#10b981'; case 'generatePix': return '#16a34a'; default: return '#888'; }
                  }} />
                </RF.ReactFlow>
              </div>
            </div>
          </div>

          { editorNode && (
            <NodeEditor
              node={editorNode}
              onClose={()=>setEditorNode(null)}
              onSave={(id, newData) => setNodes(nds => nds.map(n => n.id === id ? { ...n, data: { ...n.data, ...newData } } : n))}
              onDelete={(id)=>deleteNode(id)}
            />
          )}

          { showSettings && <SettingsModal onClose={()=>setShowSettings(false)} /> }

        </div>
      );
    }

    /* ---------- Top-level App: login, list flows, open builder ---------- */
    function AppRoot() {
      const [token, setToken] = useState(localStorage.getItem(STORAGE.token) || '');
      const [isLoading, setIsLoading] = useState(false);
      const [bots, setBots] = useState([]);
      const [flows, setFlows] = useState([]);
      const [editingFlow, setEditingFlow] = useState(null);

      useEffect(()=> {
        if (!token) return;
        setIsLoading(true);
        (async()=>{
          try {
            const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
            const botsResp = await Api.get(apiBase.replace(/\/$/,'') + '/api/bots', token).catch(()=>[]);
            const flowsResp = await Api.get(apiBase.replace(/\/$/,'') + '/api/flows', token).catch(()=>[]);
            setBots(botsResp || []);
            setFlows((flowsResp||[]).map(f => ({ ...f, nodes: typeof f.nodes === 'string' ? JSON.parse(f.nodes) : f.nodes })));
          } catch (err) {
            console.error('Erro carregar bots/flows', err);
          } finally { setIsLoading(false); }
        })();
      }, [token]);

      const handleLogin = async (tokenValue) => {
        localStorage.setItem(STORAGE.token, tokenValue || '');
        setToken(tokenValue || '');
      };

      const handleLogout = () => {
        localStorage.removeItem(STORAGE.token);
        setToken('');
        setBots([]);
        setFlows([]);
      };

      if (!token) return <LoginScreen onLogin={handleLogin} />;

      if (isLoading) return <div className="flex h-full items-center justify-center">Carregando...</div>;

      if (editingFlow) {
        return <FlowBuilder initialFlow={editingFlow} onBack={()=>setEditingFlow(null)} />;
      }

      return (
        <div style={{display:'flex', height:'100%'}}>
          <nav style={{width:80, background:'#071225', color:'#fff', display:'flex', flexDirection:'column', alignItems:'center', paddingTop:20, gap:16}}>
            <div style={{fontSize:22, fontWeight:700}}>Bot</div>
            <button className="btn" onClick={()=>setEditingFlow(flows[0] || null)}>Editar Fluxo (ex)</button>
            <button className="btn" onClick={handleLogout}>Sair</button>
          </nav>

          <main style={{flex:1, padding:20, overflow:'auto'}}>
            <h1 style={{color:'#fff', marginBottom:12}}>Seus Fluxos</h1>

            <div style={{display:'flex', gap:8, marginBottom:12}}>
              <button className="btn" onClick={async ()=>{
                // create minimal flow
                const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
                const token = localStorage.getItem(STORAGE.token) || null;
                if (!token) return alert('Defina token nas configurações.');
                const botId = bots[0]?.id;
                if (!botId) return alert('Nenhum bot cadastrado.');
                try {
                  const resp = await Api.post(apiBase.replace(/\/$/,'') + '/api/flows', { name: 'Novo Fluxo', botId }, token);
                  if (resp?.id) {
                    setFlows(prev => [ { ...resp, nodes: typeof resp.nodes === 'string' ? JSON.parse(resp.nodes) : resp.nodes }, ...prev ]);
                    alert('Fluxo criado: ' + resp.id);
                  } else alert('Criado (sem id retornado).');
                } catch (err) { console.error(err); alert('Erro criar fluxo: ' + (err.message||err)); }
              }}>Criar Fluxo</button>
              <button className="btn" onClick={()=>{ localStorage.removeItem(STORAGE.apiBase); localStorage.removeItem(STORAGE.xApiKey); localStorage.removeItem(STORAGE.token); alert('Configs limpas.'); }}>Limpar Configs</button>
            </div>

            <div className="flows-list">
              {flows.map(f => (
                <div key={f.id} className="flow-card">
                  <div style={{fontWeight:700}}>{f.name}</div>
                  <div className="text-xs text-gray-600">{(f.nodes||[]).length} nós</div>
                  <div style={{display:'flex', gap:8, marginTop:8}}>
                    <button className="btn" onClick={()=>setEditingFlow(f)}>Editar</button>
                    <button className="btn" onClick={async ()=>{ if(confirm('Excluir?')) { const apiBase = localStorage.getItem(STORAGE.apiBase)||DEFAULT_API_BASE; const token = localStorage.getItem(STORAGE.token)||null; await Api.del(apiBase.replace(/\/$/,'') + '/api/flows/' + f.id, token).catch(()=>{}); setFlows(prev=>prev.filter(x=>x.id!==f.id)); } }}>Excluir</button>
                  </div>
                </div>
              ))}
            </div>

          </main>
        </div>
      );
    }

    /* ---------- Login Screen ---------- */
    function LoginScreen({ onLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const submit = async (e) => {
        e?.preventDefault();
        setLoading(true);
        try {
          const apiBase = localStorage.getItem(STORAGE.apiBase) || DEFAULT_API_BASE;
          const res = await fetch(apiBase.replace(/\/$/,'') + '/api/sellers/login', {
            method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ email, password })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'Erro login');
          onLogin(data.token);
        } catch (err) {
          alert('Erro login: ' + (err.message || err));
        } finally { setLoading(false); }
      };

      return (
        <div style={{display:'flex',height:'100%',alignItems:'center',justifyContent:'center'}}>
          <form onSubmit={submit} style={{background:'#fff', color:'#0b1220', padding:20, borderRadius:8, width:380}}>
            <h2 style={{fontWeight:700, marginBottom:12}}>Entrar</h2>
            <input className="w-full p-2 border mb-2" placeholder="email" value={email} onChange={e=>setEmail(e.target.value)} />
            <input type="password" className="w-full p-2 border mb-4" placeholder="senha" value={password} onChange={e=>setPassword(e.target.value)} />
            <div style={{display:'flex', gap:8}}>
              <button className="btn primary" disabled={loading}>{loading ? 'Entrando...' : 'Entrar'}</button>
              <button type="button" className="btn" onClick={()=>{ localStorage.setItem(STORAGE.apiBase, DEFAULT_API_BASE); alert('API base setada para ' + DEFAULT_API_BASE); }}>Default API</button>
            </div>
          </form>
        </div>
      );
    }

    /* ---------- Render ---------- */
    ReactDOM.createRoot(document.getElementById('root')).render(<AppRoot />);
  })();
  </script>
</body>
</html>
