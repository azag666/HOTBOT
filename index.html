<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hotbot - Plataforma de Gest√£o</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">

  <style>
    :root { --bg-dark: #0f172a; --bg-light: #1e293b; --border-color: #334155; --text-light: #f1f5f9; --text-dark: #94a3b8; --primary: #6366f1; --danger: #ef4444; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body,#root { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    body { background: var(--bg-dark); color: var(--text-light); }
    .app-container { display: flex; height: 100vh; }
    .sidebar { width: 240px; background: var(--bg-light); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; }
    .sidebar h1 { font-size: 1.25rem; margin-bottom: 2rem; }
    .nav-menu { display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-item { padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 500; transition: background 0.2s; }
    .nav-item:hover { background: var(--border-color); }
    .nav-item.active { background: var(--primary); color: white; }
    .sidebar .logout-btn { margin-top: auto; background: var(--danger); }
    .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
    .page-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; }
    .card { background: var(--bg-light); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-light); font-size: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: bold; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--border-color); color: white; }
    .btn-sm { padding: 0.5rem 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .flow-card { display: flex; flex-direction: column; justify-content: space-between; height: 150px; }
    .flow-card h3 { font-size: 1.1rem; }
    .bot-item, .user-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
    .chat-layout { display: flex; height: calc(100vh - 8rem); }
    .user-list { width: 300px; border-right: 1px solid var(--border-color); overflow-y: auto; }
    .chat-window { flex: 1; display: flex; flex-direction: column; }
    .message-list { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column;}
    .message { background: var(--bg-light); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; max-width: 80%; }
    .message.operator { align-self: flex-end; background: var(--primary); }
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
    .login-box { background: var(--bg-light); padding: 2rem; border-radius: 0.5rem; width: 360px; }
    
    /* --- Flow Editor Styles --- */
    .flow-editor-container { display: flex; height: 100%; width: 100%; }
    .flow-editor-page { display: flex; flex-direction: column; flex-grow: 1; height: 100%; }
    .flow-header { padding: 0.75rem; background: var(--bg-light); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
    .reactflow-wrapper { flex-grow: 1; position: relative; }
    .flow-sidebar { width: 250px; background: var(--bg-light); border-right: 1px solid var(--border-color); padding: 1rem; }
    .flow-sidebar h3 { margin-bottom: 1rem; }
    .node-button { padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed var(--border-color); text-align: center; cursor: grab; margin-bottom: 0.5rem; }
    .editor-panel { position: absolute; top: 0; right: 0; width: 300px; height: 100%; background: var(--bg-light); z-index: 10; padding: 1rem; border-left: 1px solid var(--border-color); overflow-y: auto; }
    
    /* Custom Node Styles */
    .react-flow__node { border-radius: 8px; font-size: 14px; border: 2px solid; }
    .react-flow__node-message { background: #dcfce7; border-color: #4ade80; }
    .react-flow__node-question { background: #ffedd5; border-color: #fb923c; }
    .react-flow__node-condition { background: #dbeafe; border-color: #60a5fa; }
    .react-flow__node-pix { background: #fef9c3; border-color: #facc15; }
    .react-flow__handle { width: 8px; height: 8px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef, memo } = React;
    const { ReactFlow, useNodesState, useEdgesState, addEdge, Background, Controls, Handle, Position } = window.ReactFlow;
    const API_BASE_URL = 'https://novaapi-one.vercel.app/api';

    const api = axios.create({ baseURL: API_BASE_URL });
    api.interceptors.request.use(config => {
      const token = localStorage.getItem('authToken');
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });

    // --- Main App Component (Router) ---
    function App() {
      const [isAuthenticated, setIsAuthenticated] = useState(!!localStorage.getItem('authToken'));
      const [currentPage, setCurrentPage] = useState('bots');
      const [editingFlow, setEditingFlow] = useState(null);

      const handleLogin = (token) => {
        localStorage.setItem('authToken', token);
        setIsAuthenticated(true);
      };

      const handleLogout = () => {
        localStorage.removeItem('authToken');
        setIsAuthenticated(false);
      };

      const navigateToFlowEditor = (flow) => {
        setEditingFlow(flow);
        setCurrentPage('flow-editor');
      };

      if (!isAuthenticated) return <LoginScreen onLogin={handleLogin} />;

      return (
        <div className="app-container">
          {currentPage !== 'flow-editor' && <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} onLogout={handleLogout} />}
          <main className={currentPage !== 'flow-editor' ? "main-content" : ''} style={{padding: currentPage === 'flow-editor' ? 0 : '2rem'}}>
            {currentPage === 'bots' && <BotsPage />}
            {currentPage === 'flows' && <FlowsListPage onEditFlow={navigateToFlowEditor} />}
            {currentPage === 'chat' && <LiveChatPage />}
            {currentPage === 'disparos' && <DisparosPage />}
            {currentPage === 'flow-editor' && <FlowEditorPage flow={editingFlow} onBack={() => setCurrentPage('flows')} />}
          </main>
        </div>
      );
    }
    
    // --- Components for Each Page ---
    function Sidebar({ currentPage, setCurrentPage, onLogout }) { /* ... no changes ... */ }
    function BotsPage() { /* ... no changes ... */ }
    function FlowsListPage({ onEditFlow }) { /* ... no changes ... */ }
    function DisparosPage() { /* ... no changes ... */ }
    function LiveChatPage() { /* ... no changes ... */ }
    
    // --- Flow Editor ---
    const initialNodes = [{ id: '1', type: 'message', position: { x: 100, y: 100 }, data: { label: 'In√≠cio', text: 'Bem-vindo!' } }];
    const nodeTypes = {
        message: memo(({ data }) => (
            <>
                <Handle type="target" position={Position.Top} />
                <div><strong>üí¨ Mensagem</strong></div>
                <p style={{color: '#333'}}>{data.text || 'Clique para editar'}</p>
                <Handle type="source" position={Position.Bottom} />
            </>
        )),
        question: memo(({ data }) => (
            <>
                <Handle type="target" position={Position.Top} />
                <div><strong>‚ùì Pergunta</strong></div>
                <p style={{color: '#333'}}>{data.text || 'Clique para editar'}</p>
                <Handle type="source" id="yes" position={Position.Bottom} style={{ left: '25%' }} />
                <Handle type="source" id="no" position={Position.Bottom} style={{ left: '75%' }} />
            </>
        )),
        condition: memo(({ data }) => (
            <>
                <Handle type="target" position={Position.Top} />
                <div><strong>üîÄ Condi√ß√£o</strong></div>
                <p style={{color: '#333'}}>{data.condition || 'Clique para editar'}</p>
                <Handle type="source" id="true" position={Position.Bottom} style={{ left: '25%' }} />
                <Handle type="source" id="false" position={Position.Bottom} style={{ left: '75%' }} />
            </>
        )),
        pix: memo(({ data }) => (
            <>
                <Handle type="target" position={Position.Top} />
                <div><strong>üí≥ Gerar PIX</strong></div>
                <p style={{color: '#333'}}>Valor: R$ {(data.valueInCents / 100).toFixed(2) || '0.00'}</p>
                <Handle type="source" position={Position.Bottom} />
            </>
        )),
    };
    
    function FlowEditorPage({ flow, onBack }) {
      const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
      const [edges, setEdges, onEdgesChange] = useEdgesState([]);
      const [selectedNode, setSelectedNode] = useState(null);
      
      useEffect(() => {
        if(flow && flow.nodes) {
            const flowContent = typeof flow.nodes === 'string' ? JSON.parse(flow.nodes) : flow.nodes;
            setNodes(flowContent.nodes || initialNodes);
            setEdges(flowContent.edges || []);
        }
      }, [flow]);

      const onConnect = useCallback((params) => setEdges((eds) => addEdge({ ...params, animated: true }, eds)), []);
      const onNodeClick = useCallback((_, node) => setSelectedNode(node), []);
      
      const onDragOver = useCallback((event) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
      }, []);
      
      const onDrop = useCallback((event) => {
          event.preventDefault();
          const type = event.dataTransfer.getData('application/reactflow');
          if (typeof type === 'undefined' || !type) return;
          
          const position = { x: event.clientX - 250, y: event.clientY - 50 }; // Adjust for sidebar/header
          const newNode = {
              id: `${type}-${Date.now()}`,
              type,
              position,
              data: { label: type },
          };
          setNodes((nds) => nds.concat(newNode));
      }, [setNodes]);

      const handleSave = async () => {
          try {
              await api.put(`/flows/${flow.id}`, { name: flow.name, nodes: JSON.stringify({ nodes, edges }) });
              alert("Fluxo salvo com sucesso!");
          } catch(error) { alert("Erro ao salvar o fluxo."); }
      };

      if (!flow) return <div>Carregando fluxo...</div>;

      return (
        <div className="flow-editor-container">
          <div className="flow-sidebar">
            <h3>N√≥s</h3>
            <div className="node-button" onDragStart={(e) => e.dataTransfer.setData('application/reactflow', 'message')} draggable>üí¨ Mensagem</div>
            <div className="node-button" onDragStart={(e) => e.dataTransfer.setData('application/reactflow', 'question')} draggable>‚ùì Pergunta</div>
            <div className="node-button" onDragStart={(e) => e.dataTransfer.setData('application/reactflow', 'condition')} draggable>üîÄ Condi√ß√£o</div>
            <div className="node-button" onDragStart={(e) => e.dataTransfer.setData('application/reactflow', 'pix')} draggable>üí≥ Gerar PIX</div>
          </div>
          <div className="flow-editor-page">
            <div className="flow-header">
              <h3>Editando: {flow.name}</h3>
              <div>
                <button className="btn btn-secondary" style={{ marginRight: '0.5rem' }} onClick={onBack}>Voltar</button>
                <button className="btn btn-primary" onClick={handleSave}>Salvar Fluxo</button>
              </div>
            </div>
            <div className="reactflow-wrapper" onDrop={onDrop} onDragOver={onDragOver}>
                <ReactFlow nodes={nodes} edges={edges} onNodesChange={onNodesChange} onEdgesChange={onEdgesChange} onConnect={onConnect} onNodeClick={onNodeClick} nodeTypes={nodeTypes} fitView>
                    <Background />
                    <Controls />
                </ReactFlow>
                {selectedNode && <EditorPanel selectedNode={selectedNode} setNodes={setNodes} setSelectedNode={setSelectedNode} />}
            </div>
          </div>
        </div>
      );
    }

    function EditorPanel({ selectedNode, setNodes, setSelectedNode }) {
        const [nodeData, setNodeData] = useState(selectedNode.data);
        
        useEffect(() => { setNodeData(selectedNode.data) }, [selectedNode]);

        const handleChange = (e) => {
            const { name, value } = e.target;
            setNodeData(prev => ({...prev, [name]: name === 'valueInCents' ? parseInt(value) : value }));
        };

        const onSave = () => {
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? {...n, data: nodeData} : n));
            setSelectedNode(null);
        };

        return (
            <div className="editor-panel">
                <h3 style={{marginBottom: '1rem'}}>Editar N√≥: {selectedNode.data.label}</h3>
                <div className="form-group">
                    <label>R√≥tulo</label>
                    <input name="label" className="form-input" value={nodeData.label || ''} onChange={handleChange} />
                </div>

                {selectedNode.type === 'message' && (
                    <div className="form-group">
                        <label>Texto</label>
                        <textarea name="text" className="form-textarea" value={nodeData.text || ''} onChange={handleChange} />
                    </div>
                )}
                {selectedNode.type === 'question' && (
                    <div className="form-group">
                        <label>Texto da Pergunta</label>
                        <textarea name="text" className="form-textarea" value={nodeData.text || ''} onChange={handleChange} />
                    </div>
                )}
                {selectedNode.type === 'condition' && (
                    <div className="form-group">
                        <label>Condi√ß√£o (ex: `{"{variable}"}` == "valor")</label>
                        <input name="condition" className="form-input" value={nodeData.condition || ''} onChange={handleChange} />
                    </div>
                )}
                {selectedNode.type === 'pix' && (
                    <div className="form-group">
                        <label>Valor em Centavos</label>
                        <input name="valueInCents" type="number" className="form-input" value={nodeData.valueInCents || 0} onChange={handleChange} />
                    </div>
                )}
                
                <button className="btn btn-primary" onClick={onSave}>Salvar</button>
                <button className="btn btn-secondary" style={{marginLeft: '0.5rem'}} onClick={() => setSelectedNode(null)}>Fechar</button>
            </div>
        )
    }
    
    function LoginScreen({ onLogin }) { /* ... no changes ... */ }

    // --- Render App ---
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);


    // --- PASTE THE HIDDEN COMPONENTS HERE ---
    const hiddenComps = { Sidebar, BotsPage, FlowsListPage, DisparosPage, LiveChatPage, LoginScreen };
    for (const Comp in hiddenComps) {
        if (window[Comp]) continue;
        window[Comp] = hiddenComps[Comp];
    }
    
  </script>
</body>
</html>
