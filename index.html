<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Plataforma de Automação para Telegram</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bg-dots {
      background-size: 40px 40px;
      background-image: radial-gradient(circle,#e5e7eb 1px,rgba(0,0,0,0) 1px);
    }
    .editor-panel {
      animation: slideIn 0.3s ease-out forwards;
    }
    @keyframes slideIn { from {transform: translateX(100%);} to {transform: translateX(0);} }
    html,body,#root { height:100%; margin:0; }
  </style>
</head>
<body class="bg-gray-100 h-full">
  <div id="root" class="h-full"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState,useEffect } = React;
    const { BotMessageSquare,GitBranchPlus,MessageCircle,Send,LogOut,Settings } = lucide;

    const API_BASE_URL = 'https://novaapi-one.vercel.app';
    const api = {
      async get(endpoint, token) {
        const res = await fetch(`${API_BASE_URL}/api/platform${endpoint}`, {headers:{Authorization:`Bearer ${token}`}});
        if(!res.ok) throw new Error('Erro GET');
        return res.json();
      },
      async post(endpoint, body, token) {
        const res = await fetch(`${API_BASE_URL}/api/platform${endpoint}`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
          body: JSON.stringify(body)
        });
        if(!res.ok) throw new Error('Erro POST');
        return res.json();
      },
      async put(endpoint, body, token) {
        const res = await fetch(`${API_BASE_URL}/api/platform${endpoint}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
          body: JSON.stringify(body)
        });
        if(!res.ok) throw new Error('Erro PUT');
        return res.json();
      },
      async delete(endpoint, token) {
        const res = await fetch(`${API_BASE_URL}/api/platform${endpoint}`, {
          method:'DELETE',
          headers:{Authorization:`Bearer ${token}`}
        });
        if(!res.ok) throw new Error('Erro DELETE');
        return res;
      }
    };

    const LoginView = ({onLogin}) => {
      const [email,setEmail] = useState(''), [password,setPassword] = useState('');
      const handleSubmit = async e => {
        e.preventDefault();
        const res = await fetch(`${API_BASE_URL}/api/sellers/login`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email,password})
        });
        const data = await res.json();
        if(res.ok){ onLogin(data.token); } else { alert(data.message||'Erro login'); }
      };
      return (
        <div className="flex items-center justify-center h-full bg-gray-100">
          <form onSubmit={handleSubmit} className="p-6 bg-white rounded shadow w-80">
            <h1 className="text-xl mb-4 font-bold">Login</h1>
            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full border mb-2 p-2"/>
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Senha" className="w-full border mb-4 p-2"/>
            <button className="w-full bg-indigo-600 text-white p-2 rounded">Entrar</button>
          </form>
        </div>
      );
    };

    const MainNavItem = ({icon,label,isActive,onClick}) => (
      <button onClick={onClick}
        className={`flex flex-col items-center justify-center w-full h-16 ${isActive?'bg-gray-700 text-white':'text-gray-400 hover:bg-gray-700 hover:text-white'}`}>
        {React.createElement(icon,{size:22})}
        <span className="text-xs">{label}</span>
      </button>
    );

    const App = () => {
      const [token,setToken] = useState(localStorage.getItem('authToken'));
      const [activeTab,setActiveTab] = useState('flows');
      const [bots,setBots] = useState([]), [flows,setFlows] = useState([]);
      const [isLoading,setIsLoading] = useState(!!token);

      useEffect(()=>{
        if(token){
          (async()=>{
            try {
              const [botsData,flowsData] = await Promise.all([
                api.get('/bots',token),
                api.get('/flows',token)
              ]);
              setBots(botsData);
              setFlows(flowsData.map(f=>({...f,nodes:typeof f.nodes==='string'?JSON.parse(f.nodes):f.nodes})));
            }catch(e){ console.error(e); handleLogout(); }
            finally{ setIsLoading(false); }
          })();
        }
      },[token]);

      const handleLogin = t => {localStorage.setItem('authToken',t); setToken(t);};
      const handleLogout = ()=>{localStorage.removeItem('authToken'); setToken(null);};

      if(!token) return <LoginView onLogin={handleLogin}/>;
      if(isLoading) return <div className="flex h-full items-center justify-center">Carregando...</div>;

      return (
        <div className="flex h-full">
          <nav className="w-20 bg-gray-800 text-white flex flex-col items-center">
            <BotMessageSquare size={28} className="text-indigo-400 mt-4"/>
            <MainNavItem icon={Settings} label="Config" isActive={activeTab==='settings'} onClick={()=>setActiveTab('settings')}/>
            <MainNavItem icon={GitBranchPlus} label="Fluxos" isActive={activeTab==='flows'} onClick={()=>setActiveTab('flows')}/>
            <MainNavItem icon={MessageCircle} label="Chat" isActive={activeTab==='livechat'} onClick={()=>setActiveTab('livechat')}/>
            <MainNavItem icon={Send} label="Disparos" isActive={activeTab==='broadcasts'} onClick={()=>setActiveTab('broadcasts')}/>
            <div className="mt-auto mb-4"><MainNavItem icon={LogOut} label="Sair" onClick={handleLogout}/></div>
          </nav>
          <div className="flex-1 overflow-auto p-6">
            {activeTab==='settings' && <div>Configurações (em construção)</div>}
            {activeTab==='flows' && <div>Fluxos (renderize seu builder aqui)</div>}
            {activeTab==='livechat' && <div>Chat ao vivo (em construção)</div>}
            {activeTab==='broadcasts' && <div>Disparos (em construção)</div>}
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
