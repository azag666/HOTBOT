<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot Flow Builder - Integrado API</title>

  <!-- Tailwind (CDN) apenas para utilitários rápidos + estilos base -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM + Babel + ReactFlow (UMD) + Lucide -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>

  <style>
    /* layout básico */
    html,body,#root { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    body { background: #0f172a; color: #0f172a; }

    .app { display:flex; height:100vh; width:100%; overflow:hidden; }
    /* sidebar */
    .sidebar { width:280px; min-width:200px; background:linear-gradient(180deg,#0b1220,#0f172a); color:#fff; padding:18px; display:flex; flex-direction:column; gap:12px; border-right:1px solid rgba(255,255,255,0.04); }
    .sb-title { font-weight:700; font-size:16px; }
    .sb-section { font-size:12px; color:rgba(255,255,255,0.72); text-transform:uppercase; letter-spacing:0.6px; margin-top:6px; }
    .node-button { display:flex; align-items:center; gap:10px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03); padding:10px; border-radius:10px; cursor:pointer; color:#fff; }
    .node-button:hover { transform: translateY(-2px); }
    .sidebar .bottom { margin-top:auto; font-size:12px; color:rgba(255,255,255,0.6); }

    /* main */
    .main { flex:1; display:flex; flex-direction:column; min-width:0; }
    .header { padding:12px 16px; background:linear-gradient(90deg, rgba(255,255,255,0.03), transparent); color:#fff; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center; }
    .flow-wrapper { flex:1; min-height:0; padding:12px; }
    .reactflow-container { height: calc(100% - 24px); width:100%; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#071022,#071A2B); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02); }

    /* custom nodes */
    .custom-node { min-width:180px; padding:10px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.4); font-size:13px; border:1px solid #e6e9ee; background:#fff; }
    .node-msg { background:linear-gradient(180deg,#ecfccb,#ddf7d6); border-color:#86efac; }
    .node-q { background:linear-gradient(180deg,#ffedd5,#fff1e0); border-color:#fdba74; }
    .node-condition { background:linear-gradient(180deg,#fee2e2,#fff2f2); border-color:#fca5a5; }
    .node-action { background:linear-gradient(180deg,#dbeafe,#e6f0ff); border-color:#93c5fd; }
    .node-pix { background:linear-gradient(180deg,#ecfccb,#d9f7e0); border-color:#4ade80; }
    .node-status { background:linear-gradient(180deg,#eef2ff,#f0f7ff); border-color:#a78bfa; }
    .node-click { background:linear-gradient(180deg,#fff7ed,#fff8e6); border-color:#f59e0b; }
    .node-live { background:linear-gradient(180deg,#f0f9ff,#ecfeff); border-color:#60a5fa; }

    /* editor panel */
    .editor-panel { position:absolute; right:12px; top:72px; width:360px; bottom:12px; background:#fff; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.4); padding:12px; overflow:auto; z-index:60; }

    /* chat modal */
    .chat-modal { position:fixed; right:20px; bottom:20px; width:360px; height:420px; background:#fff; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.45); z-index:70; display:flex; flex-direction:column; overflow:hidden; }
    .chat-body { flex:1; padding:12px; overflow:auto; background:#f7fafc; }
    .chat-input-row { display:flex; gap:8px; padding:12px; border-top:1px solid #eee; }

    /* small helpers */
    .btn { padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid rgba(0,0,0,0.08); background:#fff; }
    .btn.primary { background:#4f46e5; color:#fff; border-color:transparent; }
    .badge { padding:6px 8px; border-radius:8px; background:rgba(15,23,42,0.6); color:#fff; font-size:12px; }
    @media (max-width:900px){ .sidebar{ display:none; } .editor-panel{ width:100%; top:64px; right:0; left:0; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useRef, useEffect, useCallback } = React;
  const RF = window.ReactFlow;
  const icons = lucide;

  /* ---------------------------
     Config & API helper
     --------------------------- */
  const DEFAULT_API_BASE = 'https://novaapi-one.vercel.app';
  const STORAGE_KEYS = {
    token: 'cb_token',
    apiBase: 'cb_api_base',
    pixCreatePath: 'cb_pix_create',
    pixStatusPath: 'cb_pix_status',
    clickSavePath: 'cb_click_save'
  };

  const ApiHelper = {
    async get(path, token) {
      const res = await fetch(path, { method:'GET', headers: token ? { Authorization:`Bearer ${token}` } : {} });
      if(!res.ok) throw await res.json().catch(()=>new Error('GET failed'));
      return res.json();
    },
    async post(path, body, token) {
      const res = await fetch(path, {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...(token ? { Authorization:`Bearer ${token}` } : {}) },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw await res.json().catch(()=>new Error('POST failed'));
      return res.json();
    },
    async put(path, body, token) {
      const res = await fetch(path, {
        method:'PUT',
        headers: { 'Content-Type':'application/json', ...(token ? { Authorization:`Bearer ${token}` } : {}) },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw await res.json().catch(()=>new Error('PUT failed'));
      return res.json();
    }
  };

  /* ---------------------------
     Mock PIX fallback (if user doesn't configure endpoint)
     --------------------------- */
  function generatePixMock(valueInCents) {
    const ts = Date.now().toString().slice(-6);
    const rnd = Math.floor(Math.random()*9000)+1000;
    return `PIX-${ts}-${rnd}`;
  }
  const GlobalMock = { lastPix: null, status: 'pending', clickIds: {} };

  /* ---------------------------
     Initial demo nodes & edges
     --------------------------- */
  const demoNodes = [
    { id: 'start', type: 'message', position:{ x: 50, y: 50 }, data:{ label:'Início', text:'Olá! Bem-vindo.' } },
    { id: 'msg1', type: 'message', position:{ x: 300, y: 40 }, data:{ label:'Mensagem', text:'Exemplo' } },
    { id: 'pix1', type: 'generatePix', position:{ x: 300, y: 180 }, data:{ label:'Gerar PIX', valueInCents:1990, messageTemplate:'✅ Seu PIX: {{pix_code}}' } },
    { id: 'status1', type: 'queryPixStatus', position:{ x: 650, y: 180 }, data:{ label:'Consultar PIX' } },
    { id: 'click1', type: 'saveClickId', position:{ x: 300, y: 320 }, data:{ label:'Salvar Click ID', variableName:'click_id' } },
    { id: 'live1', type: 'chatLive', position:{ x: 650, y: 320 }, data:{ label:'Chat', operator:'Atendente' } },
  ];
  const demoEdges = [
    { id:'e1', source:'start', target:'msg1', type:'smoothstep', animated:true },
    { id:'e2', source:'msg1', target:'pix1', type:'smoothstep', animated:true },
    { id:'e3', source:'pix1', target:'status1', type:'smoothstep', animated:true },
  ];

  /* ---------------------------
     Custom Nodes
     --------------------------- */
  const BaseNode = ({ data, selected, children, variant }) => {
    const cls = `custom-node ${variant || ''}`;
    return (
      <div className={cls}>
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:6}}>
          <div style={{fontWeight:700}}>{data.label || 'Node'}</div>
          {selected && <div style={{fontSize:12, opacity:0.7}}>Selecionado</div>}
        </div>
        <div>{children}</div>
      </div>
    );
  };

  function MessageNode({ id, data, selected }) {
    const onChange = (e) => data.onChange?.(id, { text: e.target.value });
    return (
      <BaseNode data={data} selected={selected} variant="node-msg">
        <RF.Handle type="target" position="top" />
        <input className="w-full p-2 border rounded mb-2" value={data.text||''} onChange={onChange} placeholder="Mensagem..." />
        <RF.Handle type="source" position="bottom" />
      </BaseNode>
    );
  }

  function QuestionNode({ id, data, selected }) {
    const onChange = (e) => data.onChange?.(id, { question: e.target.value });
    return (
      <BaseNode data={data} selected={selected} variant="node-q">
        <RF.Handle type="target" position="top" />
        <input className="w-full p-2 border rounded mb-2" value={data.question||''} onChange={onChange} placeholder="Pergunta..." />
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <RF.Handle type="source" position="bottom" id="yes" style={{left:'25%'}} />
          <div className="text-xs">Sim / Não</div>
          <RF.Handle type="source" position="bottom" id="no" style={{left:'75%'}} />
        </div>
      </BaseNode>
    );
  }

  function ConditionNode({ id, data, selected }) {
    const onChange = (e) => data.onChange?.(id, { condition:e.target.value });
    return (
      <BaseNode data={data} selected={selected} variant="node-condition">
        <RF.Handle type="target" position="top" />
        <input className="w-full p-2 border rounded mb-2" value={data.condition||''} onChange={onChange} placeholder="Condição (ex: {{var}} == 'x')" />
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <RF.Handle type="source" position="bottom" id="true" style={{left:'25%'}} />
          <div className="text-xs">Verdadeiro / Falso</div>
          <RF.Handle type="source" position="bottom" id="false" style={{left:'75%'}} />
        </div>
      </BaseNode>
    );
  }

  function ActionNode({ id, data, selected }) {
    const onChange = (e) => data.onChange?.(id, { action:e.target.value });
    return (
      <BaseNode data={data} selected={selected} variant="node-action">
        <RF.Handle type="target" position="top" />
        <input className="w-full p-2 border rounded mb-2" value={data.action||''} onChange={onChange} placeholder="Ação..." />
        <RF.Handle type="source" position="bottom" />
      </BaseNode>
    );
  }

  /* --- Generate PIX node — integrated with configurable API --- */
  function GeneratePixNode({ id, data, selected, ctx }) {
    const [value, setValue] = useState(data.valueInCents || 0);
    const [pixCode, setPixCode] = useState(data.lastPixCode || null);
    const [busy, setBusy] = useState(false);

    useEffect(()=> {
      setPixCode(data.lastPixCode || GlobalMock.lastPix);
    }, [data.lastPixCode]);

    const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE;
    const pixCreatePath = localStorage.getItem(STORAGE_KEYS.pixCreatePath) || '';

    const generate = async () => {
      setBusy(true);
      try {
        if (pixCreatePath) {
          // try calling provided endpoint
          const full = (pixCreatePath.startsWith('http') ? pixCreatePath : (apiBase.replace(/\/$/, '') + '/' + pixCreatePath.replace(/^\//, '')));
          const payload = { valueInCents: value, flowNodeId: id };
          // token if exists
          const token = localStorage.getItem(STORAGE_KEYS.token);
          const resp = await ApiHelper.post(full, payload, token).catch(e=>{ throw e; });
          // expecting resp.pixCode or similar
          const code = resp?.pixCode || resp?.code || resp?.id || JSON.stringify(resp).slice(0,40);
          setPixCode(code);
          data.onChange?.(id, { lastPixCode: code, valueInCents: value });
          alert('PIX gerado via API: ' + code);
        } else {
          // fallback mock
          const code = generatePixMock(value);
          GlobalMock.lastPix = code; GlobalMock.status = 'pending';
          setPixCode(code);
          data.onChange?.(id, { lastPixCode: code, valueInCents: value });
          alert('PIX gerado (mock): ' + code);
        }
      } catch (err) {
        console.error('Erro gerar PIX', err);
        alert('Erro ao gerar PIX: ' + (err.message || err));
      } finally { setBusy(false); }
    };

    const copy = async () => {
      if (!pixCode) return alert('Nenhum PIX gerado ainda.');
      try { await navigator.clipboard.writeText(pixCode); alert('PIX copiado'); }
      catch(e){ alert('Falha ao copiar: ' + e.message); }
    };

    return (
      <BaseNode data={data} selected={selected} variant="node-pix">
        <RF.Handle type="target" position="top" />
        <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:8}}>
          <input className="w-full p-2 border rounded" type="number" value={value} onChange={e=>setValue(parseInt(e.target.value||0,10))} placeholder="Valor em centavos" />
          <button className="btn" onClick={generate} disabled={busy}>{busy ? 'Gerando...' : 'Gerar'}</button>
        </div>
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          <div className="text-xs" style={{flex:1}}>{data.messageTemplate || 'Mensagem: {{pix_code}}'}</div>
        </div>
        <div style={{marginTop:8,display:'flex',gap:8,alignItems:'center'}}>
          <div className="text-xs">Código:</div>
          <div style={{flex:1,fontWeight:700}}>{pixCode || '—'}</div>
          <button className="btn" onClick={copy} disabled={!pixCode}>Copiar</button>
        </div>
        <RF.Handle type="source" position="bottom" />
      </BaseNode>
    );
  }

  /* --- Query Pix Status node --- */
  function QueryPixStatusNode({ id, data, selected }) {
    const [status, setStatus] = useState(()=> ({ code: GlobalMock.lastPix, status: GlobalMock.status }));
    const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE;
    const pixStatusPath = localStorage.getItem(STORAGE_KEYS.pixStatusPath) || '';

    const refresh = async () => {
      try {
        if (pixStatusPath) {
          const full = (pixStatusPath.startsWith('http') ? pixStatusPath : (apiBase.replace(/\/$/, '') + '/' + pixStatusPath.replace(/^\//, '')));
          const token = localStorage.getItem(STORAGE_KEYS.token);
          const resp = await ApiHelper.post(full, { sourceNodeId: data.sourceNodeId || null }, token).catch(e=>{ throw e; });
          const st = resp?.status || resp?.pixStatus || 'unknown';
          const code = resp?.pixCode || resp?.code || GlobalMock.lastPix;
          setStatus({ code, status: st });
        } else {
          setStatus({ code: GlobalMock.lastPix, status: GlobalMock.status });
          alert('Usando simulador local para status PIX.');
        }
      } catch (err) {
        console.error('Erro status PIX', err);
        alert('Erro ao consultar status PIX: ' + (err.message || err));
      }
    };

    return (
      <BaseNode data={data} selected={selected} variant="node-status">
        <RF.Handle type="target" position="top" />
        <div className="text-xs">Último PIX: <strong>{status.code || '—'}</strong></div>
        <div className="text-xs">Status: <strong>{status.status || '—'}</strong></div>
        <div style={{marginTop:8,display:'flex',gap:8}}>
          <button className="btn" onClick={refresh}>Atualizar</button>
          <button className="btn" onClick={()=>{ if(status.status==='paid') alert('Já pago'); else alert('Simulador: pendente. Use configurações para marcar pago.') }}>Checar</button>
        </div>
        <RF.Handle type="source" position="bottom" />
      </BaseNode>
    );
  }

  /* --- Save ClickId node --- */
  function SaveClickIdNode({ id, data, selected }) {
    const [varName, setVarName] = useState(data.variableName || 'click_id');
    const clickSavePath = localStorage.getItem(STORAGE_KEYS.clickSavePath) || '';
    const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE;
    const token = localStorage.getItem(STORAGE_KEYS.token);

    const save = async () => {
      const fakeClick = 'CLICK-' + Math.floor(Math.random()*90000+10000);
      try {
        if (clickSavePath) {
          const full = (clickSavePath.startsWith('http') ? clickSavePath : (apiBase.replace(/\/$/, '') + '/' + clickSavePath.replace(/^\//, '')));
          await ApiHelper.post(full, { variableName: varName, value: fakeClick }, token);
          alert('ClickId enviado para API: ' + fakeClick);
        } else {
          GlobalMock.clickIds[varName] = fakeClick;
          alert('ClickId salvo local: ' + fakeClick);
        }
        data.onChange?.(id, { variableName: varName, lastSaved: fakeClick });
      } catch (err) {
        console.error('Erro salvar click', err);
        alert('Erro ao salvar ClickId: ' + (err.message||err));
      }
    };

    return (
      <BaseNode data={data} selected={selected} variant="node-click">
        <RF.Handle type="target" position="top" />
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          <input className="w-full p-2 border rounded" value={varName} onChange={e=>setVarName(e.target.value)} />
          <button className="btn" onClick={save}>Salvar</button>
        </div>
        <div style={{marginTop:8}} className="text-xs">Último salvo: {data.lastSaved || '—'}</div>
        <RF.Handle type="source" position="bottom" />
      </BaseNode>
    );
  }

  /* --- Chat Live (opens modal) --- */
  function ChatLiveNode({ id, data, selected }) {
    return (
      <BaseNode data={data} selected={selected} variant="node-live">
        <RF.Handle type="target" position="top" />
        <div className="text-xs">Operador: {data.operator || 'Atendente'}</div>
        <div style={{marginTop:8,display:'flex',gap:8}}>
          <button className="btn" onClick={()=>window.__OPEN_CHAT?.(data.operator || 'Atendente')}>Abrir Chat</button>
          <button className="btn" onClick={()=>alert('Simulação: notificar operador')}>Notificar</button>
        </div>
        <RF.Handle type="source" position="bottom" />
      </BaseNode>
    );
  }

  const nodeTypes = {
    message: MessageNode,
    question: QuestionNode,
    condition: ConditionNode,
    action: ActionNode,
    generatePix: GeneratePixNode,
    queryPixStatus: QueryPixStatusNode,
    saveClickId: SaveClickIdNode,
    chatLive: ChatLiveNode
  };

  /* ---------------------------
     Sidebar & Editor Components
     --------------------------- */
  const Sidebar = ({ addNode, exportFlow, restoreDemo, simulatePixPaid, openSettings }) => (
    <aside className="sidebar">
      <div className="sb-title">Chatbot Flow Builder</div>
      <div className="sb-section">Criar Nós</div>
      <div style={{display:'grid',gap:8}}>
        <div className="node-button" onClick={()=>addNode('message')}>💬 Mensagem</div>
        <div className="node-button" onClick={()=>addNode('question')}>❓ Pergunta</div>
        <div className="node-button" onClick={()=>addNode('condition')}>🔀 Condição</div>
        <div className="node-button" onClick={()=>addNode('action')}>⚡ Ação</div>
        <div className="node-button" onClick={()=>addNode('generatePix')}>💳 Gerar PIX</div>
        <div className="node-button" onClick={()=>addNode('queryPixStatus')}>🔎 Consultar Status PIX</div>
        <div className="node-button" onClick={()=>addNode('saveClickId')}>📌 Salvar Click ID</div>
        <div className="node-button" onClick={()=>addNode('chatLive')}>🗨️ Chat ao Vivo</div>
      </div>

      <div className="sb-section">Ações</div>
      <div style={{display:'flex',flexDirection:'column',gap:8}}>
        <button className="btn" onClick={exportFlow}>💾 Salvar Fluxo (console)</button>
        <button className="btn" onClick={restoreDemo}>↩️ Restaurar Exemplo</button>
        <button className="btn" onClick={simulatePixPaid}>✅ Marcar último PIX como PAGO (sim)</button>
        <button className="btn" onClick={openSettings}>⚙️ Configurações API</button>
      </div>

      <div className="bottom">
        <div className="text-xs">Integração configurável — insira endpoints em Configurações.</div>
      </div>
    </aside>
  );

  const EditorPanel = ({ node, allFlows, onClose, onSave, onDelete }) => {
    const [local, setLocal] = useState(JSON.parse(JSON.stringify(node)));
    useEffect(()=> setLocal(JSON.parse(JSON.stringify(node))), [node]);

    const save = () => { onSave(local.id, local.data); onClose(); };
    const update = (patch) => setLocal(prev => ({ ...prev, data: { ...prev.data, ...patch }}));

    const renderContent = () => {
      switch(local.type) {
        case 'generatePix': return (
          <>
            <label className="text-xs">Valor (centavos)</label>
            <input className="w-full p-2 border rounded mb-2" type="number" value={local.data.valueInCents||0} onChange={e=>update({ valueInCents: parseInt(e.target.value||0,10) })} />
            <label className="text-xs">Template</label>
            <textarea className="w-full p-2 border rounded mb-2" rows="3" value={local.data.messageTemplate||''} onChange={e=>update({ messageTemplate: e.target.value })}></textarea>
          </>
        );
        case 'saveClickId': return (
          <>
            <label className="text-xs">Nome da variável</label>
            <input className="w-full p-2 border rounded mb-2" value={local.data.variableName||''} onChange={e=>update({ variableName: e.target.value })} />
          </>
        );
        case 'queryPixStatus': return (
          <>
            <label className="text-xs">Node origem (opcional)</label>
            <input className="w-full p-2 border rounded mb-2" value={local.data.sourceNodeId||''} onChange={e=>update({ sourceNodeId: e.target.value })} placeholder="ex: pix1" />
            <div className="text-xs text-gray-500">Se vazio, consulta o último PIX global (simulador ou API configurada).</div>
          </>
        );
        case 'chatLive': return (
          <>
            <label className="text-xs">Operador</label>
            <input className="w-full p-2 border rounded mb-2" value={local.data.operator||''} onChange={e=>update({ operator: e.target.value })} />
          </>
        );
        default:
          return <div className="text-xs">Tipo: {local.type}</div>;
      }
    };

    return (
      <div className="editor-panel">
        <div className="flex justify-between items-center mb-3">
          <div>
            <div style={{fontWeight:800}}>{local.data.label}</div>
            <div className="text-xs text-gray-500">{local.type} — ID: {local.id}</div>
          </div>
          <div style={{display:'flex',gap:8}}>
            <button className="btn" onClick={()=>{ onClose(); }}>Fechar</button>
            <button className="btn text-red-600" onClick={()=>{ if(confirm('Excluir node?')) { onDelete(local.id); onClose(); } }}>Excluir</button>
          </div>
        </div>

        <div className="mb-3">
          <label className="text-xs">Rótulo</label>
          <input className="w-full p-2 border rounded mb-2" value={local.data.label||''} onChange={e=>setLocal({...local, data:{...local.data, label:e.target.value}})} />
        </div>

        {renderContent()}

        <div className="flex gap-2 mt-4">
          <button className="btn primary" onClick={save}>Salvar</button>
          <button className="btn" onClick={()=>onClose()}>Cancelar</button>
        </div>
      </div>
    );
  };

  /* ---------------------------
     Settings Panel
     --------------------------- */
  const SettingsModal = ({ onClose }) => {
    const [apiBase,setApiBase] = useState(localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE);
    const [pixCreatePath,setPixCreatePath] = useState(localStorage.getItem(STORAGE_KEYS.pixCreatePath) || '');
    const [pixStatusPath,setPixStatusPath] = useState(localStorage.getItem(STORAGE_KEYS.pixStatusPath) || '');
    const [clickSavePath,setClickSavePath] = useState(localStorage.getItem(STORAGE_KEYS.clickSavePath) || '');
    const [token,setToken] = useState(localStorage.getItem(STORAGE_KEYS.token) || '');

    const save = () => {
      localStorage.setItem(STORAGE_KEYS.apiBase, apiBase || '');
      localStorage.setItem(STORAGE_KEYS.pixCreatePath, pixCreatePath || '');
      localStorage.setItem(STORAGE_KEYS.pixStatusPath, pixStatusPath || '');
      localStorage.setItem(STORAGE_KEYS.clickSavePath, clickSavePath || '');
      localStorage.setItem(STORAGE_KEYS.token, token || '');
      alert('Configurações salvas.');
      onClose();
    };

    return (
      <div className="editor-panel">
        <div className="flex justify-between items-center mb-3">
          <div><div style={{fontWeight:800}}>Configurações de Integração</div></div>
          <button className="btn" onClick={onClose}>Fechar</button>
        </div>

        <div className="space-y-2">
          <label className="text-xs">API Base</label>
          <input className="w-full p-2 border rounded" value={apiBase} onChange={e=>setApiBase(e.target.value)} />
          <label className="text-xs">Endpoint gerar PIX (relativo ou URL)</label>
          <input className="w-full p-2 border rounded" value={pixCreatePath} onChange={e=>setPixCreatePath(e.target.value)} placeholder="/api/platform/pix/create" />
          <label className="text-xs">Endpoint status PIX</label>
          <input className="w-full p-2 border rounded" value={pixStatusPath} onChange={e=>setPixStatusPath(e.target.value)} placeholder="/api/platform/pix/status" />
          <label className="text-xs">Endpoint salvar Click ID</label>
          <input className="w-full p-2 border rounded" value={clickSavePath} onChange={e=>setClickSavePath(e.target.value)} placeholder="/api/platform/clicks" />
          <label className="text-xs">Token (Bearer)</label>
          <input className="w-full p-2 border rounded" value={token} onChange={e=>setToken(e.target.value)} placeholder="seu-token-aqui" />
          <div className="flex gap-2 mt-3">
            <button className="btn primary" onClick={save}>Salvar</button>
            <button className="btn" onClick={onClose}>Cancelar</button>
          </div>
          <div className="text-xs text-gray-500 mt-2">Dica: se sua API usa caminhos diferentes, insira o caminho completo (ex.: https://...). Se deixar em branco, o builder usará mocks locais.</div>
        </div>
      </div>
    );
  };

  /* ---------------------------
     Connections renderer (SVG) - kept from original builder
     --------------------------- */
  const Connections = ({ nodes, connectionPreview }) => {
    Connections.getOutputYOffset = (node, outputId) => {
      if (node.type === 'contentBlock' && node.replySettings?.awaitsReply) {
          return outputId === 'onTimeout' ? 55 : 85;
      }
      if ((node.outputs || []).length > 1) {
          return outputId === 'success' || outputId === 'paid' ? 55 : 85;
      }
      return 45;
    };

    return (
      <svg className="absolute w-full h-full pointer-events-none overflow-visible">
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#9ca3af" />
          </marker>
          <marker id="arrow-red" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#f87171" />
          </marker>
          <marker id="arrow-green" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#4ade80" />
          </marker>
        </defs>
        <g>
          {(nodes || []).map(node => {
            let connections = [];
            if (node.type === 'contentBlock' && node.replySettings?.awaitsReply) {
              if(node.replySettings.onReplyNextStepId) connections.push({ id: 'onReply', nextStepId: node.replySettings.onReplyNextStepId });
              if(node.replySettings.onTimeoutNextStepId) connections.push({ id: 'onTimeout', nextStepId: node.replySettings.onTimeoutNextStepId });
            } else {
              connections = node.outputs || [];
            }

            return (connections || []).map(output => {
              if (!output.nextStepId) return null;
              const targetNode = nodes.find(n => n.id === output.nextStepId);
              if (!targetNode) return null;

              const yOffset = Connections.getOutputYOffset(node, output.id);
              const isTimeout = output.id === 'onTimeout';
              const isSuccess = output.id === 'onReply';

              let strokeColor = "#9ca3af";
              let marker = "url(#arrow)";

              if(isTimeout) { strokeColor = "#f87171"; marker = "url(#arrow-red)"; }
              else if(isSuccess) { strokeColor = "#4ade80"; marker = "url(#arrow-green)"; }

              const startPos = { x: node.position.x + 288, y: node.position.y + yOffset };
              const endPos   = { x: targetNode.position.x, y: targetNode.position.y + 45 };
              const path = `M ${startPos.x} ${startPos.y} C ${startPos.x + 60} ${startPos.y}, ${endPos.x - 60} ${endPos.y}, ${endPos.x} ${endPos.y}`;

              return <path key={`${node.id}-${output.id}`} d={path} stroke={strokeColor} strokeWidth="2" fill="none" markerEnd={marker} strokeDasharray={isTimeout ? "5 5" : "none"} />;
            });
          })}

          {connectionPreview && (
            <path
              d={`M ${connectionPreview.startPos.x} ${connectionPreview.startPos.y} C ${connectionPreview.startPos.x + 60} ${connectionPreview.startPos.y}, ${connectionPreview.endPos.x - 60} ${connectionPreview.endPos.y}, ${connectionPreview.endPos.x} ${connectionPreview.endPos.y}`}
              stroke="#6366f1" strokeWidth="2" strokeDasharray="5 5" fill="none"
            />
          )}
        </g>
      </svg>
    );
  };

  /* ---------------------------
     Main Flow Builder App
     --------------------------- */
  function FlowBuilder({ initialFlow, allFlowsFromAPI, onSaveFlowToAPI, onBack }) {
    const [nodes, setNodes] = useState((initialFlow && initialFlow.nodes) ? initialFlow.nodes : demoNodes);
    const [edges, setEdges] = useState(demoEdges);
    const [selectedNode, setSelectedNode] = useState(null);
    const [editorNode, setEditorNode] = useState(null);
    const [showEditor, setShowEditor] = useState(false);
    const [showSettings, setShowSettings] = useState(false);
    const [chatOpen, setChatOpen] = useState(false);
    const [chatMessages, setChatMessages] = useState([]);
    const reactFlowWrapperRef = useRef(null);
    const rfInstanceRef = useRef(null);

    useEffect(()=> {
      window.__OPEN_CHAT = (operator) => {
        setChatOpen(true);
        setChatMessages(prev => [...prev, { from:'system', text: `Conectado a ${operator}` }]);
      };
    }, []);

    const onNodesChange = useCallback((changes) => {
      setNodes((nds) => {
        // apply simple changes if needed (React Flow has its own useNodesState in UMD; we mimic)
        return nds;
      });
    }, []);

    const onEdgesChange = useCallback((changes) => {
      setEdges((eds)=> eds);
    }, []);

    const onConnect = useCallback((params) => {
      setEdges((eds) => RF.addEdge({ ...params, type:'smoothstep', animated:true, style:{ stroke:'#60a5fa', strokeWidth:2 } }, eds));
    }, []);

    const onInit = useCallback((rfi) => { rfInstanceRef.current = rfi; }, []);

    const addNode = (type) => {
      const id = `n_${Date.now()}_${Math.floor(Math.random()*999)}`;
      const wrapper = reactFlowWrapperRef.current;
      const rect = wrapper ? wrapper.getBoundingClientRect() : { width:800, height:600 };
      const newNode = {
        id,
        type,
        position: { x: rect.width/2 + Math.random()*120 - 60, y: rect.height/2 + Math.random()*120 - 60 },
        data: {
          label: type==='generatePix' ? 'Gerar PIX' : type==='queryPixStatus' ? 'Consultar PIX' : type==='saveClickId' ? 'Salvar Click ID' : type.charAt(0).toUpperCase()+type.slice(1),
          onChange: (nodeId, partial) => setNodes(nds => nds.map(n => n.id === nodeId ? { ...n, data:{ ...n.data, ...partial }} : n))
        }
      };

      if (type === 'generatePix') newNode.data = { ...newNode.data, valueInCents:1990, messageTemplate:'✅ Seu PIX {{pix_code}}', onChange: newNode.data.onChange };
      if (type === 'queryPixStatus') newNode.data = { ...newNode.data, sourceNodeId: null, onChange: newNode.data.onChange };
      if (type === 'saveClickId') newNode.data = { ...newNode.data, variableName:'click_id', lastSaved:null, onChange: newNode.data.onChange };
      if (type === 'chatLive') newNode.data = { ...newNode.data, operator:'Atendente', onChange: newNode.data.onChange };

      setNodes(nds => nds.concat(newNode));
    };

    const deleteNode = (nodeId) => {
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds => eds.filter(e => e.source !== nodeId && e.target !== nodeId));
      setShowEditor(false);
    };

    const clearFlow = () => { setNodes([]); setEdges([]); setShowEditor(false); };

    const exportFlow = () => {
      const flow = { nodes, edges, meta: { createdAt: new Date().toISOString() } };
      console.log('Flow exportado:', flow);
      alert('Flow exportado no console (F12).');
    };

    const restoreDemo = () => { setNodes(demoNodes); setEdges(demoEdges); };

    const simulatePixPaid = () => { GlobalMock.status = 'paid'; alert('Simulador: último PIX marcado como PAGO. Use consulta de status no nó.'); };

    const saveNodeEdits = (nodeId, newData) => {
      setNodes(nds => nds.map(n => n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n));
      setShowEditor(false);
    };

    const openEditor = (node) => { setEditorNode(node); setShowEditor(true); setSelectedNode(node); };

    const onNodeClick = (evt, node) => openEditor(node);

    // Save entire flow to your API (via props)
    const saveFlowToApi = async () => {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.token);
        const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE;
        // If there's an onSaveFlowToAPI prop (from parent) prefer it, else try /api/platform/flows
        const payload = { name: 'Fluxo salvo ' + new Date().toISOString(), nodes, edges };
        // Try default flows endpoint
        const full = apiBase.replace(/\/$/, '') + '/api/platform/flows';
        const resp = await ApiHelper.post(full, payload, token).catch(e=>{ throw e; });
        alert('Fluxo salvo na API (criado): id ' + (resp?.id || '(sem id)'));
      } catch (err) {
        console.error('Erro salvar fluxo API', err);
        alert('Erro ao salvar fluxo na API: ' + (err.message || err));
      }
    };

    // rendering
    return (
      <div style={{display:'flex',height:'100%'}}>
        <Sidebar
          addNode={addNode}
          exportFlow={exportFlow}
          restoreDemo={restoreDemo}
          simulatePixPaid={simulatePixPaid}
          openSettings={()=>setShowSettings(true)}
        />

        <div className="main">
          <div className="header">
            <div style={{fontWeight:700,color:'#fff'}}>Construtor de Fluxo — Chatbot</div>
            <div style={{display:'flex',gap:8,alignItems:'center'}}>
              <div className="badge">Nós: {nodes.length}</div>
              <button className="btn" onClick={exportFlow}>Exportar</button>
              <button className="btn" onClick={saveFlowToApi}>Salvar na API</button>
              <button className="btn" onClick={()=>alert('Dica: clique num nó para editar suas configurações.')}>Ajuda</button>
            </div>
          </div>

          <div className="flow-wrapper" ref={reactFlowWrapperRef}>
            <div className="reactflow-container" style={{height:'100%'}}>
              <RF.ReactFlow
                nodes={nodes}
                edges={edges}
                onNodesChange={onNodesChange}
                onEdgesChange={onEdgesChange}
                onConnect={onConnect}
                onInit={onInit}
                onNodeClick={onNodeClick}
                nodeTypes={nodeTypes}
                fitView
                attributionPosition="bottom-left"
                style={{ width:'100%', height:'100%' }}
              >
                <RF.Background gap={16} color="#94a3b8" />
                <RF.Controls />
                <RF.MiniMap nodeColor={(n) => {
                  switch(n.type) {
                    case 'message': return '#10b981';
                    case 'question': return '#f59e0b';
                    case 'condition': return '#ef4444';
                    case 'action': return '#3b82f6';
                    case 'generatePix': return '#16a34a';
                    default: return '#888';
                  }
                }} />
              </RF.ReactFlow>

              {/* SVG connections overlay for advanced wiring (kept for visualization parity) */}
              <div style={{position:'absolute', inset:0, pointerEvents:'none'}}>
                <Connections nodes={nodes} />
              </div>
            </div>
          </div>
        </div>

        {/* Editor Modal */}
        { showEditor && editorNode && (
          <EditorPanel
            node={editorNode}
            allFlows={allFlowsFromAPI || []}
            onClose={()=>setShowEditor(false)}
            onSave={saveNodeEdits}
            onDelete={(id)=>deleteNode(id)}
          />
        )}

        {/* Settings */}
        { showSettings && <SettingsModal onClose={() => setShowSettings(false)} /> }

        {/* Chat modal */}
        { chatOpen && (
          <div className="chat-modal">
            <div style={{padding:12,borderBottom:'1px solid #eee',fontWeight:700}}>Chat ao Vivo</div>
            <div className="chat-body">
              {chatMessages.map((m,i)=>(
                <div key={i} style={{marginBottom:8, display:'flex', justifyContent: m.from==='you'?'flex-end':'flex-start' }}>
                  <div style={{background: m.from==='you' ? '#4f46e5' : '#e6f0ff', color: m.from==='you' ? '#fff' : '#0b1220', padding:8, borderRadius:8, maxWidth:'75%'}}>
                    <div style={{fontSize:13}}>{m.text}</div>
                    <div style={{fontSize:10, opacity:0.6, marginTop:6}}>{m.from}</div>
                  </div>
                </div>
              ))}
            </div>
            <div className="chat-input-row">
              <input id="chat-input" className="w-full p-2 border rounded" placeholder="Digite sua mensagem..." />
              <button className="btn primary" onClick={()=>{
                const el = document.getElementById('chat-input'); const txt = el.value.trim(); if(!txt) return;
                setChatMessages(prev => [...prev, { from:'you', text:txt }]);
                setTimeout(()=> setChatMessages(prev => [...prev, { from:'op', text: 'Operador: Recebi — ' + txt }]), 500);
                el.value = '';
              }}>Enviar</button>
              <button className="btn" onClick={()=>{ setChatOpen(false); setChatMessages([]); }}>Fechar</button>
            </div>
          </div>
        )}

      </div>
    );
  }

  /* ---------------------------
     Top-level App: login, fetch flows/bots, route to builder
     --------------------------- */
  function AppRoot() {
    const [token, setToken] = useState(localStorage.getItem(STORAGE_KEYS.token) || '');
    const [isLoading, setIsLoading] = useState(false);
    const [bots, setBots] = useState([]);
    const [flows, setFlows] = useState([]);
    const [editingFlowId, setEditingFlowId] = useState(null);

    useEffect(()=> {
      if (!token) return;
      setIsLoading(true);
      (async ()=>{
        try {
          const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE;
          const tok = token;
          // fetch bots & flows
          const botsResp = await ApiHelper.get(apiBase.replace(/\/$/,'') + '/api/platform/bots', tok).catch(()=>[]);
          const flowsResp = await ApiHelper.get(apiBase.replace(/\/$/,'') + '/api/platform/flows', tok).catch(()=>[]);
          setBots(botsResp || []);
          setFlows((flowsResp || []).map(f => ({ ...f, nodes: typeof f.nodes === 'string' ? JSON.parse(f.nodes) : f.nodes })));
        } catch (err) {
          console.error('Erro buscar bots/flows', err);
        } finally { setIsLoading(false); }
      })();
    }, [token]);

    const handleLogin = (tok) => { localStorage.setItem(STORAGE_KEYS.token, tok); setToken(tok); };
    const handleLogout = () => { localStorage.removeItem(STORAGE_KEYS.token); setToken(''); setBots([]); setFlows([]); };

    if (!token) return <LoginScreen onLogin={handleLogin} />;

    if (isLoading) return <div className="flex h-full items-center justify-center">Carregando...</div>;

    // If user selected to edit a flow, open builder; else list flows
    if (editingFlowId) {
      const flow = flows.find(f => f.id === editingFlowId);
      if (!flow) { setEditingFlowId(null); return null; }
      const flowsForBot = flows.filter(f => f.botId === flow.botId);
      return <FlowBuilder initialFlow={flow} allFlowsFromAPI={flowsForBot} onSaveFlowToAPI={() => {}} onBack={()=>setEditingFlowId(null)} />;
    }

    return (
      <div style={{display:'flex', height:'100%'}}>
        <nav style={{width:80, background:'#0b1220', color:'#fff', display:'flex', flexDirection:'column', alignItems:'center', paddingTop:20, gap:16}}>
          <div style={{fontSize:22, fontWeight:700}}>Bot</div>
          <button className="btn" onClick={()=>setEditingFlowId(flows[0]?.id || null)}>Editar Fluxo (exemplo)</button>
          <button className="btn" onClick={handleLogout}>Sair</button>
        </nav>

        <main style={{flex:1, padding:20, overflow:'auto'}}>
          <h1 style={{color:'#fff', marginBottom:12}}>Seus Fluxos</h1>
          <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))', gap:12}}>
            {flows.map(f => (
              <div key={f.id} style={{background:'#fff', padding:12, borderRadius:8}}>
                <div style={{fontWeight:700}}>{f.name}</div>
                <div className="text-xs text-gray-500">{(f.nodes||[]).length} nós</div>
                <div style={{display:'flex', gap:8, marginTop:8}}>
                  <button className="btn" onClick={()=>setEditingFlowId(f.id)}>Editar</button>
                  <button className="btn" onClick={async ()=>{ if(confirm('Excluir?')) { await ApiHelper.delete((localStorage.getItem(STORAGE_KEYS.apiBase)||DEFAULT_API_BASE).replace(/\/$/,'') + '/api/platform/flows/' + f.id, token).catch(()=>{}); setFlows(prev => prev.filter(x=>x.id!==f.id)); } }}>Excluir</button>
                </div>
              </div>
            ))}
          </div>
        </main>
      </div>
    );
  }

  /* ---------------------------
     Login Screen
     --------------------------- */
  function LoginScreen({ onLogin }) {
    const [email,setEmail] = useState(''), [password,setPassword] = useState('');
    const [loading,setLoading] = useState(false);
    const submit = async (e) => {
      e.preventDefault();
      setLoading(true);
      try {
        const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || DEFAULT_API_BASE;
        const res = await fetch(apiBase.replace(/\/$/,'') + '/api/sellers/login', {
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Erro login');
        onLogin(data.token);
      } catch (err) { alert('Erro login: ' + (err.message || err)); }
      finally { setLoading(false); }
    };

    return (
      <div style={{display:'flex',height:'100%',alignItems:'center',justifyContent:'center'}}>
        <form onSubmit={submit} style={{background:'#fff', padding:20, borderRadius:8, width:360}}>
          <h2 style={{fontWeight:700, marginBottom:12}}>Entrar</h2>
          <input className="w-full p-2 border mb-2" placeholder="email" value={email} onChange={e=>setEmail(e.target.value)} />
          <input type="password" className="w-full p-2 border mb-4" placeholder="senha" value={password} onChange={e=>setPassword(e.target.value)} />
          <div style={{display:'flex', gap:8}}>
            <button className="btn primary" disabled={loading}>{loading ? 'Entrando...' : 'Entrar'}</button>
            <button type="button" className="btn" onClick={()=>{ localStorage.setItem(STORAGE_KEYS.apiBase, DEFAULT_API_BASE); alert('API base setada para ' + DEFAULT_API_BASE); }}>Default API</button>
          </div>
        </form>
      </div>
    );
  }

  /* ---------------------------
     Render root
     --------------------------- */
  ReactDOM.createRoot(document.getElementById('root')).render(<AppRoot />);
  </script>
</body>
</html>
