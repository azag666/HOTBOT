<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hotbot - Plataforma de Gestão Avançada</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
        --bg-primary: #111111;
        --bg-secondary: #1A1A1A;
        --bg-tertiary: #242424;
        --border-color: #2D2D2D;
        --text-primary: #E5E5E5;
        --text-secondary: #A3A3A3;
        --brand-primary: #00F5A0;
        --brand-secondary: #00B372;
        --danger-bg: #441C24;
        --danger-text: #F87171;
        --danger-border: #7f1d1d;
        --danger-hover-bg: #7f1d1d;
        --danger-hover-text: white;
        --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body,#root { height: 100%; font-family: var(--font-sans); }
    body { background: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    
    /* Scrollbar */
    * { scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-primary); }
    *::-webkit-scrollbar { width: 8px; }
    *::-webkit-scrollbar-track { background: var(--bg-primary); }
    *::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; border: 2px solid var(--bg-primary); }

    /* Layout Principal */
    .app-container { display: flex; height: 100vh; }
    .main-content {
        flex: 1; padding: 2rem 3rem; overflow-y: auto;
        background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
        background-size: 2rem 2rem;
    }
    .page-container { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Sidebar */
    .sidebar { width: 80px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 1.5rem 0; display: flex; flex-direction: column; align-items: center; transition: width 0.3s ease-in-out; }
    .sidebar:hover { width: 240px; }
    .sidebar .logo { font-size: 1.8rem; margin-bottom: 3.5rem; color: var(--text-primary); font-weight: 800; letter-spacing: 1px; }
    .sidebar .logo span { color: var(--brand-primary); }
    .sidebar .logo .logo-text { opacity: 0; transition: opacity 0.3s ease-in-out; }
    .sidebar:hover .logo .logo-text { opacity: 1; }
    .nav-menu { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; }
    .nav-item { display: flex; align-items: center; justify-content: flex-start; gap: 1rem; padding: 1rem 1.75rem; cursor: pointer; transition: all 0.2s ease-in-out; border-left: 4px solid transparent; color: var(--text-secondary); }
    .nav-item:hover { background: linear-gradient(90deg, rgba(0, 245, 160, 0.1), transparent); color: var(--text-primary); }
    .nav-item.active { color: var(--brand-primary); border-left: 4px solid var(--brand-primary); }
    .nav-item .nav-text { opacity: 0; white-space: nowrap; transform: translateX(-10px); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; font-weight: 600; }
    .sidebar:hover .nav-text { opacity: 1; transform: translateX(0); }
    .nav-item svg { min-width: 24px; min-height: 24px; transition: all 0.2s ease-in-out; }
    .nav-item.active svg { filter: drop-shadow(0 0 8px var(--brand-primary)); }
    .sidebar .logout-btn { margin-top: auto; width: 100%; }

    /* Componentes Genéricos */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
    .page-header h2 { font-size: 2.25rem; font-weight: 800; }
    .card { background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 0.85rem 1.1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 4px rgba(0, 245, 160, 0.2); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.8rem 1.6rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s ease-in-out; text-transform: uppercase; letter-spacing: 0.8px; font-size: 0.9rem; }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .btn:active { transform: translateY(-1px); }
    .btn-primary { background: var(--brand-primary); color: #000; box-shadow: 0 4px 15px rgba(0, 245, 160, 0.2); }
    .btn-primary:hover { background: var(--brand-secondary); box-shadow: 0 6px 25px rgba(0, 245, 160, 0.4); }
    .btn-danger { background-color: var(--danger-bg); color: var(--danger-text); border: 1px solid var(--danger-border);}
    .btn-danger:hover { background-color: var(--danger-hover-bg); color: var(--danger-hover-text); }
    .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { color: var(--text-primary); border-color: var(--text-secondary); }
    .btn-sm { padding: 0.6rem 1.2rem; font-size: 0.8rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }

    /* Chat ao Vivo */
    .chat-page-layout { height: calc(100vh - 4rem); padding: 0; }
    .chat-container { display: flex; height: 100%; width: 100%; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
    .conversations-panel { width: 320px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
    .conversations-header { padding: 1rem; border-bottom: 1px solid var(--border-color); }
    .conversations-list { flex: 1; overflow-y: auto; }
    .conversation-item { padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); border-left: 4px solid transparent; }
    .conversation-item:hover { background: var(--bg-tertiary); }
    .conversation-item.active { background: var(--bg-primary); border-left-color: var(--brand-primary); }
    .conversation-item-name { font-weight: 600; color: var(--text-primary); }
    .conversation-item-preview { font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .chat-window { flex: 1; display: flex; flex-direction: column; }
    .chat-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); background: var(--bg-secondary); }
    .chat-header h3 { font-size: 1.1rem; }
    .message-list { flex: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
    .message-bubble { max-width: 70%; padding: 0.75rem 1.25rem; border-radius: 18px; line-height: 1.5; word-wrap: break-word; }
    .message-bubble strong { display: block; margin-bottom: 0.25rem; font-size: 0.8rem; }
    .message-bubble-time { font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem; text-align: right; }
    .message-user { background: var(--bg-tertiary); align-self: flex-start; border-bottom-left-radius: 4px; }
    .message-operator { background: var(--brand-primary); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-input-area { border-top: 1px solid var(--border-color); padding: 1rem; background: var(--bg-secondary); }
    .chat-input-form { display: flex; align-items: center; gap: 1rem; }
    .chat-input { flex: 1; }
    
    .contact-panel { width: 320px; border-left: 1px solid var(--border-color); background: var(--bg-primary); padding: 1.5rem; overflow-y: auto; }
    .contact-panel h3 { margin-bottom: 1.5rem; font-size: 1.2rem; }
    .contact-detail { margin-bottom: 1.25rem; }
    .contact-detail label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.25rem; display: block; }
    .contact-detail p { font-size: 0.95rem; color: var(--text-primary); word-wrap: break-word; }

    .centered-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--text-secondary); }
    .centered-placeholder svg { margin-bottom: 1rem; }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef, memo } = React;
    const { ReactFlowProvider, ReactFlow, useNodesState, useEdgesState, addEdge, Background, Controls, Handle, Position } = window.ReactFlow;
    const API_BASE_URL = 'https://novaapi-one.vercel.app/api';

    const api = axios.create({ baseURL: API_BASE_URL });
    api.interceptors.request.use(config => {
      const token = localStorage.getItem('authToken');
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }
      return config;
    });
    
    const Icons = {
        bots: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8V4H8"/><rect x="4" y="12" width="16" height="8" rx="2"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M17 12v-2a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>,
        flows: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h3"/><path d="M7 12h3"/><path d="M12 12h3"/><path d="M17 12h3"/><path d="M5 7v10"/><path d="M10 7v10"/><path d="M15 7v10"/><path d="M20 7v10"/><path d="M5 12a5 5 0 0 0 5 5"/><path d="M10 12a5 5 0 0 1 5 5"/><path d="M15 12a5 5 0 0 0 5-5"/></svg>,
        chat: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
        disparos: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        logout: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
        send: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        search: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    };

    function App() {
        // ... Lógica do App mantida
    }
    
    function Sidebar({ currentPage, setCurrentPage, onLogout }) {
        // ... Lógica da Sidebar mantida
    }
    
    function BotsPage() {
        // ... Lógica da BotsPage mantida
    }
    
    function FlowsListPage({ onEditFlow }) {
        // ... Lógica da FlowsListPage mantida
    }

    function DisparosPage() {
        return <h2 className="page-header">Disparos (Em Breve)</h2>;
    }
    
    function LiveChatPage() {
        const [bots, setBots] = useState([]);
        const [selectedBotId, setSelectedBotId] = useState('');
        const [users, setUsers] = useState([]);
        const [filteredUsers, setFilteredUsers] = useState([]);
        const [selectedChat, setSelectedChat] = useState(null);
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [searchTerm, setSearchTerm] = useState('');
        const messagesEndRef = useRef(null);

        useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);
        
        useEffect(() => {
            const fetchBots = async () => {
                const { data } = await api.get('/dashboard/data');
                setBots(data.bots || []);
                if (data.bots && data.bots.length > 0) {
                    setSelectedBotId(data.bots[0].id);
                }
            };
            fetchBots();
        }, []);

        const fetchUsers = useCallback(async () => {
            if (!selectedBotId) return;
            setUsers([]); setFilteredUsers([]); setMessages([]); setSelectedChat(null);
            try {
                const { data } = await api.get(`/chats/${selectedBotId}`);
                setUsers(data); setFilteredUsers(data);
            } catch (error) { console.error("Erro ao buscar usuários", error); }
        }, [selectedBotId]);
        
        useEffect(() => { fetchUsers(); }, [fetchUsers]);

        const fetchMessages = useCallback(async () => {
            if (!selectedBotId || !selectedChat?.chat_id) return;
            try {
                const { data } = await api.get(`/chats/${selectedBotId}/${selectedChat.chat_id}`);
                setMessages(data);
            } catch (error) { console.error("Erro ao buscar mensagens", error); setMessages([]); }
        }, [selectedBotId, selectedChat]);

        useEffect(() => { if (selectedChat) { fetchMessages(); } }, [fetchMessages, selectedChat]);

        useEffect(() => {
            const results = users.filter(user =>
                ((user.first_name || '') + ' ' + (user.last_name || '')).toLowerCase().includes(searchTerm.toLowerCase()) ||
                (user.chat_id || '').toString().includes(searchTerm) ||
                (user.click_id || '').toLowerCase().includes(searchTerm.toLowerCase())
            );
            setFilteredUsers(results);
        }, [searchTerm, users]);
        
        const handleSendMessage = async (event) => {
            event.preventDefault();
            const textToSend = newMessage.trim();
            if (!textToSend || !selectedChat) return;

            const optimisticMessage = { message_id: Date.now(), first_name: "Você", sender_type: 'operator', message_text: textToSend, created_at: new Date().toISOString() };
            setMessages(prev => [...prev, optimisticMessage]);
            setNewMessage('');

            try {
                await api.post(`/chats/${selectedBotId}/send-message`, { chatId: selectedChat.chat_id, text: textToSend });
                fetchMessages();
            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
                alert('Ocorreu um erro ao enviar a mensagem.');
                setMessages(prev => prev.filter(m => m.message_id !== optimisticMessage.message_id));
            }
        };

        const handleDeleteConversation = async (chatId) => {
            if (confirm(`Tem certeza que deseja excluir toda a conversa e dados deste contato?`)) {
                try {
                    await api.delete(`/chats/${selectedBotId}/${chatId}`);
                    alert('Contato e conversa excluídos com sucesso!');
                    fetchUsers();
                    if (selectedChat?.chat_id === chatId) { setSelectedChat(null); }
                } catch (error) { alert('Erro ao excluir o contato.'); }
            }
        };
        
        const getDisplayName = (user) => {
            if (!user) return '';
            if (user.click_id) return user.click_id.replace('/start ', '');
            return `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Desconhecido';
        };

        return (
            <div className="chat-page-layout">
                <div className="page-header" style={{ padding: '0 2rem' }}>
                    <h2>Chat ao Vivo</h2>
                    <div className="form-group" style={{ marginBottom: 0, minWidth: '300px' }}>
                        <select id="botSelectChat" className="form-select" value={selectedBotId} onChange={event => setSelectedBotId(event.target.value)}>
                            <option value="">-- Selecione um Bot --</option>
                            {bots.map(bot => <option key={bot.id} value={bot.id}>{bot.bot_name}</option>)}
                        </select>
                    </div>
                </div>
                <div className="chat-container">
                    <div className="conversations-panel">
                        <div className="conversations-header">
                            <input type="text" className="form-input" placeholder="Buscar conversa..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="conversations-list">
                            {filteredUsers.map(user => (
                                <div key={user.chat_id} className={`conversation-item ${selectedChat?.chat_id === user.chat_id ? 'active' : ''}`} onClick={() => setSelectedChat(user)}>
                                    <div className="conversation-item-name">{getDisplayName(user)}</div>
                                    <p className="conversation-item-preview">{user.message_text}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="chat-window">
                        {selectedChat ? (
                            <>
                                <div className="chat-header">
                                    <h3>{getDisplayName(selectedChat)}</h3>
                                    <button className="btn btn-danger btn-sm" onClick={() => handleDeleteConversation(selectedChat.chat_id)}>Excluir</button>
                                </div>
                                <div className="message-list">
                                    {messages.map((msg, index) => (
                                        <div key={msg.message_id || index} className={`message-bubble ${msg.sender_type === 'operator' ? 'message-operator' : 'message-user'}`}>
                                            <strong>{msg.sender_type === 'operator' ? 'Você' : msg.first_name}</strong>
                                            {msg.message_text}
                                            <div className="message-bubble-time">{new Date(msg.created_at).toLocaleTimeString()}</div>
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="chat-input-area">
                                    <form onSubmit={handleSendMessage} className="chat-input-form">
                                        <input className="form-input chat-input" value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder="Digite sua mensagem..." />
                                        <button className="btn btn-primary" type="submit">{Icons.send}</button>
                                    </form>
                                </div>
                            </>
                        ) : (
                            <div className="centered-placeholder">
                                {Icons.chat}
                                <h3>Selecione uma conversa</h3>
                                <p>Escolha um contato na lista à esquerda para começar.</p>
                            </div>
                        )}
                    </div>
                    <div className="contact-panel">
                        {selectedChat ? (
                            <>
                                <h3>Detalhes do Contato</h3>
                                <div className="contact-detail"><label>Nome</label><p>{`${selectedChat.first_name || ''} ${selectedChat.last_name || ''}`.trim() || 'Não informado'}</p></div>
                                <div className="contact-detail"><label>Username</label><p>{selectedChat.username ? `@${selectedChat.username}` : 'Nenhum'}</p></div>
                                <div className="contact-detail"><label>Chat ID</label><p>{selectedChat.chat_id}</p></div>
                                <div className="contact-detail"><label>Click ID</label><p>{selectedChat.click_id ? selectedChat.click_id.replace('/start ', '') : 'Nenhum'}</p></div>
                            </>
                        ) : (
                            <div className="centered-placeholder">
                                <h3>Informações do Contato</h3>
                                <p>Os detalhes do contato selecionado aparecerão aqui.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }
    
    function FlowEditorPage({ flow, onBack }) {
        return <h2 className="page-header">Editor de Fluxo (Em Breve)</h2>
    }
    
    function LoginScreen({ onLogin }) {
        // ... Lógica do Login mantida
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
